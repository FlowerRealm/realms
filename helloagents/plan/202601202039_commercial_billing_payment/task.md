# 任务清单: 商业版计费与支付闭环（Stripe / Epay）

目录: `helloagents/plan/202601202039_commercial_billing_payment/`

---

## 1. 幂等与状态机（订单/回调）
- [ ] 1.1 设计并新增“webhook 幂等表”迁移（Stripe event_id / Epay pay_ref），验证 why.md#核心场景-需求-支付回调幂等与安全-场景-回调重放不重复入账开通
- [ ] 1.2 调整 Stripe webhook 处理链路（`internal/server/*` + `internal/web/*`）：验签→幂等→事务入账/开通，验证 why.md#核心场景-需求-支付回调幂等与安全-场景-回调重放不重复入账开通
- [ ] 1.3 调整 Epay notify 处理链路：签名校验→幂等→事务入账/开通，验证 why.md#核心场景-需求-支付回调幂等与安全-场景-回调重放不重复入账开通

## 2. 余额流水（总账 SSOT）
- [ ] 2.1 新增余额流水表迁移与索引（`internal/store/migrations/*`），验证 why.md#核心场景-需求-余额可对账可追溯-场景-任意余额变化都有来源
- [ ] 2.2 把充值入账、用量扣费、退款/撤销统一写流水（`internal/store/*`），并维持 `user_balances` 聚合快照，验证 why.md#核心场景-需求-余额可对账可追溯-场景-任意余额变化都有来源

## 3. 订阅生命周期
- [ ] 3.1 明确订阅到期与按量计费策略（拒绝/降级/仅余额等），并在 `internal/quota/*` 与 `internal/store/*` 中落实，验证 why.md#核心场景-需求-订阅生命周期可恢复-场景-支付成功后订阅必达失败可补偿
- [ ] 3.2 管理后台补齐订阅订单的可恢复处理（补单/重试/标记需要人工退款），验证 why.md#核心场景-需求-订阅生命周期可恢复-场景-支付成功后订阅必达失败可补偿

## 4. 安全检查
- [ ] 4.1 执行安全检查（按 G9）：回调鉴权、幂等、输入校验、敏感信息日志脱敏、权限边界

## 5. 文档更新
- [ ] 5.1 在 `helloagents/wiki/data.md` 增加流水与幂等表说明
- [ ] 5.2 在 `helloagents/wiki/api.md` 更新回调接口的幂等语义与错误处理

## 6. 测试
- [ ] 6.1 增加回调重放/重复/乱序测试（可用 store 层单测 + server handler 单测组合）
- [ ] 6.2 运行 `go test`（优先覆盖 store/server 相关包）

