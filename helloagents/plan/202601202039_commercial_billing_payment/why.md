# 变更提案: 商业版计费与支付闭环（Stripe / Epay）

## 需求背景

当前 Realms 已具备订阅套餐、订阅订单、充值订单、余额、支付渠道与部分回调入口，但要作为商业化项目稳定运行，还缺少“财务正确性优先”的闭环能力：

- 支付回调必须 **签名校验 + 幂等处理 + 可恢复**，避免重复回调导致重复入账/重复开通。
- 订单/余额/用量之间需要形成可对账的口径（至少要能解释每一笔余额变动从何而来）。
- 不做多租户（组织/团队）简化域模型：以 `user` 为商业最小单位。

## 产品分析

### 目标用户与场景
- **用户群体:** 小型商业化服务（单实例多用户，不提供 tenant）
- **使用场景:** 用户购买订阅套餐或充值余额，用于 API 调用；管理员可配置支付渠道与审核订单
- **核心痛点:** 回调重复/乱序与异常补偿不完善会直接导致资金与权限错误；缺少对账与审计会导致运营不可控

### 价值主张与成功指标
- **价值主张:** Stripe/Epay 支付闭环稳定可审计，余额与订阅开通可恢复可对账
- **成功指标:**
  - Webhook/notify 重放、重复、乱序不会导致重复入账/重复开通
  - 每笔余额/订阅状态变更有可追溯来源（订单/用量/人工调整）
  - 管理后台具备最小财务运营能力（对账导出、审批、审计）

### 人文关怀
财务相关功能应尽量减少误操作、提供清晰提示与可追溯记录，避免把损失转嫁给用户或客服。

## 变更内容
1. 统一订单状态机与幂等语义（充值/订阅两类订单一致的处理方式）
2. 强化支付回调安全：签名校验、幂等键、重放保护、失败补偿
3. 引入“余额变动总账/流水”（或等价结构），使余额可对账、可审计
4. 订阅生命周期补齐：开通/续费/到期/升级降级（不含多租户）
5. 管理后台补齐财务最小权限与审计：订单处理、渠道配置、导出

## 影响范围
- **模块:**
  - `internal/store`（订单/余额/订阅/支付渠道的数据一致性）
  - `internal/server`（回调入口与鉴权/幂等）
  - `internal/web`（用户购买与支付发起）
  - `internal/admin`（订单处理、支付渠道管理、审计/导出）
- **API:**
  - `POST /api/pay/stripe/webhook*`
  - `GET /api/pay/epay/notify*`
  - `POST /api/webhooks/subscription-orders/{order_id}/paid`
- **数据:**
  - 可能新增余额流水/总账相关表
  - 可能新增 webhook 事件幂等表（记录已处理事件）

## 核心场景

### 需求: 支付回调幂等与安全
**模块:** server/store

#### 场景: 回调重放不重复入账/开通
- 同一 Stripe webhook event 重复投递不会重复入账
- Epay notify 重复请求不会重复入账
- 订单已取消但收到回调：不入账，记录 note 并可人工处理

### 需求: 余额可对账可追溯
**模块:** store/admin

#### 场景: 任意余额变化都有来源
- 充值入账、用量扣费、退款/撤销、人工调整均记录为流水
- 管理后台可按用户/时间导出对账数据

### 需求: 订阅生命周期可恢复
**模块:** store/web/admin

#### 场景: 支付成功后订阅必达，失败可补偿
- 回调先到/后到、审批先/后都能得到一致的最终状态
- 到期后策略明确（拒绝/降级/仅允许按量等），且口径一致

## 风险评估
- **风险:** 财务一致性错误（双发/漏发/余额错误）
  - **缓解:** 幂等表 + 事务边界明确 + 流水总账；测试覆盖重放/乱序/失败补偿
- **风险:** 密钥泄露（支付密钥、上游 token）
  - **缓解:** 存储加密、日志脱敏、后台只显示 hint，密钥仅在创建/轮换时可见一次

