# 变更提案: 用户 Token 支持查看/复制（Web 控制台）

## 元信息
```yaml
类型: 新功能
方案类型: implementation
优先级: P1
状态: 草稿
创建: 2026-02-01
```

---

## 1. 需求

### 背景

当前用户侧「API 令牌」页面仅展示 `token_hint`（尾部预览），且令牌明文只在“创建/重新生成”后展示一次（`/tokens/created`）。用户希望：

- 支持对现有 Token **切换显示/隐藏**（查看完整 Token）
- 支持 **复制 Token 本身**（不附带 `Bearer` 等前缀）
- 不是只有“重新生成”才能复制
- 需要多 Key 管理（项目现状已支持多 Token：列表/创建/撤销/删除/轮换）
- 仅 Web 控制台范围
- 不需要二次验证
- 希望将 Token **改为明文存储**

### 目标

- 用户可以在 `/tokens` 列表页对活跃 Token 执行“显示/隐藏”并复制 Token 本身
- 后端提供最小化的“按需 reveal”能力，不在列表接口中批量下发明文

### 约束条件
```yaml
时间约束: 无
性能约束: 无（按需拉取，避免列表页一次性下发全部明文）
兼容性约束: 旧 Token 允许继续使用；但旧 Token 的明文无法回溯，需要轮换后才可 reveal
业务约束:
  - 不需要二次验证
  - 仅 Web 控制台
```

### 验收标准
- [ ] `/tokens` 列表页：每个活跃 Token 支持“显示/隐藏”与“复制 Token”
- [ ] “复制”仅复制 Token 本身，不附带 `Bearer` 前缀
- [ ] 旧 Token（`token_plain` 为空）点击“查看/复制”会得到明确提示：需要重新生成后才能查看
- [ ] 轮换/撤销/删除能力保持可用
- [ ] 新增“查看明文”接口不被浏览器缓存（`Cache-Control: no-store`）

---

## 2. 方案

### 技术方案

- 数据库：为 `user_tokens` 增加可取回的明文字段 `token_plain`（可空）
- 后端：新增 `GET /api/token/:token_id/reveal`，仅在用户点击“显示/复制”时返回明文 Token
- 前端：在 `web/src/pages/TokensPage.tsx` 增加“查看/隐藏/复制”交互，并默认隐藏明文

### 影响范围
```yaml
涉及模块:
  - internal/store: user_tokens 存储与查询
  - router: token API 路由（reveal + 前缀一致性）
  - web: TokensPage + tokens API client
  - docs: token 使用说明与安全提示
预计变更文件: 8-14
```

### 风险评估（⚠️ EHRB：敏感数据）

将用户 Token 明文落库会显著扩大泄露面（数据库备份/导出、只读权限滥用、日志误打、运维人员访问等）。在“不需要二次验证”的前提下，本方案至少落实最小化措施：

| 风险 | 等级 | 应对 |
|------|------|------|
| 明文 Token 落库扩大泄露面 | 高 | 不在列表接口中返回明文；按需 reveal；接口 `no-store`；撤销态默认不允许 reveal（待确认） |
| 页面加载即下发全部明文 Token | 高 | reveal 独立接口，仅在点击查看/复制时请求 |
| 旧 Token 无法回溯明文导致困惑 | 中 | 明确提示“旧令牌需重新生成后才能查看/复制” |

---

## 3. 技术设计（可选）

### API 设计

#### GET /api/token/:token_id/reveal
- **请求**: 无 body
- **响应（成功）**:
  - `success=true`
  - `data.token_id`
  - `data.token`
- **响应（失败）**:
  - `token_id` 不合法 / 不存在 / 非本人 / 非活跃 / `token_plain` 为空（旧令牌） → 返回明确 message
- **响应头**: `Cache-Control: no-store`

### 数据模型

`user_tokens` 增加：

| 字段 | 类型 | 说明 |
|------|------|------|
| token_plain | MySQL: VARCHAR(255) NULL / SQLite: TEXT NULL | Token 明文（新创建/轮换后写入；旧数据为空） |

---

## 4. 核心场景

### 场景: 列表页查看/复制活跃 Token
**模块**: web(`/tokens`) + router(`/api/token/:id/reveal`) + store(`user_tokens.token_plain`)
**条件**: 用户已登录；Token 为活跃；token_plain 已存在
**行为**: 点击“查看”拉取并展示；点击“复制”复制 token
**结果**: 页面默认隐藏；用户可随时复制 token

### 场景: 旧 Token 无法 reveal
**模块**: web + router + store
**条件**: Token 存在但 `token_plain` 为空
**行为**: 点击“查看/复制”
**结果**: 明确提示需要“重新生成/轮换”后才能查看

---

## 5. 技术决策

### 用户 Token 支持查看/复制（Web 控制台）#D001: Token 明文存储方案
**日期**: 2026-02-01
**状态**: ✅采纳
**背景**: 需要支持“查看/复制既有 Token”，仅存 hash 无法满足；用户提出“改为明文存储”
**选项分析**:
| 选项 | 优点 | 缺点 |
|------|------|------|
| A: token_plain 纯明文存储 | 实现简单；符合用户诉求；不依赖密钥管理 | 泄露面显著扩大（高风险） |
| B: token_enc 可逆加密存储 | 降低落库泄露面；仍支持 reveal | 需要密钥管理与加解密实现；历史上游凭据已禁用应用层加密（需评估一致性） |
**决策**: 选择方案 A（token_plain 纯明文存储；用户已确认 EHRB 风险）
**理由**: 需要支持列表页查看/复制既有 Token；纯明文实现成本最低且符合本次交互约束（无需二次验证）
**影响**: store/router/web/docs

### 用户 Token 支持查看/复制（Web 控制台）#D002: 撤销 Token 是否允许 reveal
**日期**: 2026-02-01
**状态**: ✅采纳
**背景**: 撤销后 token 不应再使用；继续暴露明文是否必要
**选项分析**:
| 选项 | 优点 | 缺点 |
|------|------|------|
| A: 不允许 reveal（默认建议） | 降低无意义暴露；更安全 | 用户无法复制“历史 token”（但也不应再用） |
| B: 允许 reveal | 满足“随时可看”的直觉 | 暴露面更大，且对业务价值有限 |
**决策**: 选择方案 A（撤销后不允许 reveal/复制）
**理由**: 撤销态 token 不应继续被暴露；同时与“撤销后不可用”的直觉一致
**影响**: router/web

### 用户 Token 支持查看/复制（Web 控制台）#D003: 用户 Token 前缀统一为 sk_
**日期**: 2026-02-01
**状态**: ✅采纳
**背景**: 前端/文档曾使用 `rlm_...`，但用户 token 创建路径为 `sk` 前缀；为避免形态漂移，需要统一
**选项分析**:
| 选项 | 优点 | 缺点 |
|------|------|------|
| A: 统一为 sk_ | 与现有生成逻辑接近；对外更直观 | 与上游 key（常见 `sk-***`）外观相近，可能造成混淆 |
| B: 统一为 rlm_ | 与项目品牌更匹配；与上游 key 外观差异更大 | 需要改动既有生成逻辑与文档示例 |
**决策**: 选择方案 A（统一为 sk_）
**理由**: 你已明确指定前缀为 `sk_`；同时统一 OAuth 与用户侧 Token 形态
**影响**: router/web/docs/tests
