# 变更提案: channel_failover_fix

## 元信息
```yaml
类型: 修复
方案类型: implementation
优先级: P1
状态: ✅完成
创建: 2026-01-28
```

---

## 1. 需求

### 背景
当前“渠道自动选择/故障切换”在某些场景下表现不符合预期：当渠道 B 不可用，但渠道 A 可用时，系统未能及时切换到 A，导致请求在同一渠道上重复尝试或耗尽组内 `max_attempts`，最终返回“上游不可用”。

同时，希望渠道封禁到期后能自动触发测试（即使无流量），若测试可用则自动恢复使用；封禁时间上限不超过 10 分钟。

### 目标
- 当一次请求触发 failover（可重试失败）时，允许对同一渠道做有限次数重试；超过次数后优先切换到“下一个”渠道（若可用）。
- 保留原有兜底：若其他渠道不可选，仍允许回退继续尝试上一次的渠道。
- 不改变既有封禁上限（≤10m）与封禁到期后的自动探测机制。

### 约束条件
```yaml
封禁上限: 不超过 10 分钟（已有实现，保持不变）
自动探测: 无流量也要探测（已有 channelAutoProbeLoop，保持不变）
兼容性: 仅调整路由选择顺序，不引入新的持久化状态
```

### 验收标准
- [ ] 当 B 返回可重试失败且 A 可用时，下一次调度优先返回 A
- [ ] 单元测试覆盖该 failover 行为
- [ ] `go test ./...` 通过

---

## 2. 方案

### 技术方案
在 `internal/scheduler/group_router.go` 的 `GroupRouter` 内记录本次请求上一次返回的 `lastSelectedChannelID` 与连续命中次数（streak），并在下一次 `Next()` 计算候选顺序时：

- 若候选渠道数量 > 1 且连续命中达到阈值（当前为 2，即“允许 1 次重试”），则将“上一次选择的渠道”延后到列表末尾；
- 其他渠道保持原有排序规则（forced/probe/promotion/priority/failScore）。

这样在 failover 场景下可先给当前渠道一次重试机会（便于同渠道多 key/账号接管或短暂抖动恢复），再切换到其它渠道，同时仍保留原渠道作为兜底。

### 影响范围
```yaml
涉及模块:
  - internal/scheduler: GroupRouter 候选排序
  - internal/scheduler: 新增单元测试
预计变更文件: 2
```

### 风险评估
| 风险 | 等级 | 应对 |
|------|------|------|
| 可能降低“同渠道多凭据”快速自愈概率 | 低 | 仅避免“连续重复”；其他渠道不可用时仍会回退尝试原渠道 |
| 行为变更影响线上流量分配 | 低 | 仅在 failover（可重试失败）后生效，且不改变封禁与探测策略 |
