# 变更提案: 支付页支持关闭订单（订阅/充值）

## 需求背景

当前 Web 控制台的支付页（`/pay/{kind}/{order_id}`）允许用户对“待支付”的订阅订单（subscription）与充值订单（topup）选择支付渠道并跳转到 Stripe/EPay 完成支付，但缺少“用户主动关闭订单”的能力。

本次变更目标：
- 用户可以在支付页对 **待支付** 的订单执行“关闭订单”，订单状态标记为 **已取消**；
- 若订单已关闭但用户仍完成了支付（支付回调到达），服务端 **不自动入账/生效**，仅记录支付元信息，后续由人工退款处理。

## 变更内容
1. Web 控制台新增订单关闭入口：`POST /pay/{kind}/{order_id}/cancel`（仅待支付）。
2. Store 新增“按用户关闭订单”的事务方法（订阅订单/充值订单）。
3. 支付回调在遇到“订单已取消”时，停止自动入账/生效，并尽量记录支付元信息，便于人工退款。

## 影响范围
- **模块:**
  - `internal/web`（支付页 UI + 关闭订单路由）
  - `internal/store`（订单状态更新）
  - `internal/server`（Stripe webhook / 订阅订单 webhook 的取消订单处理）
- **API/路由:**
  - 新增：`POST /pay/{kind}/{order_id}/cancel`
- **数据:**
  - 无新增表；更新既有订单状态字段与（可能的）支付元信息字段。

## 核心场景

### 场景: 用户关闭待支付的订阅订单
- 用户在 `/pay/subscription/{order_id}` 点击“关闭订单”
- 订单状态从“待支付”变为“已取消”
- 该订单不再可发起支付

### 场景: 用户关闭待支付的充值订单
- 用户在 `/pay/topup/{order_id}` 点击“关闭订单”
- 订单状态从“待支付”变为“已取消”
- 该订单不再可发起支付

### 场景: 订单已取消但仍收到支付回调
- 支付回调到达时检测到订单已取消
- 服务端不自动入账/生效
- 尽量记录 `paid_at/paid_method/paid_ref/paid_channel_id` 等元信息（便于人工退款）

## 风险评估
- **风险:** 支付相关（EHRB），取消与回调竞态可能导致“误入账/误生效/重复回调重试”
- **缓解:**
  - 关闭订单仅允许“待支付”状态，且使用事务 + `SELECT ... FOR UPDATE` 串行化状态更新
  - 关闭入口走 Cookie 会话 + CSRF
  - 支付回调对“订单已取消”按幂等处理：记录元信息但不入账/不生效，并返回成功避免重复重试

