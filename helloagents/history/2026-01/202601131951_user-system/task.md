# 任务清单: user-system（用户体系）

目录: `helloagents/plan/202601131951_user-system/`

---

## 0. 决策确认（阻塞项）
- [√] 0.1 需要 Web 控制台（Web UI）
- [√] 0.2 不需要 2FA/OAuth
- [√] 0.3 一个用户可拥有多个 Token（数据面鉴权）
- [√] 0.4 需要分组隔离（默认不跨组 fallback）
- [√] 0.5 配额来自“套餐/订阅”（套餐逻辑仍在实现中，本方案预留对接点）
- [√] 0.6 邮箱验证后置落地：C（开发期先允许注册无邮箱验证；邮件能力实现后再强制邮箱验证）
- [√] 0.7 Web UI 技术形态：服务端渲染（SSR）
- [√] 0.8 不需要 Token 级访问约束（不做模型白名单/IP 白名单/Token 级配额）

## 1. 数据模型与迁移（MySQL）
- [ ] 1.1 明确核心表：`users`、`groups`、`user_tokens`、`user_sessions`、`email_verifications`、`audit_events`
- [ ] 1.2 预留套餐/订阅对接字段（如 `users.plan_id` 或 `user_subscriptions`），明确“配额口径”与更新时间点
- [ ] 1.3 设计 migrations 组织方式（纯 SQL 或迁移工具），并与 `codex` 主方案统一命名与索引策略

## 2. Web 账号体系（注册/登录/会话）
- [ ] 2.1 实现注册：邮箱+密码（开发期开放）；按 0.6=C 开发期不强制邮箱验证码
- [ ] 2.2 预置邮箱验证码能力：数据表/接口/过期/限速；邮件实现后切换为“注册强制邮箱验证”
- [ ] 2.3 实现登录/登出：密码校验、会话 Cookie、会话过期与主动注销
- [ ] 2.4 实现基础角色：普通用户/管理员（不做 2FA/OAuth）

## 3. Token 体系（数据面鉴权）
- [ ] 3.1 实现 Token 创建/撤销/列表：一个用户多个 Token；明文仅创建时返回一次；库内仅存 hash
- [ ] 3.2 支持 `Authorization: Bearer <token>` 与 `x-api-key: <token>`
- [ ] 3.3 鉴权失败返回统一错误体（不泄漏细节），并补齐日志字段（request_id/user_id/token_id/group_id）
- [ ] 3.4 （可选）Token 过期：`expired_at` 与过期后拒绝
- [-] 3.5 Token 模型白名单（本期不做）
- [-] 3.6 Token IP 白名单（本期不做）

## 4. 分组隔离（租户隔离）
- [ ] 4.1 定义分组模型：用户绑定 `group_id`；Token 继承分组；默认不允许跨组访问/重试
- [ ] 4.2 在路由/调度入口透传 `group_id`，仅选择组内允许的上游资源（渠道/凭据/模型）
- [ ] 4.3 管理后台支持管理分组与用户分组归属，变更需审计

## 5. 配额与套餐对接（实现中）
- [ ] 5.1 定义 `QuotaProvider` 对接接口与数据结构：按“成本（`usd_micros`）+ rolling window”从订阅汇总用户可用配额（并行叠加；订阅为相对月；`user_id` 由数据面鉴权从数据库获取）
- [ ] 5.2 成本计算：复用 tokens 统计 + 管理员可维护的 model 定价表；单位统一为 `usd_micros`（整数，避免 float）；未配置定价的 model 默认拒绝（避免绕过配额）
- [ ] 5.3 数据面请求前置校验：rolling 5h / 7d / 30d（相对时间）任一窗口超额即直接拒绝（提示“余额不足”，无需返回额外字段）；请求完成后落账/统计（允许最后一笔轻微穿透，后续可做预扣）
- [ ] 5.4 管理后台能力：按月为用户开通/撤销订阅，维护定价表，并查询订阅与三窗口用量/剩余额度
- [ ] 5.5 Web 控制台展示：当前订阅、三窗口剩余额度、基础用量概览（不做支付/充值闭环）

## 6. Web UI（控制台页面）
- [ ] 6.1 页面：登录/注册/登出
- [ ] 6.2 页面：Token 列表/创建/撤销（明文 Token 仅创建时展示）
- [ ] 6.3 页面：配额/用量概览
- [ ] 6.4 页面：管理员后台（用户、分组、审计）

## 7. 审计与脱敏
- [ ] 7.1 定义最小 `event_type` 集合：注册/登录失败、创建/撤销 Token、用户禁用、分组变更等
- [ ] 7.2 记录关键操作审计事件（actor/target/request_id/result），不记录请求正文与明文凭据
- [ ] 7.3 增加脱敏规则校验：headers/token/password/cookie/body 不得出现在日志与审计中

## 8. 安全检查
- [ ] 8.1 执行安全检查（按G9：输入验证、敏感信息处理、权限控制、CSRF、会话安全、分组隔离、EHRB 风险规避）

## 9. 测试（实现阶段）
- [ ] 9.1 Web 流程测试：注册（含邮箱验证码）、登录、登出、会话过期
- [ ] 9.2 Token 测试：创建/撤销/过期、Bearer/x-api-key、禁用用户
- [ ] 9.3 隔离测试：跨组访问必须拒绝（模型/渠道/凭据/日志可见性）
- [ ] 9.4 脱敏测试：确保 Token/密码/Cookie 不出现在日志与审计输出

## 10. 合并点（与 `codex` 主方案合并）
- [ ] 10.1 将本方案的任务拆分合并进 `helloagents/history/2026-01/202601131914_codex/task.md` 的用户/鉴权/存储/管理章节
- [ ] 10.2 将本方案的 ADR/API/数据模型合并进 `helloagents/history/2026-01/202601131914_codex/how.md`
- [ ] 10.3 同步更新知识库：`helloagents/wiki/api.md`、`helloagents/wiki/data.md`、`helloagents/wiki/modules/codex.md`
