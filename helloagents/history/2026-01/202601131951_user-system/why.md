# 变更提案: user-system（用户体系）

## 需求背景

当前 `helloagents/history/2026-01/202601131914_codex/` 已确认“多用户（每用户 API key）”作为下游鉴权基础，但用户体系的范围/边界/最小可落地形态尚未独立收敛。本提案将“用户功能”拆分成独立方案包，便于先协商确认，再合并回 `codex` 主方案包。

关键约束与偏好（来自现有方案与本次需求）：
1. 先产出独立方案包，不直接改动现有 `202601131914_codex`。
2. 需要 Web 控制台（Web UI），但不做 2FA/OAuth。
3. 任何 key/token 不落盘明文，日志默认脱敏。
4. 支持开发期开放注册；开发期允许注册不强制邮箱验证；邮件能力实现后切换为“注册强制邮箱验证”。
5. 分组隔离是强需求：用户/Token/可用上游资源（渠道/凭据/模型）需按组隔离，默认不跨组 fallback。
6. 配额来自“套餐/订阅”，套餐逻辑仍在实现中，本方案需预留对接点与最小可用口径。

## 产品分析

### 目标用户与场景
- **用户群体:** 管理员（平台维护者）、普通用户（开发者/内部服务接入方）
- **使用场景:** 注册/登录 Web 控制台；自助创建/撤销 API Token；查看配额与用量；管理员按分组管理用户与资源
- **核心痛点:** 多租户隔离、Token 生命周期治理、配额约束与可追溯审计、避免凭据泄漏

### 价值主张与成功指标
- **价值主张:** 在不改变调用方式的前提下，实现可治理的多租户访问控制
- **成功指标:**
  - 兼容性：数据面支持 `Authorization: Bearer <token>`（可选 `x-api-key`）
  - 可用性：Web 控制台可注册/登录；用户可创建多个 Token 并随时撤销；管理员可管理用户/分组/套餐（对接）
  - 隔离性：分组维度隔离用户、Token、可用模型与上游资源；默认不跨组 fallback
  - 安全性：Token 只存 hash；登录密码安全哈希；日志/审计不含请求正文与明文凭据
  - 可追溯：关键管理动作与鉴权失败产生审计事件（包含 request_id、actor、target、结果）

### 人文关怀
尽量减少对调用方“身份”与“输入内容”的采集与持久化；审计仅记录索引字段，排障采样需要显式开关与有效期。

## 变更内容
1. 定义用户账号体系（注册/登录/会话）与 Token 生命周期（创建、撤销、过期/禁用可选）。
2. 定义 Web 控制台信息架构：登录/注册、Token 管理、配额/用量视图、管理后台（用户/分组/套餐对接）。
3. 定义分组隔离模型：用户归属组、Token 归属组、上游资源与模型可用性按组约束。
4. 定义配额口径与套餐对接点：套餐产生配额，数据面请求消耗配额（套餐模块未完成时先预留接口）。
5. 定义最小审计事件模型，覆盖关键管理操作与鉴权失败。
6. 明确与 `codex` 主方案的合并点（任务拆分与依赖关系）。

## 影响范围
- **模块:** codex（web/ui/auth/token/group/quota/audit/store）
- **API:**
  - 数据面：统一鉴权（Bearer/x-api-key）
  - 控制面：用户/Token/分组管理、（可选）套餐对接 API（以实现阶段为准）
  - Web：控制台页面路由（登录/注册/控制台）
- **数据:** `users`、`user_tokens`、`groups`、`user_sessions`、`email_verifications`、`audit_events`、（对接）`plans/subscriptions`、`usage_records`
- **文件:**
  - 新增本方案包：`helloagents/plan/202601131951_user-system/*`
  - 合并后将改动 `helloagents/history/2026-01/202601131914_codex/*`（本包不直接修改）

## 核心场景

### 需求: 用户注册与登录（Web 控制台）
**模块:** codex
支持开发期开放注册；开发期允许注册不强制邮箱验证（邮件能力实现后强制）；并提供登录/登出与会话管理。

#### 场景: 注册（开发期不强制邮箱验证）
- 用户提交邮箱/密码
- 开发期直接创建用户并绑定默认分组（不强制验证码）
- 邮件能力实现后：注册必须通过邮箱验证码

#### 场景: 登录与会话
- 用户使用邮箱/用户名 + 密码登录
- 建立 Web 会话（Cookie）并进入控制台

### 需求: API Token 鉴权（数据面）
**模块:** codex
支持通过用户 Token 调用 OpenAI 风格接口，并在不泄漏策略细节的前提下返回可诊断的鉴权错误。

#### 场景: 带 Token 调用 OpenAI 兼容接口
- 请求携带 Bearer Token（或 `x-api-key`）
- 服务识别 `user_id/token_id/group` 并用于路由与审计字段（不记录明文 Token）
- 鉴权失败返回统一错误体

#### 场景: 一个用户拥有多个 Token
- 用户可在控制台创建多个 Token（用于不同服务/环境）
- 可随时撤销单个 Token，撤销后立即失效

#### 场景: Token 级访问约束（可选）
- Token 仅允许访问指定模型集合（模型白名单）
- Token 仅允许特定来源 IP（IP 白名单）

### 需求: 分组隔离（租户隔离）
**模块:** codex
按分组隔离用户、Token、可用模型与上游资源；默认不跨组 fallback。

#### 场景: 组内可用资源隔离
- 同一组内的用户/Token 只能使用该组允许的上游渠道/凭据/模型集合
- 组外资源不可见不可用

### 需求: 配额来自套餐（对接）
**模块:** codex
配额来自套餐/订阅；套餐模块仍在实现中，本方案定义最小对接点与口径。

**已确认口径:**
- 计量: 成本（`usd_micros`）
- 定价表: 管理员维护/控制
- 时间窗: rolling 5h / rolling 7d / rolling 30d（相对时间）
- 订阅周期: 相对月（按购买时间 + 1 month）
- 绑定: 用户账号（`user_id` 先占位，来源于数据库）
- 叠加: 并行（多套餐额度汇总）
- 超额: 直接拒绝（提示“余额不足”，无需返回额外字段）

#### 场景: 配额不足时拒绝请求
- 数据面在处理请求前检查剩余配额
- 配额不足时返回统一错误体（不泄漏内部计费实现细节）

### 需求: 管理后台（控制面）
**模块:** codex
提供管理能力，允许管理员管理用户/分组/（对接）套餐配置，并可追溯。

#### 场景: 管理员创建/禁用用户
- 创建返回 `user_id`
- 禁用用户后其所有 Token 失效（或拒绝鉴权）

### 需求: 审计（最小可用）
**模块:** codex
为管理操作与关键安全事件提供最小审计能力，便于排障与合规审查。

#### 场景: 记录管理操作
- 不记录请求正文与明文凭据
- 可按 `request_id` 关联排查

## 风险评估
- **风险:** 控制台/控制面暴露扩大攻击面  
  **缓解:** 强认证、CSRF 防护、默认关闭管理入口或内网监听、严格审计
- **风险:** Token 或密码泄漏导致越权访问  
  **缓解:** Token 仅存 hash、密码安全哈希、日志脱敏、撤销与轮换机制
- **风险:** 邮箱验证后置导致注册链路“临时方案”被误用于生产  
-  **缓解:** 生产默认禁用“无验证码注册”；邮件能力未就绪时禁止开放注册
- **风险:** 分组隔离配置错误导致越权使用上游资源  
  **缓解:** 默认拒绝跨组；管理后台对组与资源绑定做校验与审计
