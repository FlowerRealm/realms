# 变更提案: Codex OAuth 会话粘性绑定与 RPM 负载均衡

> 说明：本方案包已合并到 `helloagents/history/2026-01/202601131914_codex/`，此处仅保留归档副本（未执行）。

## 需求背景

项目已规划/实现多渠道（Channel）调用与 failover 机制，但 Codex OAuth 登录产生的多个账号目前缺少：
1. **作为“特殊渠道”纳入全渠道列表**的统一调度能力（可参与优先级访问）。
2. **会话粘性绑定（session affinity）**：同一会话尽量命中同一渠道/账号，以提升上游缓存命中与稳定性。
3. **负载均衡**：新会话应绑定到“负载更低且可用”的渠道/账号，避免热点。
4. **重试→重绑**：会话已绑定渠道失败时，先在原渠道上重试；仍失败再重绑到其他可用渠道。

## 产品分析

### 目标用户与场景
- **用户群体:** 使用 Codex CLI/SDK 的开发者与平台工程团队
- **使用场景:** 多账号并行承载；需要提升 Prompt Cache/会话缓存命中；上游偶发错误需要自动恢复
- **核心痛点:** 会话在账号之间抖动导致缓存命中差；单账号过热；失败后反复撞同一账号

### 价值主张与成功指标
- **价值主张:** 在不改变客户端调用方式的前提下，实现“粘性 + 均衡 + 自动恢复”
- **成功指标:**
  - 会话键（routeKey）存在时，同一会话 30 分钟内默认保持同一渠道/账号
  - 绑定渠道失败时：同渠道先重试 3 次；仍失败再重绑并继续尝试
  - 新会话按 **RPM（requests per minute）** 选择负载更低且可用的渠道/账号

## 变更内容
1. 定义统一的会话键（routeKey）提取规则：`prompt_cache_key` > `Conversation_id` > `Session_id` > `Idempotency-Key`。
2. 为 Codex OAuth 账号池提供会话粘性绑定（TTL=30min，临时存储，不要求跨重启）。
3. 引入 RPM 负载口径，用于新会话绑定与重绑后的再选择。
4. 实现“重试→重绑”策略：绑定渠道失败先重试 3 次（所有错误都重试）；仍失败才重绑到其他可用渠道。

## 影响范围
- **模块:** router / scheduler（会话粘性、负载均衡、重试与重绑）
- **文件:** 预计新增/修改路由与调度相关代码；补充测试与文档
- **数据:** 仅内存态绑定表（routeKey→channel/account），TTL=30min；不要求跨重启持久化

## 核心场景

### 需求: routeKey 提取与会话绑定
**模块:** router
基于请求体/请求头提取 routeKey，并用其驱动会话粘性绑定。

#### 场景: 新会话首次绑定
- routeKey 存在且无绑定记录
- 从可用的 Codex OAuth 渠道/账号中选择 **RPM 最低**者
- 写入绑定（TTL=30min）

#### 场景: 已绑定会话命中
- routeKey 存在且命中绑定
- 优先使用已绑定渠道/账号（提升缓存命中）
- 成功后续期 TTL（保持活跃会话稳定）

#### 场景: 绑定过期
- routeKey 存在但绑定已过期
- 视为新会话，重新按 RPM 选择并建立绑定

### 需求: 重试→重绑（先重试 3 次，所有错误都重试）
**模块:** router / retry

#### 场景: 绑定渠道失败→重试→重绑
- 对已绑定渠道/账号：**先重试 3 次**（同一渠道/账号；所有错误都重试）
- 若仍失败：从其他可用渠道/账号中按 **RPM 最低**选择并重绑（更新 TTL）
- 本次请求对“重绑后的渠道切换次数”设上限（≤候选可用渠道数），避免死循环

#### 场景: SSE/流式边界
- 仅允许在**未向下游写回任何响应（header/body/首字节）之前**执行重试/重绑
- 一旦开始写回，禁止 failover（避免重复输出/语义不一致）

### 需求: RPM 负载均衡
**模块:** scheduler

#### 场景: 新会话均衡
- 对候选渠道/账号计算 rolling RPM（窗口建议 60s）
- 选择 RPM 最低且可用者；同值时采用稳定的 tie-break（例如按账号 id/配置顺序）

## 风险评估
- **风险:** 重试放大故障与成本  
  **缓解:** 重试次数固定上限（3）；流式写回后禁止重试；按请求设置总尝试上限。
- **风险:** 粘性导致单账号热点  
  **缓解:** 新会话按 RPM 均衡；绑定 TTL=30min 自动回收；失败时允许重绑。
- **风险:** routeKey/会话标识泄漏到日志  
  **缓解:** 内部仅存 routeKey 的 hash（或严格脱敏）；日志默认不打印原值。
