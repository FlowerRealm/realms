# 变更提案: 支付与按量计费（充值/订阅）

## 需求背景

当前 Realms 已具备订阅体系（`subscription_plans` / `user_subscriptions`）与订阅订单（`subscription_orders`），但缺少真实的“在线支付 → 自动生效”闭环；同时也缺少“充值余额 → 按量计费”能力，导致无法支持非订阅用户按使用量付费。

本次变更目标是参考 new-api 的思路，把支付能力接入到 Realms：同时支持 **EPay（支付宝/微信）** 与 **Stripe**，并将支付配置收敛到管理后台设置（可被 UI 覆盖，且支持从 `config.yaml` 读取默认值）。

## 产品分析

### 目标用户与场景
- **用户群体:** Realms Web 控制台的普通用户、管理员（root）
- **使用场景:**
  - 用户充值余额后，按量计费调用 `/v1/responses` 与 `/v1/chat/completions`
  - 用户购买订阅套餐并完成支付后自动获得订阅额度
  - 管理员在后台配置支付渠道参数（EPay/Stripe 分开配置）
- **核心痛点:** 订阅购买与支付脱节；没有余额与按量计费能力；支付参数配置缺少统一入口

### 价值主张与成功指标
- **价值主张:** 提供清晰、可审计的付费闭环（下单→支付→回调→自动生效），并让用户可通过充值余额按量计费使用服务
- **成功指标:**
  - 用户能在 Web 页面发起订阅支付并自动生效
  - 用户能充值余额并在无订阅时按量计费调用 API
  - 支付回调具备签名校验、金额校验与幂等处理
  - 支付配置可在后台设置覆盖，并可回退到 `config.yaml` 默认

### 人文关怀
支付属于高风险功能（可能造成未收款即开通/未充值即入账）。本次设计默认采取“最小必要能力”，并把敏感操作（设置支付参数、手工处理订单）限制在 `root` 权限下，同时尽量避免在页面与日志中回显敏感信息。

## 变更内容
1. 新增“按量计费余额”数据模型与余额充值订单（topup）能力。
2. 引入支付渠道：EPay（支付宝/微信）与 Stripe。
3. 新增支付页面：用户在支付页点击支付后跳转到支付渠道页面。
4. 支付成功后自动生效：
   - 订阅订单：创建/激活 `user_subscriptions`
   - 充值订单：增加用户余额并允许按量计费
5. 管理后台新增支付相关设置项（DB 覆盖优先，`config.yaml` 为默认）。

## 影响范围
- **模块:**
  - `internal/store`（新增余额与充值订单；订阅订单支付生效）
  - `internal/quota`（按量计费扣费/预留/回滚）
  - `internal/web`（充值页/支付页/订单展示）
  - `internal/admin`（支付设置项）
  - `internal/server`（新增 webhook 路由；用量清理时的余额返还）
  - `internal/config`（新增支付/计费配置结构）
- **API/路由（SSR + Webhook）:**
  - 新增：充值页与支付页路由
  - 新增：Stripe webhook、EPay notify 回调
  - 调整：订阅购买从“仅下单提示”升级为“下单后进入支付页”
- **数据:**
  - 新增 `user_balances`
  - 新增 `topup_orders`
  - 订阅订单状态从“删除式处理”调整为“保留并更新状态”（便于追溯）

## 核心场景

### 需求: 充值并按量计费
**模块:** Web 控制台 / Store / Quota

#### 场景: 用户充值余额并完成支付
- 用户在 `/topup` 创建充值订单并进入支付页
- 选择 EPay 或 Stripe 发起支付并跳转到支付渠道页面
- 支付回调验签成功后，订单状态更新为“已支付”，并增加 `user_balances.usd_micros`

#### 场景: 无订阅但余额充足时调用 API
- 用户调用 `/v1/responses` 或 `/v1/chat/completions`
- 服务在 `quota.Reserve` 阶段预留成本并扣减可用余额（并发安全）
- 请求结束后在 `quota.Commit` 阶段按实际成本结算，多退少补

### 需求: 购买订阅并支付自动生效
**模块:** Web 控制台 / Store

#### 场景: 用户购买订阅
- 用户在 `/subscription` 下单后进入支付页
- 支付成功回调后自动创建/激活 `user_subscriptions`，订单标记为“已生效”

### 需求: 管理员配置支付参数
**模块:** 管理后台 / app_settings

#### 场景: 管理员设置支付参数并立即生效
- 管理员在 `/admin/settings` 填写 EPay 与 Stripe 配置
- 配置写入 `app_settings`（界面覆盖优先于 `config.yaml` 默认）
- 新订单/回调使用最新有效配置

## 风险评估
- **风险:** 支付相关（EHRB），存在伪造回调、金额篡改、幂等失败、并发透支等风险
- **缓解:**
  - Stripe 使用 webhook secret 验签；EPay 使用 Key 验签
  - 回调中校验订单金额/币种与本地订单快照一致
  - 订单与余额相关操作使用事务 + `SELECT ... FOR UPDATE` 实现幂等与并发安全
  - 支付配置仅 `root` 可改；敏感字段不回显、不写日志

