# 变更提案: 订阅订单（下单/支付/生效）

## 需求背景

当前订阅购买在用户侧点击“购买”后会直接创建 `user_subscriptions` 并立即生效，缺少“订单”概念，无法表达“待支付 → 已支付 → 已生效”的闭环，也无法支持管理员在必要时手动批准订单生效。

## 产品分析

### 目标用户与场景
- **用户群体:** 使用 Realms Web 控制台购买订阅的普通用户
- **使用场景:** 用户选择订阅套餐后完成支付，获得 API 访问额度
- **核心痛点:** 购买与生效强绑定，缺少支付确认与审核链路

### 价值主张与成功指标
- **价值主张:** 用订单状态明确购买流程，并提供可审计的生效路径
- **成功指标:**
  - 用户购买行为会先创建订单（可查询/可追踪）
  - 支付后订单自动生效（创建订阅记录）
  - 管理员可手动批准订单生效（兜底）

### 人文关怀
订阅属于付费相关高风险功能，默认仅提供最小必需能力，管理操作仅限 `root` 并保留时间与责任人字段以便追溯，减少误操作风险。

## 变更内容
1. 购买订阅改为先创建 `subscription_orders` 订单，状态为“待支付”。
2. 支付确认后自动生效：写入订单支付信息并创建对应的 `user_subscriptions`。
3. 管理员可手动批准订单生效（无需等待外部支付回调，作为兜底）。
4. Web 订阅页展示订单列表；管理后台新增订单列表与操作入口。

## 影响范围
- **模块:** `internal/store`、`internal/web`、`internal/admin`、`internal/server`
- **文件:** 以实现变更清单为准（含迁移、后端、模板、知识库）
- **API:**
  - `POST /subscription/purchase` 语义调整：从“直接生效”变为“创建订单”
  - 新增管理后台订单入口：`GET /admin/orders` 及其操作
- **数据:** 新增 `subscription_orders` 表（订单与订阅关联）

## 核心场景

### 需求: 用户下单创建订单
**模块:** Web 控制台 / 订阅

#### 场景: 在订阅页选择套餐并下单
用户在 `/subscription` 选择某个套餐提交表单
- 创建一条订单记录（待支付）
- 页面提示“订单已创建”
- 订单可在“我的订单”列表中看到

### 需求: 支付后自动生效
**模块:** Store / 订单生效

#### 场景: 订单被标记为已支付
系统写入支付时间与可选的支付信息
- 自动创建 `user_subscriptions` 订阅记录
- 订单状态变为“已生效”

### 需求: 管理员手动批准订单生效
**模块:** 管理后台 / 订单

#### 场景: 管理员在订单列表中手动批准
管理员在 `/admin/orders` 对订单执行“批准生效”
- 自动创建 `user_subscriptions` 订阅记录（如尚未创建）
- 写入批准时间与批准人（`approved_by`）
- 订单状态变为“已生效”

## 风险评估
- **风险:** 支付相关功能（EHRB），误操作会导致未收款开通订阅。
- **缓解:**
  - 管理操作仅限 `root` 且受 CSRF 保护
  - 订单激活在事务内执行并具备幂等性（避免重复创建订阅）
  - 记录 `paid_at/approved_at/approved_by` 便于审计追溯

