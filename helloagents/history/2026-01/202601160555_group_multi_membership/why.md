# 变更提案: Group（用户多组）与组内渠道约束

## 需求背景

当前实现使用“渠道分组”来做上游调度约束：

- 用户侧：`users.channel_group`（单选）
- 渠道侧：`upstream_channels.groups`（可多选，CSV）
- 数据面调度：`/v1/*` 会按用户的 `channel_group` 过滤可用渠道

该模型无法满足“组可以包含用户、用户可加入多个组、且用户只能使用其组内渠道（并集）”的需求；同时订阅套餐也需要按组进行绑定与展示/购买约束，避免用户购买到不可用组的套餐。

## 变更内容

1. **引入用户-组多对多关系**
   - 新增 `user_groups` 关联表（`user_id` + `group_name`）
   - 强制每个用户至少属于 `default` 组
2. **将单一 `channel_group` 语义升级为通用 `group`**
   - 用户侧不再使用 `users.channel_group` 单字段，而是基于 `user_groups` 计算用户允许的组集合（并集）
3. **订阅套餐从 `channel_group` 迁移为 `group`**
   - 套餐绑定单个组（默认 `default`）
   - Web 订阅页仅展示用户所属组内的套餐；购买时服务端二次校验
4. **调度约束升级为“允许组集合”**
   - 数据面调度仅允许选择与用户组集合有交集的上游渠道
   - 若配额/订阅在本次请求选择了套餐组，则进一步收敛到该组（仍需属于用户组集合）
5. **管理台交互调整**
   - 用户资料页：组多选（checkbox），并强制包含 `default`
   - 组字典页与渠道组多选逻辑保持（用于统一管理组名与启用状态）

## 影响范围

- **模块:** store / middleware / auth / scheduler / api(openai) / web / admin
- **数据:**
  - 新增 `user_groups`
  - `users.channel_group` 将被迁移并移除
  - `subscription_plans.channel_group` 将迁移为 `group_name`
- **UI:**
  - `/admin/users` 的“渠道分组（单选）”升级为“组（多选）”
  - `/subscription` 购买列表按用户组过滤

## 核心场景

### 需求: 用户可加入多个组（并集生效）
**模块:** admin / store

#### 场景: root 配置用户所属组（强制包含 default）
前置条件：管理员以 `root` 登录管理后台。
- 在用户编辑弹窗中勾选多个组保存。
- 服务端校验：组名合法、组存在且启用、并强制包含 `default`。

### 需求: 用户只能使用其组内渠道
**模块:** middleware / scheduler / api(openai)

#### 场景: 用户调用 `/v1/*` 请求仅从组内渠道调度
前置条件：用户已持有数据面 Token，且用户属于若干组。
- 调度器仅在渠道的 `upstream_channels.groups` 与用户组集合存在交集时才可选中。
- 若本次请求的订阅配额选择了某个套餐组，则调度进一步限制到该套餐组。

### 需求: 订阅购买列表只展示可用组的套餐
**模块:** web / store

#### 场景: 订阅页仅展示用户组内套餐并禁止越权购买
前置条件：用户已登录 Web 控制台。
- `/subscription` 页面展示的套餐列表只包含 `plan.group_name ∈ user_groups` 的套餐。
- 用户提交购买请求时，服务端再次校验该套餐组属于用户组集合；否则拒绝购买。

## 风险评估

- **风险:** schema 变更涉及鉴权与调度链路，遗漏会导致调度放开或错误拒绝。
- **缓解:**
  - 迁移脚本包含回填与 `default` 兜底
  - 数据面与购买接口均做服务端二次校验
  - 补齐调度约束的单测覆盖

