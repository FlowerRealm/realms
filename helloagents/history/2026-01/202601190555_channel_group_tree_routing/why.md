# 变更提案: 渠道组树形路由（Channel Group Routing）

## 需求背景

当前 Realms 已具备上游自动切换能力（failover/粘性/冷却），并通过“分组”（`user_groups`、`channel_groups`、`subscription_plans.group_name`、`upstream_channels.groups`）实现按用户组集合筛选可用渠道与分组计费倍率。

但现状存在两个明显问题：
1. **渠道缺少结构化编排能力**：`upstream_channels.groups` 是 CSV 标签，难以表达“在某个组内再分组/递归路由”的结构；管理后台也无法“进入某个组继续组织内容”。
2. **缺少渠道级自动 ban**：现有仅对 credential/account 做短期冷却，渠道自身如果持续失败，仍会被频繁尝试，影响整体稳定性。

本次变更将“渠道组”升级为**可递归的路由容器**：默认从 `default` 根组开始递归调度；root 可在 Web 中创建子组/渠道并调整排序；并补齐渠道级自动 ban（时长随失败次数叠加）。

## 产品分析

### 目标用户与场景
- **用户群体:** 仅 root（Web 管理后台）
- **使用场景:**
  - 维护多个上游渠道（不同 provider/账号/质量/成本）
  - 需要把渠道按用途归类（例如：对话专用/高可用/便宜但不稳定）
  - 希望在一个“大组”里继续细分子组，并让子组像“一个渠道”一样被调用（递归调度）
- **核心痛点:**
  - 只能用 CSV 标签表达归类，无法表达层级与编排顺序
  - 渠道反复失败时缺少“自动避让”，需要人工禁用

### 价值主张与成功指标
- **价值主张:**
  - 将“渠道编排”从平铺列表升级为树形/递归结构，减少管理复杂度
  - 自动 ban 可持续失败渠道，降低波动，减少人工干预
  - 保持现有“分组计费倍率/订阅组/对话分组”的语义不变
- **成功指标:**
  - 管理后台支持在组内：创建子组、创建/引用渠道、拖拽排序、配置组内 `max_attempts`，并可递归进入子组
  - 数据面请求从 `default` 根组递归选择叶子渠道，遵守现有约束（模型绑定、对话分组、渠道类型等）
  - 渠道连续可重试失败后自动进入 ban，后续请求会跳过该渠道；成功会恢复/减轻惩罚

### 人文关怀
- 管理后台对“自动 ban”提供可解释性（至少在 UI 中标注/在日志与审计中可追溯），避免“莫名其妙不可用”。
- 保持对话分组与订阅组的规则清晰，避免误配置导致用户被意外限流或被路由到非预期渠道。

## 变更内容
1. **新增成员关系表**：引入 `channel_group_members`，作为“组 →（子组/渠道）”关系与排序的 SSOT。
2. **升级 channel_groups 为路由容器**：在 `channel_groups` 中增加路由配置字段（例如 `max_attempts`），用于控制组内 failover 尝试次数。
3. **数据面递归调度**：所有数据面请求从 `default` 根组开始递归调度；子组耗尽后回退到同级下一个成员；组内按成员顺序/状态选择。
4. **渠道级自动 ban**：为渠道增加自动 ban（冷却）策略，ban 时长随失败次数叠加；被 ban 的渠道在调度中直接跳过。
5. **管理后台树形 UI**：在现有“上游渠道管理”基础上，增加“新建渠道组”与“进入子组”能力；并在组内管理成员、排序与 `max_attempts`。
6. **兼容与迁移**：从现有 `upstream_channels.groups`（CSV）迁移生成组/成员关系；并将 `upstream_channels.groups` 作为兼容缓存继续维护（避免打断现有模板/统计/联动逻辑）。

## 影响范围
- **模块:**
  - `internal/store/*`：新增成员表读写、迁移与兼容缓存维护
  - `internal/scheduler/*`：补齐渠道 ban；提供可被递归路由复用的选择/报告能力
  - `internal/api/openai/handler.go`：替换“全局渠道 failover”逻辑为“根组递归调度”
  - `internal/admin/*` + `internal/admin/templates/*`：树形管理 UI 与操作入口
- **API:** 数据面（`/v1/*`）保持兼容；管理后台新增/调整页面与表单（仅 root）。
- **数据:** 新增迁移文件；新增 `channel_group_members` 表；`channel_groups` 增加字段；迁移现有 CSV。

## 核心场景

### 需求: 树形渠道组（default 根组）
**模块:** admin/store

#### 场景: root 在 default 下创建子渠道组并进入
前置条件：root 已登录管理后台。
- 在 default 组内创建子组成功（名称唯一、可配置描述/倍率/状态/`max_attempts`）。
- UI 可点击进入子组，并显示面包屑路径。

#### 场景: root 在某个渠道组内创建渠道
前置条件：在某个组详情页。
- 创建 `openai_compatible` 渠道成功，并自动作为当前组成员出现（可继续配置 endpoint/keys/models）。

#### 场景: 渠道可被多个组引用（仅叶子复用）
前置条件：已有渠道 A。
- 在组 X 中“引用已有渠道 A”成功；渠道 A 在组 X 与组 Y 可同时存在（成员关系可独立排序）。
- 渠道组（子组）不允许被多个父组引用。

### 需求: 数据面递归调度与 failover
**模块:** scheduler/openai handler

#### 场景: 请求从 default 递归选择可用叶子渠道（遵守约束）
前置条件：模型已绑定到若干渠道；用户所属组集合存在。
- 调度从 `default` 开始递归；只会选择“叶子渠道”发起上游请求。
- `chat` 请求只能选择 `openai_compatible`；其他约束（模型绑定、用户组集合、对话分组集合）仍生效。

#### 场景: 子组耗尽后回退到同级下一个成员
前置条件：子组内所有成员均不可用或达到其 `max_attempts` 上限。
- 父组继续尝试同级下一个成员，不会卡死在子组。

#### 场景: SSE 写回后禁止 failover
前置条件：请求为 SSE（`stream=true` 或上游返回 SSE）。
- 一旦开始写回，下游连接保持现有语义：不再 failover，但仍记录结果用于后续调度权重与 ban 决策。

### 需求: 自动 ban 渠道
**模块:** scheduler

#### 场景: 渠道连续可重试失败后进入 ban，并被后续选择跳过
前置条件：某渠道在可重试错误下连续失败。
- 失败次数增加会导致 ban 时长递增（叠加/退避）。
- ban 期间调度跳过该渠道；成功会清零或降低失败计数。

## 风险评估
- **风险：树结构误配置（成环/重复父组）**
  - 缓解：DB 约束（子组单父唯一）+ 写入时环检测 + 运行时 visited 防护。
- **风险：ban 过激导致可用性下降**
  - 缓解：仅对“可重试失败”触发；成功清零；采用可解释的递增策略并做溢出保护。
- **风险：迁移导致路由变化**
  - 缓解：迁移初始结构保持“default -> 所有现有组”的扁平树；渠道成员关系按原 CSV 生成；`upstream_channels.groups` 继续维护以保持兼容。
