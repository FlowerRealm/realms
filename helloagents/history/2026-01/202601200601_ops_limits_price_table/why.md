# 变更提案: Realms 补齐 3/4/5（上游限额、价格表、运维能力）

## 需求背景

在对照 `zsio/claude-code-hub` 后，Realms 与其能力差异主要集中在三类（你指的 3/4/5）：

3) **Provider 维度的限额/并发参数**：`tpm/rpm/rpd/cc`（配置与可视化，必要时做实际生效）。

4) **模型价格表**：支持批量导入/维护（而不是在管理后台逐条维护每个模型价格）。

5) **运维能力**：
- 实时代理状态（活跃请求/最近请求等）
- 版本信息/更新提示（至少提供一个 API）
- Dev 调试落盘（在开发环境输出代理失败/请求快照，便于排障）

这些能力对生产运维与规模化管理有价值：它们让“可控性（限额）/可维护性（批量价格）/可观测性（状态与调试）”更接近一个完整的中转平台。

## 变更内容

1) 为 Realms 的上游渠道（channel）补充 `tpm/rpm/rpd/cc` 配置项与管理面展示。

2) 增加“模型价格表导入”能力：上传 JSON 并批量写入/更新 `managed_models` 定价字段（保持 Realms 现有计费 SSOT 不变）。

3) 增加运维入口：
- Proxy Status：提供一个管理员可用的“活跃/最近请求”视图（或对应 API）
- Version：提供 `/api/version` 返回构建版本信息（可选：对接 GitHub release）
- Dev Logs：在 `env=dev` 且显式开启时，把代理失败/关键请求信息写入本地目录（默认不启用，避免泄露与磁盘膨胀）

## 影响范围

- **模块**
  - `internal/store`：增加查询/字段（channels、usage_events 聚合、价格导入）
  - `internal/admin`：新增/扩展管理后台页面（上游限额、价格导入、代理状态）
  - `internal/server`：新增运维 API 路由（version / proxy status）
  - `internal/config`：增加可选 debug/version 配置项（保持默认不改变行为）
  - `internal/api/openai`：可选：在 dev 调试落盘处增加 hook（默认关闭）

## 核心场景

### 需求: 上游限额配置可见且可控
**模块:** 管理后台 / 调度与限流

#### 场景: 管理员为某个上游渠道设置并发/速率上限
- 在管理后台为 channel 配置 `cc/rpm/rpd/tpm`（允许为空表示无限制）
- 运行时按策略生效（至少先落地 cc/rpm；tpm/rpd 可分期）

### 需求: 批量导入模型价格
**模块:** 管理后台 / 模型目录

#### 场景: 上传价格表 JSON，批量更新 managed_models
- 管理员上传 JSON（支持 LiteLLM/自定义简化格式）
- 系统输出：新增/更新/不变/失败清单
- 不要求改变现有计费链路（仍以 managed_models 为 SSOT）

### 需求: 运维快速定位问题
**模块:** 运维 API / 调试

#### 场景: 查看当前活跃请求与最近请求
- 管理员打开 Proxy Status 页面，看到每个用户的活跃请求数与最近一次请求概要

#### 场景: 开发环境快速排障
- 开启 debug 落盘后，出现上游错误/失败时可在本地目录查看被脱敏的请求快照

## 风险评估

- **风险: 限额“配置了但不生效”会误导管理员**
  - **缓解:** 明确区分“仅配置/已生效”的字段；或先只暴露实际会生效的最小集合（推荐先实现 `cc/rpm`）。

- **风险: 价格表格式不统一导致导入失败**
  - **缓解:** 先支持两种格式：LiteLLM 常见字段 + Realms 简化格式；导入结果必须给出失败原因与可修复建议。

- **风险: Dev 落盘记录包含敏感信息**
  - **缓解:** 默认关闭；开启也必须强制脱敏（Authorization/token/key），并限制单条大小与保留时长/数量。

