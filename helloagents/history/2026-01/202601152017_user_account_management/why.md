# 变更提案: 用户账号管理（账号名/邮箱/密码）

## 需求背景
当前系统仅支持以邮箱登录，且用户管理能力主要集中在管理后台的启用/禁用与角色切换；普通用户缺少自助的账号资料入口。实际使用中需要：
- 允许用户设置“账号名（username）”并用于登录（可为空、可修改）。
- 提供普通用户自助页面：修改邮箱/账号名/密码。
- 管理后台用户管理增强：管理员可修改任意用户的邮箱/账号名/密码。
- 安全约束：修改邮箱需验证码；普通用户修改密码需旧密码；任何账号信息变更后强制登出。

## 变更内容
1. 用户表新增可选字段 `username`（唯一，可为空），并支持“邮箱或账号名”登录。
2. Web 控制台新增“账号设置”页面：支持修改账号名、修改邮箱（验证码）、修改密码（旧密码校验）；成功后强制登出。
3. 管理后台 `/admin/users` 增强：支持修改用户邮箱（验证码）、账号名、重置密码（无需旧密码）；成功后强制登出该用户。

## 影响范围
- **模块:**
  - `internal/store`（用户字段/查询/更新、会话清理）
  - `internal/web`（登录逻辑、账号设置页）
  - `internal/admin`（用户管理页与处理逻辑）
  - `internal/server`（路由注册）
- **文件:**
  - `internal/store/migrations/*.sql`
  - `internal/store/*.go`
  - `internal/web/server.go`
  - `internal/web/templates/*.html`
  - `internal/admin/server.go`
  - `internal/admin/templates/users.html`
  - `internal/server/app.go`
- **API:**
  - Web: 新增 `GET /account`、`POST /account/*`
  - Admin: 新增 `POST /admin/users/{id}/profile`、`POST /admin/users/{id}/password`
- **数据:**
  - `users.username` 新增列与唯一索引

## 核心场景

### 需求: 账号名登录与管理
**模块:** web/store
支持用户设置可选 `username`，并允许使用“邮箱或账号名 + 密码”登录。

#### 场景: 账号名可为空且可修改
用户可将账号名置空（NULL），也可更新为新值；当设置为非空时需保证唯一。
- 预期结果：账号名为空时仅能用邮箱登录；设置后可用账号名登录；修改后生效。

### 需求: 修改邮箱（验证码）
**模块:** web/admin/store
用户或管理员修改邮箱时，需要对新邮箱进行验证码校验。

#### 场景: 修改邮箱后强制登出
当邮箱修改成功后，清理该用户全部 session，并要求重新登录。
- 预期结果：修改成功后立即退出登录；再次登录使用新邮箱。

### 需求: 修改密码（旧密码校验）
**模块:** web/admin/store
普通用户修改密码需输入旧密码；管理员可直接重置任意用户密码。

#### 场景: 修改密码后强制登出
当密码修改成功后，清理该用户全部 session，并要求重新登录。
- 预期结果：所有已登录会话失效；新密码生效。

## 风险评估
- **风险:** 账号名用于登录引入新的唯一性与兼容性问题（历史非标准邮箱登录、大小写/空值语义）。
  - **缓解:** `username` 使用 NULL 表示“未设置”；登录逻辑优先按 email 查询，找不到再按 username 查询，避免破坏存量“非标准邮箱”账号的登录。
- **风险:** 邮箱修改流程若绕过验证码会造成账号劫持风险。
  - **缓解:** 强制依赖邮箱验证码开关；未启用时拒绝修改邮箱；验证码仅对新邮箱生效。
- **风险:** 账号信息变更后仍保留旧 session 会导致安全边界模糊。
  - **缓解:** 成功变更后统一清理该用户所有 session（包括当前会话）。
