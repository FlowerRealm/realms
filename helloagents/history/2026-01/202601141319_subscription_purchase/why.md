# 变更提案: 订阅购买与额度限制

## 需求背景

当前系统已经具备用量事件（`usage_events`）与定价表（`pricing_models`）的基础能力，但缺少“可购买的订阅套餐”与“基于订阅额度的限额判断”，导致：

1. 用户无法在 Web 控制台完成订阅购买（并行叠加）。
2. 数据面请求缺少订阅门槛与额度上限，无法按 5h/7d/30d 的预算约束成本。

本次变更目标：提供一个最小可用的订阅产品（¥12/月）与按美元预算（usd_micros）计量的滚动窗口限额，并在控制台完成购买入口与展示。

## 变更内容
1. 新增订阅套餐表与用户订阅表，并内置一个默认套餐（¥12/月；5h=$6，7d=$20，30d=$80）。
2. 数据面接入订阅配额：未订阅拒绝；额度不足拒绝；并在预留阶段对并发做“上限估算”，降低穿透风险。
3. Web 控制台订阅页补齐：展示当前订阅、套餐列表与购买按钮、用量窗口的已结算/预留/限额/剩余。
4. 补齐“未配置定价导致成本恒为 0”的兜底：插入全局兜底定价（可被更高优先级覆盖）。

## 影响范围
- **模块:**
  - `internal/store`（订阅表访问、用量窗口汇总增强）
  - `internal/quota`（订阅配额 Provider）
  - `internal/api/openai`（传递 max_tokens/max_output_tokens 参与预留估算；返回订阅错误信息）
  - `internal/web`（订阅购买 UI 与路由）
  - `internal/server`（路由注册与 Provider 组装）
- **数据:**
  - 新增 `subscription_plans`、`user_subscriptions`
  - `pricing_models` 增加兜底行（一次性迁移写入）

## 核心场景

### 需求: 订阅购买
**模块:** Web 控制台 / Store

#### 场景: 未订阅用户购买套餐
- 用户访问 `/subscription`，看到“未订阅”提示与套餐列表
- 点击“购买”后写入 `user_subscriptions`，并展示有效期

#### 场景: 已订阅用户再次购买
- 用户再次购买同一套餐，会新增一条订阅记录；有效额度按所有有效订阅并行叠加，不再通过 `end_at` 延长

### 需求: 订阅额度限制
**模块:** Quota / OpenAI API

#### 场景: 未订阅直接调用数据面
- 调用 `/v1/responses` 或 `/v1/chat/completions` 返回 429，提示 `订阅未激活`

#### 场景: 超出 5h/7d/30d 任一窗口限额
- 预留阶段判断 `committed + reserved + this_reserve > limit`，返回 429，提示 `订阅额度不足`

## 风险评估
- **风险:** 成本估算依赖 `pricing_models`；未配置时会导致成本为 0，额度系统失效。
- **缓解:** 迁移中插入全局兜底定价（priority=-100），并在预留阶段按 max_tokens/max_output_tokens 做上限估算以减少并发穿透。
