# 变更提案: Web 对话会话管理（本地）

## 需求背景
当前 `/chat` 对话页仅保存单一对话状态到浏览器 `localStorage`，无法在多个话题/上下文之间切换与管理；用户希望增加“会话列表”，并提供检索、导出与分享能力，同时保持实现简单：**仅浏览器存储**、**直连 `POST /v1/responses`**、**每次请求携带完整历史**。

## 产品分析

### 目标用户与场景
- **用户群体:** 使用 Realms Web 控制台进行临时对话、调试与日常提问的登录用户。
- **使用场景:** 同时进行多个主题对话（如“排查某个渠道问题”“写一段文案”“对比两个模型”），需要快速切换上下文。
- **核心痛点:** 单一对话记录导致上下文互相污染、历史难以整理、需要频繁清空或复制粘贴。

### 价值主张与成功指标
- **价值主张:** 让对话“像工单/笔记一样可管理”，在不引入服务端存储的前提下提升可用性。
- **成功指标:**
  - ✅ 可新建/切换/重命名/删除会话，刷新页面后仍保持一致。
  - ✅ 搜索可快速定位会话（按标题与内容关键字）。
  - ✅ 支持导出（文件）与分享（复制到剪贴板），且均为用户显式触发。
  - ✅ 兼容迁移旧的单会话存储，不丢历史。

### 人文关怀
- **隐私:** 对话内容仅保存在本机浏览器；分享/导出可能包含敏感信息，需在 UI 上明确提示且不做任何自动上传。

## 变更内容
1. `/chat` 页面增加会话侧栏：会话列表 + 搜索框 + 新建按钮。
2. 本地存储结构升级：由“单会话 state”升级为“多会话 sessions + 当前会话指针”，并做一次性迁移。
3. 会话操作：新建、切换、重命名、删除（删除当前会话时自动切换到其他会话或创建空会话）。
4. 导出与分享：
   - **导出:** 下载当前会话 JSON 文件（便于备份/留档）。
   - **分享:** 复制当前会话为 Markdown 文本到剪贴板（便于粘贴到工单/IM/文档）。

## 影响范围
- **模块:** Web 控制台（`/chat`）
- **文件:**
  - `internal/web/templates/chat.html`
  - `helloagents/wiki/api.md`（补充 `/chat` 的“多会话本地存储”说明）
- **API:** 无变更（继续直连 `POST /v1/responses`、`GET /api/chat/models`、`POST /api/chat/token`）
- **数据:** 浏览器 `localStorage`（新增 key；旧 key 迁移）

## 核心场景

### 需求: 会话列表管理
**模块:** Web（chat）
提供会话列表与基础 CRUD，使用户可在多个对话上下文中切换。

#### 需求: 会话列表管理 / 场景: 新建会话
在对话页点击“新建会话”后：
- 创建一条空会话并自动切换到该会话。
- 当前输入框、消息列表与模型选择跟随当前会话。

#### 需求: 会话列表管理 / 场景: 切换会话
在会话列表点击某个会话后：
- 立即切换并渲染该会话消息。
- 发送消息仅影响当前会话（历史输入仅来自当前会话）。

#### 需求: 会话列表管理 / 场景: 重命名会话
对某个会话执行“重命名”后：
- 会话标题更新并持久化。
- 搜索/列表展示使用新标题。

#### 需求: 会话列表管理 / 场景: 删除会话
对某个会话执行“删除”后：
- 会话从列表与存储中移除。
- 若删除的是当前会话：自动切换到最近更新的其他会话；若不存在则创建一个新空会话。

### 需求: 会话检索与兼容迁移
**模块:** Web（chat）
让用户能快速定位会话，并保证从旧版本升级不丢历史。

#### 需求: 会话检索与兼容迁移 / 场景: 搜索会话
在搜索框输入关键字后：
- 会话列表按“标题 + 内容”进行包含匹配过滤（大小写不敏感）。
- 不修改会话数据，仅影响展示。

#### 需求: 会话检索与兼容迁移 / 场景: 旧数据迁移
首次加载新版本对话页时：
- 若检测到旧单会话 `localStorage` 数据且新结构不存在，则将旧数据迁移为一个会话（默认标题“历史会话”），并设为当前会话。

### 需求: 导出与分享
**模块:** Web（chat）
支持用户显式导出与分享对话内容（本地操作）。

#### 需求: 导出与分享 / 场景: 导出会话
点击“导出”后：
- 下载一个 JSON 文件，包含当前会话的元信息（标题/模型/时间）与 messages。

#### 需求: 导出与分享 / 场景: 分享会话
点击“分享”后：
- 将当前会话渲染为 Markdown 文本并写入剪贴板（失败则提示用户手动复制）。

## 风险评估
- **风险:** `localStorage` 容量有限，历史过长可能保存失败或导致 `/v1/responses` 请求体超过服务端 `limits.max_body_bytes`。
  - **缓解:** 保存失败时提示；鼓励使用多会话拆分话题；必要时在 UI 提示“历史过长”。
- **风险:** 分享/导出可能泄露敏感信息。
  - **缓解:** 明确提示“仅在你确定安全时分享/导出”；所有分享/导出均为用户显式点击触发。

