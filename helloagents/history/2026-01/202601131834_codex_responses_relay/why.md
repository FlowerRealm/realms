# 变更提案: Codex Responses 企业级中转服务

## 需求背景

团队希望在云端部署一个面向企业内部的 **Codex（chatgpt.com/backend-api/codex）上游中转服务**，对外提供 **OpenAI Responses** 兼容接口（含 models 等），并满足多账号轮询、限流、日志脱敏与企业级保障需求。

该中转服务的核心价值在于：
- 统一接入点，屏蔽上游差异与变动
- 集中治理 OAuth 凭据、轮询与熔断、限流与审计
- 为企业内部多个客户端/工具提供稳定一致的 API 形态

## 产品分析

### 目标用户与场景
- **用户群体:** 企业内部开发者、平台工程/DevOps、需要统一 AI 接入的工具链维护者
- **使用场景:** 多个 AI 工具/SDK 通过统一 OpenAI API 形态访问 Codex 上游（以 Responses 为主）
- **核心痛点:** OAuth 凭据管理复杂、上游配额与错误不稳定、企业需要审计/脱敏/限流/隔离

### 价值主张与成功指标
- **价值主张:** 在不侵入客户端的前提下提供稳定、可观测、可治理的 Codex 接入能力
- **成功指标:**
  - 兼容性：关键客户端可用（`POST /v1/responses` + `GET /v1/models`），SSE 流式可用
  - 稳定性：自动轮询、熔断与恢复；刷新 token 自动化
  - 安全性：凭据加密存储；日志默认脱敏；可审计
  - 可运维：健康检查、指标、追踪、配置可控

### 人文关怀

默认保护隐私与最小暴露：避免在日志/指标中记录用户输入内容与凭据；对需要追溯的场景提供可配置的安全审计开关，并明确告知采集边界。

## 变更内容

1. 实现 OpenAI 兼容的 **Responses API 数据面**（含 SSE 流式转发）
2. 实现 OpenAI 兼容的 **Models API**（并提供模型映射/别名能力）
3. 构建 **Codex OAuth 凭据接入与刷新**（云端可操作的 onboarding 流程）
4. 实现 **多账号轮询**、失败熔断、指数退避、健康探测
5. 实现 **限流与配额保护**（下游与上游维度）
6. 实现 **日志脱敏**、审计与可观测性（metrics/tracing）
7. 提供 **云部署**（容器化 + 配置/密钥管理）与运维工具

## 影响范围

- **模块:**
  - `api`（OpenAI 兼容入口）
  - `upstream/codex`（Codex 上游调用）
  - `auth`（OAuth 凭据接入/刷新）
  - `router`（多账号选择/熔断）
  - `ratelimit`（限流）
  - `obs`（日志/指标/追踪/审计）
  - `store`（凭据与状态存储）
  - `deploy`（云部署）
- **文件:** 新增为主（新项目）
- **API:** `POST /v1/responses`、`GET /v1/models`（并规划扩展 Responses 相关辅助端点）
- **数据:** OAuth 凭据、账号状态、请求统计、审计事件

## 核心场景

### 需求: Codex OAuth 账号接入与刷新
**模块:** auth / store
支持将 Codex 官方登录产物安全导入到云端，并保证长期可用（自动刷新）。

#### 场景: 管理员导入 auth cache
从受信环境导入 `~/.codex/auth.json`（或等价凭据），服务端可验证并入库。
- 预期结果: 凭据加密存储；可立即用于上游请求；不在日志中泄漏 token

#### 场景: Headless onboarding（云端）
在无法监听本地回调的云端场景，通过 device code 或“复制回调 URL/SSH 隧道”完成登录。
- 预期结果: 完成一次性登录后获得可刷新凭据；具备操作指引与失败提示

### 需求: Responses API 兼容（含 SSE）
**模块:** api / upstream/codex
对外提供 `POST /v1/responses`，并可靠地映射到 Codex 上游。

#### 场景: SSE 流式响应
客户端请求 `stream=true`，服务端透传 SSE 事件并正确处理断开/取消。
- 预期结果: 事件顺序与格式兼容；支持客户端断开后上游及时 cancel；资源不泄漏

#### 场景: 非流式响应
客户端请求 `stream=false`，服务端返回最终 response（必要时内部使用流式聚合）。
- 预期结果: 返回体符合 OpenAI Responses response object 结构；错误码与错误体稳定

### 需求: Models API
**模块:** api / registry
对外提供 `GET /v1/models`，并对上游模型进行映射/别名暴露。

#### 场景: 工具探测模型列表
IDE/SDK 启动时探测模型列表。
- 预期结果: 响应快速可缓存；支持 alias；可按租户/客户端策略隐藏模型

### 需求: 多账号轮询与故障隔离
**模块:** router
多 OAuth 账号轮询，遇到配额/限流/5xx 自动降级与恢复。

#### 场景: 账号被限流/配额不足
单账号触发上游限流/配额错误时自动冷却并切换。
- 预期结果: 不影响整体可用性；冷却期后自动恢复探测

### 需求: 限流与配额保护
**模块:** ratelimit
对下游按 API key/租户限流，对上游按账号保护。

#### 场景: 突发流量保护
客户端突发请求时不中断系统整体。
- 预期结果: 可配置限流策略；返回清晰错误；不导致上游 token 被封或系统雪崩

### 需求: 日志脱敏与审计
**模块:** obs
默认脱敏敏感字段，支持审计事件追踪。

#### 场景: 合规审计
需要追踪“谁在何时调用了什么模型/接口”，但不记录输入内容与凭据。
- 预期结果: 有可检索的审计字段；输入/输出内容默认不落盘；可配置开关

## 风险评估

- **风险:** 上游接口/字段/Headers 可能变化  
  **缓解:** 适配层与灰度开关；兼容策略（strict/relaxed）；完善告警
- **风险:** OAuth 凭据在云端存储与流转带来泄漏风险  
  **缓解:** KMS/Secret Manager；最小权限；加密存储；日志全链路脱敏
- **风险:** 多账号轮询可能引入合规/条款风险  
  **缓解:** 明确仅用于授权的企业账号与合规场景；限制租户与访问边界；可审计

