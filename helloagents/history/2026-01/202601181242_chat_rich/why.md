# 变更提案: Chat 页面增强（上传 / Markdown / 搜索 / 参数）

## 需求背景

当前 Realms 的 `/chat` 页面用于浏览器内直接对话，对话记录仅保存在本地 `localStorage`。现有能力以“纯文本对话”为主，缺少富文本呈现、代码可读性、附件输入与联网搜索等提升效率的功能。

本次目标是在**不引入服务端对话持久化**（仍保持仅本地存储）的前提下，增强对话体验与信息获取能力，并保持现有“多会话/导出(JSON)/分享(Markdown)/Token 轮换/模型切换”的行为不被破坏。

## 产品分析

### 目标用户与场景
- **用户群体:** 使用 Realms Web 控制台进行日常调试、排障、检索与写作的用户（含管理员与普通用户）。
- **使用场景:** 快速提问、贴代码、贴日志、带图提问、对外部网页信息进行检索后总结。
- **核心痛点:** 纯文本难以阅读代码；缺少一键复制；附件需要手工粘贴；联网信息只能切到其他工具再回填。

### 价值主张与成功指标
- **价值主张:** 在一个页面内完成“输入（含附件）→检索→对话→复用（分享/导出）”闭环。
- **成功指标:** 常见工作流无需离开 `/chat`；代码块可读可复制；附件可直接参与对话；联网搜索可通过 API 请求获得结构化结果并注入对话上下文。

### 人文关怀
对话内容可能包含敏感信息（密钥/内部链接/个人信息）。增强功能需在 UI 上提示风险，且默认不进行服务端持久化；分享/导出仍在本地生成，避免无意外泄。

## 变更内容

1. **Markdown 渲染**：对用户/助手消息进行 Markdown 渲染，并进行 XSS 安全净化。
2. **代码高亮与复制**：对代码块进行语法高亮，并提供“一键复制代码块”。
3. **图片/文件上传**：支持本地选择图片与文本类文件，作为消息内容的一部分发送并在对话中展示。
4. **联网搜索（API 请求）**：新增一个受控的服务端搜索代理 API，前端可开关并将搜索结果注入对话上下文。
5. **对话参数可调**：提供常用请求参数（如 `temperature` / `top_p` / `max_output_tokens` 等）的可视化配置，并随会话保存到本地。

## 影响范围
- **模块:** `internal/web`、`internal/config`（新增搜索配置）、（可选）新增 `internal/search`
- **文件:**
  - `internal/web/templates/chat.html`
  - `internal/web/chat.go`
  - `internal/server/app.go`
  - `internal/config/config.go`
  - `config.example.yaml`
- **API:**
  - 新增 `POST /api/chat/search`（Cookie 会话 + CSRF）
- **数据:** 无（不新增服务端持久化）

## 核心场景

### 需求: Markdown 渲染 + 代码高亮复制
**模块:** Web Chat（`/chat`）
在对话中粘贴/生成 Markdown 与代码块时应可读且可复制。

#### 场景: 阅读与复制代码块
用户发送或助手返回包含代码块的内容
- 预期结果: 代码块有高亮样式
- 预期结果: 每个代码块提供复制按钮，复制后有提示

### 需求: 图片/文件上传
**模块:** Web Chat（`/chat`）
允许用户选择本地文件作为输入，减少手工粘贴成本。

#### 场景: 上传图片并提问
用户选择图片（仅本地读取，不上传存储），并发送问题
- 预期结果: 页面展示图片预览
- 预期结果: 请求体使用可兼容的方式携带图片内容（受大小限制）

#### 场景: 上传文本类文件并提问
用户选择 `.txt/.md/.json/.log` 等文本文件
- 预期结果: 页面展示文件名/大小，并将内容（按限制截断）注入消息
- 预期结果: 非文本文件给出明确提示（不读取或仅注入元信息）

### 需求: 联网搜索（API 请求）
**模块:** Web Chat（`/chat` + `/api/chat/search`）
通过服务端以 API 请求方式获取搜索结果，避免浏览器侧 CORS 与密钥泄露。

#### 场景: 开启联网搜索并提问
用户开启“联网搜索”，发送问题
- 预期结果: 前端在发送对话前请求 `/api/chat/search`
- 预期结果: 搜索结果以结构化摘要形式注入对话上下文，并在页面可查看

### 需求: 对话参数可调
**模块:** Web Chat（`/chat`）
对话时可调常用参数并随会话保存到本地。

#### 场景: 调整温度与输出长度
用户在会话设置中调整 `temperature` / `max_output_tokens`
- 预期结果: 发送请求时携带对应参数
- 预期结果: 会话切换后仍保留设置（仅本地）

## 风险评估
- **风险:** Markdown 渲染带来 XSS 风险  
  **缓解:** 使用 DOMPurify 等安全净化；默认禁止危险 URL/schema
- **风险:** 图片/base64 与长文本导致请求体超过 `limits.max_body_bytes` 或 localStorage 超限  
  **缓解:** 前端限制文件大小/类型；图片压缩与降采样；文本截断并提示
- **风险:** 联网搜索带来 SSRF/滥用风险  
  **缓解:** 搜索仅允许访问配置的上游（固定 base_url），并强制 CSRF；增加超时与结果数量上限

