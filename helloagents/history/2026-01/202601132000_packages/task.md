# 套餐功能（用量配额：5 小时 / 周 / 月，按月购买）- 任务清单

## 0) 决策确认（阻塞项）

- [√] 配额时间窗：`5h / week / month`
- [√] 计量口径：成本
- [√] 时间语义：滑动窗口（rolling）+ 相对时间
- [√] 超额行为：直接拒绝
- [√] 购买单位：按月
- [√] 绑定对象：用户账号（`user_id` 先占位）
- [√] 叠加规则：并行（多套餐同时生效，额度汇总）

- [√] 成本单位与精度：`usd_micros`（整数微单位）
- [√] 模型定价表来源与更新机制：由管理员维护/控制（管理侧可配置）
- [√] 超额错误规范：直接拒绝，提示“余额不足”，无需返回额外字段

## 1) 代码现状勘察（落地前准备）

- [ ] 梳理数据面鉴权链路：`user_id` 由数据库查询得到（不依赖 header 注入）
- [ ] 确认业务请求与 management 请求的路由边界（management 不做配额校验）
- [ ] 盘点现有用量统计：是否已有 tokens 统计与落地位置（可复用以算成本）
- [ ] 明确存储后端：数据库优先（多实例/并发安全），否则需锁与一致性方案

## 2) 配置与数据模型

- [ ] 增加套餐配置结构：SKU + 三类成本限额（5h/week/month）
- [ ] 定义订阅数据模型：`UserSubscription`（按月，相对月：按购买时间 + 1 month）
- [ ] 定义用量数据模型：
  - 方案 A：`UsageEvent`（逐请求事件）
  - 方案 B：`UsageBucket`（按分钟/小时分桶聚合，推荐）
- [ ] 设计并实现 store 接口：查询订阅、汇总额度、读写用量（并发安全）

## 3) 成本计算

- [ ] 接入 token 使用量（复用现有统计结构）
- [ ] 增加 model 定价配置（input/output 单价；reasoning 归属规则）
- [ ] 统一成本单位（`usd_micros`，避免 float）
- [ ] 未知模型/alias 兜底策略落地（拒绝/默认单价/不计费等）

## 4) 配额校验（核心功能）

- [ ] 增加 `packages.enabled` 开关（默认关闭）
- [ ] 实现校验 middleware/guard（仅业务请求启用）
- [ ] 实现 rolling window 累计：
  - 5h：分钟级/5 分钟级桶
  - week/month：小时级桶（或日桶）
- [ ] 超额直接拒绝（按统一错误规范）
- [ ] 请求结束后落账：把本次成本写入三类窗口对应的桶/事件

## 5) 管理 API（最小闭环）

- [ ] 列出套餐定义（SKUs 与三类成本限额）
- [ ] 开通套餐（按月，绑定 `user_id` 占位符即可）
- [ ] 查询用户套餐与用量（rolling 5h / 7d / 30d 已用/剩余）
- [ ] 撤销订阅（可选）

## 6) 测试与验证

- [ ] 单元测试：订阅并行叠加额度汇总、rolling window 求和
- [ ] 集成测试：开通套餐 → 请求通过；超额 → 稳定拒绝
- [ ] 回归：确保现有 OAuth/management/转发逻辑不受影响

## 7) 合并策略（与你确认后执行）

- [√] 已将本方案关键口径合并进主方案（`codex` / `user-system`）
- [√] 已将本方案包迁移至 `helloagents/history/2026-01/` 作为决策记录
