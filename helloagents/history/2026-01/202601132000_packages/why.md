# 套餐功能（用量配额：5 小时 / 周 / 月，按月购买）

## 背景

当前系统具备鉴权、管理面板/管理 API、用量统计等能力，但缺少“面向终端用户的套餐/订阅”这一层的权益控制与配额校验。

你希望加入“套餐”能力，其核心不是“有效期”，而是**用量配额（按成本计量）**：
- 每 5 小时一个配额窗口
- 每周一个配额窗口
- 每月一个配额窗口

并且套餐购买以“月”为基本单位，绑定到用户账号（现阶段允许使用 `user_id` 占位符）。

本方案包用于把需求固化成可执行设计与任务清单；与你确认后再合并到 `user-system` 主方案。

## 目标

- 支持定义套餐 SKU（按月购买），并为每个 SKU 配置三类配额：`5h / week / month`
- 支持为某个用户开通/撤销套餐（管理侧即可）
- 在请求链路上做配额校验：超额直接拒绝（可配置开关，默认关闭以保持兼容）
- 可查询：用户当前有效套餐、三类窗口的已用/剩余（管理侧至少具备）
- 支持并行叠加：同一用户多套餐同时生效时，配额按规则汇总

## 已确认的需求口径（来自你的澄清）

- 计量口径：成本（`usd_micros`）
- 定价表：管理员维护/控制
- 时间窗：滑动窗口（rolling window）
- 时间语义：相对时间（例如过去 5 小时 / 过去 7 天 / 过去 30 天）
- 订阅周期：相对月（按购买时间 + 1 month）
- 超额行为：直接拒绝（提示“余额不足”，无需返回额外字段）
- 购买单位：按月
- 绑定对象：用户账号（`user_id` 先占位，来源于数据库）
- 叠加规则：并行（多套餐同时生效，配额汇总）

## 非目标（本阶段不做）

- 不做支付/对账/自动续费（只做权益与配额校验层）
- 不做复杂差异化计费（按地区税、账户折扣、阶梯价等）
- 不做面向终端用户的购买流程 UI（优先管理侧开通/调试）

## 与现有计划的关系

- `helloagents/plan/202601131951_user-system/`：套餐绑定用户，最终应合入 user-system 的账号/权限/审计体系。
- `.tmp/CLIProxyAPI`：实际实现预计主要发生在该目录（配置、存储、middleware、management API、测试）。

## 成功标准（验收口径）

- 管理侧可给用户按月开通套餐，并能查询到三类窗口（rolling 5h / 7d / 30d）的额度与使用情况（按成本）
- 开启强制校验后：超额请求稳定拒绝，错误信息清晰
- 关闭强制校验后：现有行为保持不变（不破坏兼容性）
