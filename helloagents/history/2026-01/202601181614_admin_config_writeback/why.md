# 变更提案: 管理后台写回配置文件（UI 配置全部项）

## 需求背景

当前系统配置分为两类：

1. **启动期配置**：来自 `config.yaml`（YAML，启动时加载，部分字段仅启动时生效）
2. **运行期配置**：来自管理后台 `/admin/settings` 写入 `app_settings`（无需重启）

用户希望**所有配置项都能在 UI 中配置**，并选择了“**后台写回配置文件**”的实现方式。

## 变更内容

新增管理后台页面 `/admin/config`（仅 root）：

- 展示当前配置文件内容（YAML 编辑器）
- 保存时进行严格校验（等价于启动时加载校验），避免写入无效配置导致下次启动失败
- 以**原子写入**方式写回配置文件，并自动创建备份
- 支持“保存并重启”：保存成功后向自身发送 `SIGTERM`，由 systemd/docker 等 supervisor 负责拉起新进程

## 影响范围

- **模块：**
  - 管理后台：`internal/admin`
  - 路由注册：`internal/server`
  - 配置加载：`internal/config`
- **文件（预期）：**
  - `internal/admin/server.go`
  - `internal/admin/templates/*.html`
  - `internal/server/app.go`
  - `cmd/realms/main.go`
  - `internal/config/config.go`

## 核心场景

### 需求: UI 可配置全部项
**模块:** 管理后台 / 配置

#### 场景: 管理员通过 UI 修改启动期配置
- 预期结果：可在 `/admin/config` 修改 YAML 并保存成功（写回 config 文件）。

#### 场景: 管理员保存了错误配置
- 预期结果：保存前校验失败并提示错误，不写盘，避免服务下次启动直接失败。

#### 场景: 修改后立即生效
- 预期结果：选择“保存并重启”后，服务优雅退出；由 supervisor 拉起新进程加载新配置。

## 风险评估

- **风险：敏感信息泄露（EHRB）**
  - 配置文件可能包含 DSN/token/secret 等敏感字段。
  - 缓解：仅 root 可访问；页面提示风险；不在日志打印配置内容；写盘采用最小必要的错误信息。

- **风险：多实例部署不一致**
  - 多副本场景下，写本地文件只影响当前实例。
  - 缓解：文档明确：该方案适用于单实例或共享卷；多实例需配合配置分发机制。

- **风险：无 supervisor 时“保存并重启”导致服务停止**
  - 缓解：页面明确提示；实现上使用 `SIGTERM`（可被捕获优雅退出），不强制 kill -9。

