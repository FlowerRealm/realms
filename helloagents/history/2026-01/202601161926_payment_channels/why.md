# 变更提案: 支付渠道化（按渠道配置 EPay/Stripe）

## 需求背景

当前支付实现采用“全局单实例配置”：
- 配置来源：`config.yaml` 默认 + `app_settings` 界面覆盖。
- 支付页：用户仅能在 `method=stripe` / `method=epay` 两种方式间二选一。
- 回调：`POST /api/pay/stripe/webhook` 与 `GET /api/pay/epay/notify` 固定一套配置验签。

当需要接入 **同类型多份配置**（例如多个 Stripe 商户、多个 EPay 网关/商户号）或进行灰度/分流时，现有模型无法满足。

本提案将“支付方式”的最小单位改为 **支付渠道（Payment Channel）**：每个渠道绑定一个类型（如 `epay` / `stripe`），并拥有独立的一份配置。

## 产品分析

### 目标用户与场景
- **用户群体:** 管理员（root）、普通用户（发起充值/订阅支付）
- **使用场景:**
  - 管理员维护多个支付渠道（不同商户/不同网关），按需启停与排序
  - 用户在支付页选择具体渠道完成支付
- **核心痛点:** 全局单实例支付配置无法支持多商户/多网关并存

### 价值主张与成功指标
- **价值主张:** 支付配置从“全局”升级为“渠道级”，可并存多实例并保持审计可追溯
- **成功指标:**
  - 支持创建多个 `stripe`/`epay` 渠道且互不影响
  - 支付回调按渠道验签、金额校验与幂等入账/生效
  - 未配置支付渠道时，旧的全局配置仍可用（平滑迁移）

### 人文关怀
支付属于高风险功能；本提案坚持最小必要能力与最小暴露面：敏感字段不回显、不写日志；敏感配置与订单操作仅限 `root`。

## 变更内容
1. 新增 `payment_channels` 数据模型：以“渠道”为基本单位，绑定 `type` 并存储一份独立配置。
2. 用户支付页从“选择方式”升级为“选择渠道”：展示所有可用渠道（可同时存在多个 Stripe/EPay）。
3. 支付回调按渠道验签：新增带 `{payment_channel_id}` 的回调路由，以渠道配置验签并入账/生效。
4. 旧配置兼容：当未配置任何支付渠道时，继续使用现有全局 `payment_*` 配置与旧回调地址。

## 影响范围
- **模块:** `internal/store` / `internal/web` / `internal/server` / `internal/admin` / `internal/config`
- **API:**
  - 新增：管理后台“支付渠道”管理路由
  - 新增：Stripe/EPay 按渠道回调路由
  - 保留：现有支付/回调路由（兼容）
- **数据:** 新增 `payment_channels` 表；订单表补充“使用的支付渠道”信息（用于追溯）

## 核心场景

### 需求: 支付渠道独立配置
**模块:** 管理后台 / 支付模块

#### 场景: 管理员创建并维护支付渠道
- root 创建支付渠道，选择类型（`stripe` / `epay`）并填写对应配置
- 可启用/禁用、调整排序/优先级
- 页面提供回调地址提示（尤其 Stripe webhook URL 需要在 Stripe 后台配置）

#### 场景: 用户在支付页选择渠道发起支付
- 用户进入 `/pay/{kind}/{order_id}`，看到所有可用支付渠道
- 选择某个渠道发起支付：跳转到 Stripe Checkout 或 EPay 网关
- 支付成功后自动入账/生效（topup 入账余额；subscription 创建/激活订阅）

### 需求: 支付回调按渠道验签与幂等入账
**模块:** server/webhooks / store

#### 场景: Stripe webhook
- Stripe 回调到 `/api/pay/stripe/webhook/{payment_channel_id}`
- 服务端使用该渠道的 `webhook_secret` 验签，校验金额/币种，幂等更新订单

#### 场景: EPay notify
- 下单时 notify_url 设为 `/api/pay/epay/notify/{payment_channel_id}`
- 服务端使用该渠道的 `partner_id/key/gateway` 验签，校验金额，幂等更新订单

### 需求: 旧配置兼容（可选）
**模块:** web/admin/config

#### 场景: 未配置支付渠道时继续可用
- 若 `payment_channels` 为空：继续使用当前全局配置与旧回调地址
- 便于平滑迁移：先上线新版本，再逐步创建渠道并切换

## 风险评估
- **风险:** 支付回调属于 EHRB；配置错误或验签错误可能导致无法入账/误入账；多渠道并存后可能出现错误路由或“选错渠道”导致支付失败。
- **缓解:**
  - 回调严格验签 + 金额/币种校验；订单更新走事务与幂等路径
  - 渠道级回调地址与密钥一一对应，避免“遍历尝试所有密钥”的不确定行为
  - UI 不回显敏感字段；后台仅 `root` 可配置；订单落库记录使用的 `payment_channel_id` 便于追溯

