# 变更提案: 对话分组支持多选

## 需求背景
当前对话分组（Web `/chat` 与携带 `X-Realms-Chat: 1` 的请求）仅支持配置单个 `channel_groups.name`。这会导致对话路由只能落在单一分组内，无法像现有“自动选择渠道”系统那样在多个分组内选择可用渠道并进行 failover。

本次变更希望：
1. 管理后台支持对话分组多选；
2. 对话请求在“对话分组集合”范围内自动选择渠道；
3. 当模型仅在部分分组可用时，自动落到可用分组（不要求所有分组都可用）；
4. 兼容既有单分组配置与行为。

## 变更内容
1. `app_settings.chat_group_name` 支持保存多个分组（CSV，逗号分隔）。
2. 管理后台 `/admin/channel-groups` 增加“对话分组设置”多选入口，写入 CSV。
3. 数据面：当请求携带 `X-Realms-Chat: 1` 且对话分组已配置时，按分组集合约束调度（组内可 failover）。
4. Web `/api/chat/models`：已启用对话分组时，按分组集合过滤可用模型（并集）。
5. 保持兼容：单个分组值仍按原逻辑生效；未配置/全部禁用时回退到用户分组调度。

## 影响范围
- **模块:** `internal/store`、`internal/api/openai`、`internal/web`、`internal/admin`
- **文件:** 见 task.md
- **API:** 管理后台新增/调整对话分组设置入口；数据面行为不变但约束从“单组”扩展为“多组集合”
- **数据:** 无需迁移；仅复用现有 `app_settings.chat_group_name` 存储格式

## 核心场景

### 需求: 对话分组多选
**模块:** admin/store/openai/web
管理后台可勾选多个分组作为对话分组集合。

#### 场景: 多分组内自动选择渠道
对话请求携带 `X-Realms-Chat: 1` 且已配置对话分组集合：
- 调度仅在该集合内选择渠道（仍遵循既有优先级/推广/粘性/冷却规则）
- 模型只要在集合中的任一分组可用即可通过校验并可被调度到可用渠道

#### 场景: 兼容与回退
未配置对话分组 / 已配置但全部禁用：
- 自动回退到按用户分组集合调度

## 风险评估
- **风险:** 配置中包含已禁用/不存在分组，导致对话分组集合为空。
  - **缓解:** 运行态自动忽略禁用/不存在分组；若集合最终为空则视为“未配置/已禁用”并回退到用户分组调度。
- **风险:** 管理后台误选过多分组导致查询与约束膨胀。
  - **缓解:** 分组数量限制为最多 20 个，与现有分组策略保持一致。

