# 变更提案: 计费金额改用小数（移除 micros/分）

## 需求背景
当前计费与支付相关的数据模型使用 `usd_micros`（USD 的微单位）与 `cny_fen`（人民币分）作为内部/数据库存储单位。需求希望统一改为“直接使用小数金额”，避免在系统内暴露或依赖 micros/分 的概念，并要求对现有数据进行无损迁移。

## 变更内容
1. 数据库与代码中移除 `*_usd_micros` / `*_cny_fen` 字段与命名，改为 `*_usd` / `*_cny` 的小数金额表示。
2. 管理后台与用户页面的金额展示/输入统一使用小数格式（例如 `10.00`）。
3. 更新支付回调校验逻辑：将第三方回调金额转换为小数金额后与订单金额对比。
4. 更新配置与运行期设置项：充值最低金额与充值入账比例改为小数表达。

## 影响范围
- **模块:**
  - `internal/store`（SQL、模型、迁移）
  - `internal/quota`（计费与配额扣减）
  - `internal/web`（用户页面展示/下单）
  - `internal/admin`（管理后台设置/展示）
  - `internal/server`（支付回调）
  - `internal/config`（配置结构与解析）
- **数据:**
  - 涉及余额、用量事件、订阅套餐与订单、充值订单、上游账号余额字段的列名与类型变更

## 核心场景

### 需求: 充值与入账
**模块:** web / store / server

#### 场景: 用户创建充值订单并完成支付
- 用户在 `/topup` 输入小数金额（如 `10.00`），服务端校验最低金额与最大金额。
- 服务端按配置的“入账比例”计算入账 USD 金额并创建订单。
- 支付回调到达后，服务端用小数金额校验订单金额一致，再将订单标记为已入账并增加用户余额。

### 需求: 按量计费与余额扣减
**模块:** quota / store

#### 场景: 请求预留与结算
- 请求开始时预留一笔 USD 金额并扣减余额（若启用余额按量计费）。
- 请求结束后按用量估算实际成本，结算用量事件并返还差额。

### 需求: 订阅额度窗口
**模块:** quota / store / web

#### 场景: 订阅额度校验与窗口展示
- 订阅额度与用量金额均使用小数 USD 表示，窗口汇总与剩余额度按小数展示。

## 风险评估
- **风险:** 金额字段重命名/改类型属于破坏性变更，未升级或未迁移的实例将无法启动或产生运行时错误。
  - **缓解:** 提供单独 SQL 迁移文件并在发布前先执行迁移；代码与迁移需同步发布。
- **风险:** 第三方支付回调金额单位不一致（如 Stripe 以最小货币单位返回）。
  - **缓解:** 明确将回调金额统一转换为小数金额后再对比，避免直接用整数“分”对比。
