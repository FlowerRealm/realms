# 技术设计: 计费金额改用小数（移除 micros/分）

## 技术方案

### 核心技术
- Go 后端：在业务代码中使用 `DECIMAL` 小数金额（避免 `float64` 造成的精度问题）。
- MySQL：将涉及计费的金额列改为 `DECIMAL`，并在迁移中完成旧值缩放（micros→USD 小数；fen→CNY 小数）。

### 实现要点
- **数据库迁移（无损）**
  - 对 `*_usd_micros`：列改名并改为 `DECIMAL`，随后统一执行 `/ 1_000_000` 缩放。
  - 对 `*_cny_fen`：列改名并改为 `DECIMAL`，随后统一执行 `/ 100` 缩放。
- **命名统一**
  - 数据库列名统一使用 `*_usd` / `*_cny`。
  - Go 结构体字段与 JSON 字段同步改名，避免继续暴露 micros/分 的概念。
- **支付回调金额校验**
  - Stripe: `amount_total` 仍为最小货币单位（例如 CNY 为分），转换为小数金额再与订单对比。
  - EPay: 直接解析金额字符串为小数金额再对比。
- **配置与运行期设置项**
  - 配置文件中用小数配置：最低充值金额（CNY）与入账比例（USD per CNY）。
  - `app_settings` 中对应键值改为小数字符串。

## 架构决策 ADR
### ADR-001: 金额存储改为 DECIMAL 小数
**上下文:** 计费相关字段当前使用 `usd_micros` / `cny_fen` 存储，需求要求系统内不再出现该概念，并要求无损迁移。
**决策:** 数据库与业务代码统一改用小数金额表示（MySQL `DECIMAL` + Go 侧小数类型），并通过迁移将旧值按比例缩放后落到新列。
**理由:** 小数金额更符合业务直觉；迁移可保留既有金额精度，避免因 `float64` 带来误差与对账问题。
**替代方案:** 使用 `float64` 直接存金额 → 拒绝原因: 金额计算与对账存在精度风险。
**影响:** 涉及多表字段重命名与类型变更；需要同步更新所有 SQL 与展示层。

## 数据模型
迁移文件将覆盖以下关键表的字段：
- `user_balances`
- `usage_events`
- `subscription_plans`
- `subscription_orders`
- `topup_orders`
- `managed_models` / `pricing_models`（模型定价）
- `channel_groups`（价格倍率）
- `codex_oauth_accounts`（上游账号余额展示字段）

## 安全与性能
- **安全:** 金额解析严格走小数解析与范围校验，避免通过字符串注入影响 SQL；写入金额仍使用参数化查询。
- **性能:** `DECIMAL` 运算开销略高于整数，但当前场景 QPS/数据量可接受；关键扣减仍使用单行锁与简单更新语句。

## 测试与部署
- **测试:** `go test ./...`；关键路径包含：迁移执行、充值下单/回调校验、余额预留/结算、订阅额度窗口汇总。
- **部署:**
  1. 先发布包含迁移文件的版本并执行迁移；
  2. 再发布使用新字段的应用版本（或同一版本在启动时执行迁移后再启动服务）。
