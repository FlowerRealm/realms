# 变更提案: 工单系统（工单 + 消息线程 + 附件）

## 需求背景

当前 Realms 提供了 Web 控制台与管理后台，但缺少一个可追踪、可审计的“用户反馈/问题支持”入口。用户遇到问题时只能通过外部渠道沟通，容易出现：

- 问题描述分散，缺少上下文与时间线
- 管理员无法统一查看与处理，响应效率低
- 附件（截图/日志）无法规范保存，后续追溯困难

因此需要在控制台内加入最小可用的工单能力，形成“用户提交 → 管理员处理 → 结果回馈”的闭环，并通过邮件做关键节点提醒。

## 产品分析

### 目标用户与场景
- **用户群体:** Realms 登录用户（在使用 OpenAI 风格 API 中转服务时遇到配置/模型/用量/上游错误等问题）
- **使用场景:** 用户在控制台提交问题，附带截图/日志；管理员在后台查看工单列表并回复；双方通过工单内消息往返沟通
- **核心痛点:** 沟通无统一入口、缺少可追踪历史、附件难以保存与权限隔离

### 价值主张与成功指标
- **价值主张:** 在 Realms 内提供“可追踪的支持通道”，减少沟通成本与重复排查
- **成功指标:**
  - 用户可在控制台创建/查看自己的工单，并在工单内追加消息与附件
  - `root` 管理员可在后台查看全量工单，回复并可“关闭/恢复（重新打开）”工单
  - 邮件通知可用：用户新建/回复 → 通知管理员；管理员回复/状态变更 → 通知用户
  - 附件本地存储、最大 100MB（按单文件限制），7 天过期自动清理

### 人文关怀

- **隐私与最小暴露:** 工单默认仅创建者可见；管理员仅限 `root`；邮件内容避免泄露敏感 token/key（提示用户不要粘贴密钥）
- **可用性:** 允许上传常见截图/日志文件；附件过期清理前可在页面中显示提示，避免用户误以为“丢数据”

## 变更内容

1. 用户控制台新增工单入口：创建工单、查看列表、查看详情、追加回复与附件
2. 管理后台新增工单入口：查看全量工单列表、查看详情、回复、关闭/恢复工单
3. 新增附件本地存储与下载能力（严格鉴权 + 防路径穿越）
4. 新增附件过期清理（7 天 TTL）与容量/大小限制（单文件 ≤ 100MB）
5. 新增邮件通知（复用现有 SMTP 配置与 app_settings 覆盖机制）

## 影响范围

- **模块:**
  - `internal/web/`（用户控制台页面与处理逻辑）
  - `internal/admin/`（管理员页面与处理逻辑）
  - `internal/store/`（工单/消息/附件的持久化与查询）
  - `internal/store/migrations/`（新增表）
  - `internal/server/`（定时清理任务挂载）
  - `internal/email/`（复用，可能新增通知封装）
  - （可选）`internal/config/`（附件目录/大小/TTL 配置项）
- **文件:** 以上模块新增 handler/template/store/migration 文件
- **API:** 仅新增 Web 控制台与管理后台路由（不影响 `/v1/*` 数据面 API）
- **数据:** 新增工单/消息/附件表；新增过期清理逻辑（删除附件文件与记录）

## 核心场景

### 需求: 用户创建工单
**模块:** `internal/web/`

#### 场景: 创建工单并上传附件
用户已登录，在控制台填写标题与问题描述，可选上传 0-N 个附件（单文件 ≤ 100MB）。
- 创建成功后跳转到工单详情页
- 工单状态为“打开”
- 附件可在详情页下载
- 触发邮件：通知管理员有新工单

### 需求: 用户查看工单
**模块:** `internal/web/`

#### 场景: 查看工单列表（仅自己的）
- 列表仅展示当前用户创建的工单
- 支持按状态筛选（打开/关闭）

#### 场景: 查看工单详情并追加回复/附件
- 用户可在详情页看到消息时间线与附件
- 用户可追加一条消息并上传附件
- 触发邮件：通知管理员有新回复

### 需求: 管理员处理工单
**模块:** `internal/admin/`

#### 场景: 管理员查看全量工单列表
仅 `root` 可访问，列表支持按状态筛选与搜索（如按标题/邮箱）。
- 可进入工单详情页查看完整消息与附件

#### 场景: 管理员回复工单
- 管理员在详情页回复一条消息（可带附件）
- 触发邮件：通知工单创建者

#### 场景: 管理员关闭/恢复工单
- 关闭后用户不可再追加消息（或提示创建新工单）
- 管理员可“恢复”工单为打开状态
- 触发邮件：通知用户状态变更（关闭/恢复）

### 需求: 附件生命周期
**模块:** `internal/server/` + `internal/store/`

#### 场景: 附件 7 天过期自动清理
- 到期后附件文件会被删除（best-effort）
- 数据库记录被删除或标记为过期不可下载
- 不允许任何越权下载（用户仅能下载自己的；管理员可下载全部）

## 风险评估

- **风险:** 上传大文件导致内存/磁盘压力，甚至绕过限制  
  **缓解:** 对上传路由在读取 body 之前使用 `http.MaxBytesReader`；限制单文件大小与总请求大小；落盘流式写入
- **风险:** 本地存储路径穿越/越权下载  
  **缓解:** 仅使用服务端生成的 storage key；下载时以 DB 记录为准并做权限校验；不拼接用户输入路径
- **风险:** 邮件发送失败导致“看不见新工单/回复”  
  **缓解:** 邮件发送 best-effort（记录日志/页面提示），不阻塞工单写入；后续可补后台重试（非本次范围）

