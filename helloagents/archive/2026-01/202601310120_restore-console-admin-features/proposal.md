# 变更提案: restore_console_admin_features

## 元信息
```yaml
类型: 修复
方案类型: implementation
优先级: P0
状态: ✅已完成
创建: 2026-01-31
```

---

## 1. 需求

### 背景
仓库已完成对齐 new-api 的“前后端分离（/api JSON + SPA fallback）”，但当前 SPA 前端仅覆盖最小闭环，导致：
- 用户控制台缺失：订阅管理、余额充值、工单、账号设置等入口或页面不完整
- 管理后台缺失：分组、用户管理、订阅套餐、订单、用量统计、工单、公告、OAuth Apps、系统设置、支付渠道等入口或页面缺失

### 目标
- 在不改动既有路由前提下，补齐上述缺失功能的 SPA 页面与调用逻辑
- 视觉与交互尽量对齐 tag `0.3.3` 的 SSR 模板基线（Bootstrap 风格 + 现有 CSS 变量体系）
- 保持“无需离线化”：继续使用 CDN 引入 Bootstrap/flatpickr/chart.js 等依赖

### 约束条件
```yaml
时间约束: 一次性补齐（不拆多轮）
性能约束: 允许 Vite 构建后 bundle 警告，但需可正常构建与运行
兼容性约束: 路由不变；API 前缀保持 /api/*
业务约束: 不引入离线静态资源打包策略（继续 CDN）
```

### 验收标准
- [ ] 管理后台侧边栏所有入口均可正常访问并具备核心操作：分组/用户/订阅套餐/订单/支付渠道/用量统计/工单/公告/OAuth Apps/系统设置
- [ ] 用户控制台相关页面入口齐全（公告/账号/订阅/充值/支付/工单）
- [ ] `cd web && npm run build` 通过
- [ ] `go test ./...` 通过

---

## 2. 方案

### 技术方案
- 以前端为主补齐：在 `web/src/pages/admin/` 增加缺失页面，按现有 `/api/admin/*` 接口对接数据与操作
- 对缺失的 Admin API 封装补齐 `web/src/api/admin/*`（tickets、paymentChannels）
- 更新 `web/src/pages/AdminPage.tsx` 增加管理后台路由映射；更新 `web/src/layout/AdminLayout.tsx` 增加支付渠道入口
- 同步更新 README 与知识库模块文档，保证“文档一等公民”

### 影响范围
```yaml
涉及模块:
  - web (SPA): 新增/修改管理后台页面与 API client
  - docs: README、知识库 web_spa 模块文档、CHANGELOG
预计变更文件: 20+
```

### 风险评估
| 风险 | 等级 | 应对 |
|------|------|------|
| 页面数量多、漏入口/漏功能 | 中 | 以 AdminLayout 侧边栏为清单逐项对齐；构建/测试验证 |
| 前端 bundle 体积变大 | 低 | 当前接受警告；后续可再做 code-splitting |
| 与后端 feature gate 不一致 | 中 | UI 侧尽量尊重 features 字段；后端依然以 404/校验为准 |

---

## 3. 技术设计（可选）

> 涉及架构变更、API设计、数据模型变更时填写

本次不引入新的后端数据结构与 API，仅补齐前端页面与调用封装。

## 4. 核心场景

### 场景: 管理后台全功能补齐
**模块**: `web/`（Admin）
**条件**: root 用户登录
**行为**: 通过侧边栏访问并完成 CRUD/查看/操作
**结果**: 所有入口可用，功能与 tag `0.3.3` 语义对齐

---

## 5. 技术决策

> 本方案涉及的技术决策，归档后成为决策的唯一完整记录

### restore_console_admin_features#D001: 采用 SPA 补齐而非回退 SSR
**日期**: 2026-01-31
**状态**: ✅采纳
**背景**: 项目已对齐 new-api 的前后端分离架构，SSR 已非默认入口；需要在保持路由与 API 体系不变的情况下补齐功能。
**选项分析**:
| 选项 | 优点 | 缺点 |
|------|------|------|
| A: 恢复 SSR 路由（setWebRoutes/setAdminRoutes） | 实现最快、与 0.3.3 视觉完全一致 | 与“前后端分离”目标冲突；前端代码无法复用；后续维护两套 UI |
| B: 补齐 SPA 页面（本方案） | 保持 new-api 架构与现有路由；复用已有 /api；后续迭代成本更低 | 实现工作量更大；需保证与 SSR 语义一致 |
**决策**: 选择方案 B
**理由**: 保持架构一致性与长期维护成本；避免两套 UI 并存。
**影响**: `web/` 前端页面与 `helloagents/modules/web_spa.md` 文档需要同步更新
