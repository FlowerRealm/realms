{{define "admin_users"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-0">用户管理</h2>
    <p class="text-muted small mb-0">仅 root 可管理用户。</p>
  </div>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
    <i class="ri-user-add-line me-1"></i> 创建用户
  </button>
</div>

{{if .Error}}
<div class="alert alert-danger mb-4">
  <i class="ri-alert-line me-2"></i>{{.Error}}
</div>
{{end}}
{{if .Notice}}
<div class="alert alert-success mb-4">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
</div>
{{end}}

<div class="card overflow-hidden">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th class="ps-4">邮箱</th>
          <th>账号名</th>
          <th>组</th>
          <th>角色</th>
          <th>状态</th>
          <th>余额(USD)</th>
          <th>创建时间</th>
          <th class="text-end pe-4">操作</th>
        </tr>
      </thead>
      <tbody>
        {{range .Users}}
        <tr>
          <td class="ps-4"><span class="fw-bold text-dark">{{.Email}}</span></td>
          <td>
            {{if .Username}}
              <span class="text-dark fw-medium user-select-all" style="font-size: 0.9em;">{{.Username}}</span>
            {{else}}
              <span class="text-muted small fst-italic">未设置</span>
            {{end}}
          </td>
          <td>
            <span class="badge bg-light text-secondary border fw-normal">{{.Groups}}</span>
          </td>
          <td>
            {{if eq .Role "root"}}
              <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 px-2">
                <i class="ri-shield-star-line me-1"></i>{{.Role}}
              </span>
            {{else}}
              <span class="badge rounded-pill bg-light text-secondary border px-2">{{.Role}}</span>
            {{end}}
          </td>
          <td>
            {{if eq .Status 1}}
              <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">
                <i class="ri-checkbox-circle-line me-1"></i>启用
              </span>
            {{else}}
              <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">
                <i class="ri-close-circle-line me-1"></i>禁用
              </span>
            {{end}}
          </td>
          <td>
            <span class="fw-medium text-dark">{{.BalanceUSD}}</span>
          </td>
          <td class="small text-muted">{{.CreatedAt}}</td>
          <td class="text-end pe-4">
            <div class="d-inline-flex gap-1">
              <button type="button" class="btn btn-sm btn-light border text-success" data-bs-toggle="modal" data-bs-target="#addBalanceModal-{{.ID}}" title="加余额">
                <i class="ri-money-dollar-circle-line"></i>
              </button>
              <button type="button" class="btn btn-sm btn-light border text-primary" data-bs-toggle="modal" data-bs-target="#editUserModal-{{.ID}}" title="编辑用户">
                <i class="ri-edit-line"></i>
              </button>
              <button type="button" class="btn btn-sm btn-light border text-warning" data-bs-toggle="modal" data-bs-target="#resetPasswordModal-{{.ID}}" title="重置密码">
                <i class="ri-key-2-line"></i>
              </button>

              <!-- 删除 -->
              {{if and $.IsRoot (ne .ID $.User.ID)}}
              <form method="POST" action="/admin/users/{{.ID}}/delete" data-ajax="1" data-ajax-reload="1" onsubmit="return confirm('确认删除该用户？此操作不可恢复。')">
                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                <button class="btn btn-sm btn-light border text-danger" type="submit" title="删除用户">
                  <i class="ri-delete-bin-line"></i>
                </button>
              </form>
              {{end}}
            </div>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
</div>

{{range .Users}}
<!-- 加余额弹窗 -->
<div class="modal fade" id="addBalanceModal-{{.ID}}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">加余额</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/users/{{.ID}}/balance" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />

          <div class="alert alert-light border py-2 small mb-3">
            <div class="d-flex justify-content-between">
              <span class="text-muted">当前余额</span>
              <span class="fw-bold text-dark">{{.BalanceUSD}} USD</span>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">增加金额 (USD)</label>
            <input name="amount_usd" type="text" class="form-control" required placeholder="例如：5 或 0.5" inputmode="decimal" />
            <div class="form-text">最多 6 位小数；仅支持增加（不支持扣减/设置）。</div>
          </div>

          <div class="mb-3">
            <label class="form-label">备注（可选）</label>
            <textarea name="note" class="form-control" rows="3" maxlength="200" placeholder="用于审计记录（最多 200 字符）"></textarea>
          </div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-success">确认加余额</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 编辑用户弹窗 -->
<div class="modal fade" id="editUserModal-{{.ID}}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">编辑用户</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/users/{{.ID}}/profile" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />

          <div class="mb-3">
            <label class="form-label">邮箱</label>
            <input id="admin-user-email-{{.ID}}" name="email" type="email" class="form-control" required autocomplete="email" value="{{.Email}}" />
            <div class="form-text">修改邮箱成功后会强制登出该用户。</div>
          </div>

	          <hr class="my-3 text-muted opacity-25">
	          <div class="mb-3">
	            <label class="form-label">账号名</label>
	            <input name="username" type="text" class="form-control" autocomplete="username" required value="{{.Username}}" placeholder="例如：alice" />
	            <div class="form-text">支持字母/数字及 . _ -，最多 32 位；用于登录。</div>
	          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">状态</label>
              <select name="status" class="form-select" {{if eq .ID $.User.ID}}disabled{{end}}>
                <option value="1" {{if eq .Status 1}}selected{{end}}>启用</option>
                <option value="0" {{if eq .Status 0}}selected{{end}}>禁用</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">角色</label>
              <select name="role" class="form-select" {{if eq .ID $.User.ID}}disabled{{end}}>
                <option value="user" {{if eq .Role "user"}}selected{{end}}>普通用户</option>
                <option value="root" {{if eq .Role "root"}}selected{{end}}>超级管理员</option>
              </select>
            </div>
          </div>
          {{if eq .ID $.User.ID}}
            <div class="alert alert-warning py-2 small mb-3">
              <i class="ri-alert-line me-1"></i>不能修改当前登录用户的状态或角色。
            </div>
          {{end}}

          <div class="mb-3">
            <label class="form-label">组</label>
            {{$u := .}}
            <div class="card p-2" style="max-height: 200px; overflow-y: auto;">
              {{range $.ChannelGroups}}
                {{$selected := csvHasGroup $u.Groups .Name}}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="groups" value="{{.Name}}" id="group_user_{{$u.ID}}_{{.Name}}"
                        {{if or (isDefaultGroup .Name) $selected}}checked{{end}}
                        {{if isDefaultGroup .Name}}disabled{{else if and (ne .Status 1) (not $selected)}}disabled{{end}}>
                  <label class="form-check-label w-100" for="group_user_{{$u.ID}}_{{.Name}}">
                    {{.Name}} {{if ne .Status 1}}<span class="badge bg-secondary ms-1" style="font-size: 0.7em;">禁用</span>{{end}}
                  </label>
                </div>
              {{end}}
            </div>
            <div class="form-text">用于上游调度选择渠道；用户可属于多个组（并集生效），且必须包含 default。</div>
          </div>

        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 重置密码弹窗 -->
<div class="modal fade" id="resetPasswordModal-{{.ID}}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">重置密码</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/users/{{.ID}}/password" data-ajax="1" data-ajax-reload="1" onsubmit="return confirm('确认重置密码并强制登出该用户？')">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
          <div class="mb-3">
            <label class="form-label">新密码</label>
            <input name="password" type="password" class="form-control" required autocomplete="new-password" placeholder="至少 8 位字符" />
            <div class="form-text">重置成功后会清理该用户所有已登录会话。</div>
          </div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">重置</button>
        </div>
      </form>
    </div>
  </div>
</div>
{{end}}

<!-- 创建用户弹窗 -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">创建新用户</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/users" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
          
          <div class="mb-3">
            <label class="form-label">邮箱</label>
            <input name="email" type="email" class="form-control" required autocomplete="email" placeholder="user@example.com" />
          </div>

	          <div class="mb-3">
	            <label class="form-label">账号名</label>
	            <input name="username" type="text" class="form-control" autocomplete="username" required placeholder="例如：alice" />
	            <div class="form-text">支持字母/数字及 . _ -，最多 32 位；用于登录。</div>
	          </div>

          <div class="mb-3">
            <label class="form-label">初始密码</label>
            <input name="password" type="password" class="form-control" required autocomplete="new-password" placeholder="******" />
          </div>

          {{if .IsRoot}}
          <hr class="my-3 text-muted opacity-25">
          <div class="mb-3">
            <label class="form-label">角色</label>
            <select name="role" class="form-select">
              <option value="user">user（普通用户）</option>
              <option value="root">root（超级管理员）</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">组</label>
            <div class="card p-2" style="max-height: 200px; overflow-y: auto;">
              {{range .ChannelGroups}}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="groups" value="{{.Name}}" id="group_create_{{.Name}}"
                        {{if isDefaultGroup .Name}}checked disabled{{end}}
                        {{if and (ne .Status 1) (not (isDefaultGroup .Name))}}disabled{{end}}>
                  <label class="form-check-label w-100" for="group_create_{{.Name}}">
                    {{.Name}} {{if ne .Status 1}}<span class="badge bg-secondary ms-1" style="font-size: 0.7em;">禁用</span>{{end}}
                  </label>
                </div>
              {{end}}
            </div>
            <div class="form-text">创建后默认包含 default；可额外选择多个组。</div>
          </div>
          {{end}}

        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">创建用户</button>
        </div>
      </form>
    </div>
  </div>
</div>
{{end}}
