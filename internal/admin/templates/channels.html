{{define "admin_channels"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-1">上游渠道管理</h2>
    <p class="text-muted small mb-0">管理模型转发渠道。支持拖拽排序调整优先级（越靠前优先级越高）。</p>
  </div>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createChannelModal">
    <i class="ri-add-line me-1"></i> 新建渠道
  </button>
</div>

<form class="row g-2 align-items-end mb-4" method="GET" action="/admin/channels">
  <div class="col-auto">
    <label class="form-label small text-muted mb-1">开始日期（{{.AdminTimeZoneEffective}}）</label>
    <input type="date" name="start" class="form-control form-control-sm" value="{{.UsageStart}}">
  </div>
  <div class="col-auto">
    <label class="form-label small text-muted mb-1">结束日期（{{.AdminTimeZoneEffective}}）</label>
    <input type="date" name="end" class="form-control form-control-sm" value="{{.UsageEnd}}">
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-sm btn-primary">查询统计</button>
  </div>
</form>

{{if .Notice}}
<div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>
</div>
{{end}}

{{if .Error}}
<div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
  <i class="ri-alert-line me-2"></i>{{.Error}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>
</div>
{{end}}

{{if .SchedulerRuntime.Available}}
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body py-3 d-flex flex-wrap gap-2 align-items-center">
    <span class="text-muted small">智能调度</span>
    {{if .SchedulerRuntime.ForcedActive}}
      <span class="badge bg-warning-subtle text-warning-emphasis border">
        最高优先级：{{.SchedulerRuntime.ForcedChannel}}（剩余 {{.SchedulerRuntime.ForcedRemaining}}）
      </span>
    {{else}}
      <span class="badge bg-light text-muted border">最高优先级：-</span>
    {{end}}
    {{if .SchedulerRuntime.LastSuccessActive}}
      <span class="badge bg-light text-dark border">
        当前在用：{{.SchedulerRuntime.LastSuccessChannel}}（{{.SchedulerRuntime.LastSuccessAt}}）
      </span>
    {{else}}
      <span class="badge bg-light text-muted border">当前在用：-</span>
    {{end}}
  </div>
</div>
{{end}}

<div class="card border-0 shadow-sm overflow-hidden">
  <div class="bg-primary bg-opacity-10 py-3 px-4 d-flex justify-content-between align-items-center">
    <div>
      <span class="text-primary fw-bold text-uppercase small">渠道列表</span>
    </div>
    <div class="text-primary text-opacity-75 smaller">
      <i class="ri-drag-move-2-line me-1"></i> 支持拖拽排序
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th style="width: 5%;"></th> <!-- 拖拽把手 -->
          <th style="width: 35%;">渠道详情</th>
          <th style="width: 10%;">状态</th>
          <th style="width: 10%;">属性</th>
          <th style="width: 15%;">健康状况</th>
          <th class="text-end" style="width: 25%;">操作</th>
        </tr>
      </thead>
      <tbody id="channels-table-body">
        {{range .ChannelViews}}
        <tr data-id="{{.Channel.ID}}">
          <td class="text-center text-muted drag-handle-cell" style="cursor: move; width: 60px;" title="拖动排序">
            <i class="ri-drag-move-2-line fs-5"></i>
          </td>
                    <td>
                      <div class="d-flex flex-column gap-1">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                          <span class="fw-bold text-dark">{{.Channel.Name}}</span>
                          <span class="badge rounded-pill bg-light text-secondary border small" style="font-size: 0.7em;">{{.Channel.Type}}</span>
                          {{if ne .Channel.Type "codex_oauth"}}
                            {{if .Endpoint.BaseURL}}
                              <code class="text-primary bg-light border px-2 py-1 rounded" style="font-size: 0.75em; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{.Endpoint.BaseURL}}</code>
                            {{end}}
                          {{end}}
                        </div>
                        
                        <div class="d-flex flex-wrap align-items-center gap-3 small text-muted">
                          <div class="d-flex align-items-center">
                            <span class="me-1">组:</span>
                            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#channelSettingsModal-{{.Channel.ID}}">
                              <code class="bg-light px-2 py-1 rounded border text-primary" style="font-size: 0.8em; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;" title="点击打开设置">{{.Channel.Groups}}</code>
                            </a>
                          </div>
                          <div class="vr bg-secondary bg-opacity-25" style="height: 14px;"></div>
                          <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                              <span class="text-muted me-1">消耗:</span>
                              <span class="font-monospace fw-bold text-dark">{{.Usage.CommittedUSD}}</span>
                            </div>
                            <div class="d-flex align-items-center">
                              <span class="text-muted me-1">Token:</span>
                              <span class="fw-medium text-dark">{{.Usage.Tokens}}</span>
                            </div>
                            <div class="d-flex align-items-center">
                              <span class="text-muted me-1">缓存:</span>
                              <span class="fw-medium text-success">{{.Usage.CacheRatio}}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
	          <td>
	            {{if eq .Channel.Status 1}}
	              <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">
	                <i class="ri-checkbox-circle-fill me-1"></i>已启用
	              </span>
	            {{else}}
	              <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">
	                <i class="ri-close-circle-fill me-1"></i>已禁用
	              </span>
	            {{end}}
	            {{if and .Runtime.Available .Runtime.BannedActive}}
	              <div class="mt-1">
	                <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis border px-2" title="封禁至 {{.Runtime.BannedUntil}}">
	                  <i class="ri-forbid-2-line me-1"></i>封禁中 · 剩余 {{.Runtime.BannedRemaining}}
	                </span>
	              </div>
	            {{end}}
	          </td>
	          <td>
	            <div class="d-flex flex-column gap-1">
	              <div class="d-flex align-items-center gap-2">
	                {{if .Channel.Promotion}}
	                <span class="badge bg-light text-warning border small" title="推荐渠道"><i class="ri-star-fill me-1"></i>推荐</span>
	                {{else}}
	                <span class="text-muted small">-</span>
	                {{end}}
	                {{if and .Runtime.Available .Runtime.ForcedActive}}
	                <span class="badge bg-warning-subtle text-warning-emphasis border small" title="到期 {{.Runtime.ForcedUntil}}">5分钟最高</span>
	                {{end}}
	              </div>
	              {{if and .Runtime.Available .Runtime.ForcedActive}}
	                <small class="text-muted" style="font-size: 0.75em;">剩余 {{.Runtime.ForcedRemaining}}</small>
	              {{end}}
	            </div>
	          </td>
          <td>
	            {{if .Channel.LastTestAt}}
	              <div class="d-flex flex-column">
	                <div class="mb-1">
	                  {{if .Channel.LastTestOK}}
	                    <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">正常</span>
	                    <span class="small ms-1 fw-medium text-dark">{{.Channel.LastTestLatencyMS}} 毫秒</span>
	                  {{else}}
	                    <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger px-2">失败</span>
	                  {{end}}
	                </div>
                <small class="text-muted" style="font-size: 0.75em;" title="{{.Channel.LastTestAt.Format "2006-01-02 15:04:05"}}">
                  {{.Channel.LastTestAt.Format "15:04"}} 已检查
                </small>
              </div>
            {{else}}
              <span class="text-muted small">未测试</span>
            {{end}}
	          </td>
	          <td class="text-end">
            <div class="d-flex gap-1 justify-content-end">
              <form method="POST" action="/admin/channels/test" data-ajax="1" data-ajax-reload="1">
                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                <input type="hidden" name="_intent" value="test_channel" />
                <input type="hidden" name="channel_id" value="{{.Channel.ID}}" />
                <button class="btn btn-sm btn-light border text-primary" type="submit" title="测试连接">
                  <i class="ri-flashlight-line me-1"></i>测试
                </button>
              </form>
              <form method="POST" action="/admin/channels/{{.Channel.ID}}/promote" data-ajax="1" data-ajax-reload="1">
                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                <input type="hidden" name="return_to" value="/admin/channels" />
                <button class="btn btn-sm btn-light border text-warning" type="submit" title="5分钟最高优先级">
                  <i class="ri-rocket-2-line me-1"></i>5分钟最高
                </button>
              </form>
              {{if ne .Channel.Type "codex_oauth"}}
              <form method="POST" action="/admin/channels/{{.Channel.ID}}/delete" data-ajax="1" data-ajax-reload="1" onsubmit="return confirm('确认删除渠道 {{.Channel.Name}}? 此操作不可撤销。')">
                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                <button class="btn btn-sm btn-light border text-danger" type="submit" title="删除渠道">
                  <i class="ri-delete-bin-line me-1"></i>删除
                </button>
              </form>
              {{end}}
              <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#channelSettingsModal-{{.Channel.ID}}">
                <i class="ri-settings-3-line me-1"></i>设置
              </button>
            </div>
          </td>
	        </tr>

	        <tr class="channel-settings-modal-row"><td colspan="6" class="p-0 border-0"><!-- 渠道设置弹窗（整合行内图标操作） --><div class="modal fade" id="channelSettingsModal-{{.Channel.ID}}" tabindex="-1" aria-hidden="true">
	          <div class="modal-dialog modal-lg modal-dialog-scrollable">
	            <div class="modal-content border-0 shadow">
	              <div class="modal-header">
                <div class="d-flex flex-column">
                  <h5 class="modal-title fw-bold mb-0">渠道设置</h5>
                  <div class="text-muted small mt-1">
                    <span class="fw-semibold text-dark">{{.Channel.Name}}</span>
                    <span class="mx-2 text-light">|</span>
                    <span class="text-muted">#{{.Channel.ID}}</span>
                    <span class="mx-2 text-light">|</span>
                    <code class="bg-light border px-2 py-1 rounded" style="font-size: 0.75em;">{{.Channel.Type}}</code>
                  </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
	              </div>
	              <div class="modal-body bg-light">
	                <div class="d-flex flex-column gap-3">
	                  <!-- 常用设置 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseCommon-{{.Channel.ID}}">常用设置</div>
	                    </div>
	                    <div class="card-body">
                        {{if ne .Channel.Type "codex_oauth"}}
                        <div class="p-3 border rounded bg-light bg-opacity-10">
	                          <form method="POST" action="/admin/channels/{{.Channel.ID}}/endpoints" data-ajax="1" data-ajax-reload="1">
	                            <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                            <label class="form-label fw-medium mb-1">接口基础地址（base_url）</label>
	                            <input name="base_url" type="url" class="form-control" required value="{{.Endpoint.BaseURL}}" placeholder="https://api.openai.com" />
	                            <div class="form-text small text-muted">
	                              保存后立即生效；密钥与模型绑定可在本弹窗继续配置。
	                            </div>
	                            <div class="d-flex gap-2 mt-3">
	                              <button type="submit" class="btn btn-primary btn-sm">
	                                <i class="ri-save-line me-1"></i>保存基础地址
	                              </button>
	                            </div>
	                          </form>
	                        </div>
	                        {{else}}
	                        <div class="alert alert-light border small mb-0">
	                          <i class="ri-information-line me-1"></i>codex_oauth 为内置渠道：<code>base_url</code> 不可修改；请在本弹窗的“授权账号”分区管理账号与状态。
	                        </div>
	                        {{end}}
	                    </div>
	                  </div>

	                  {{if and (ne .Channel.Type "codex_oauth") (gt .Endpoint.ID 0)}}
	                  <!-- 密钥管理 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseKeys-{{.Channel.ID}}">密钥管理</div>
	                    </div>
	                    <div class="card-body">
	                        <div class="form-text small text-muted mb-3">密钥将以明文存储，仅展示提示；删除不可恢复。</div>

		                        <div class="table-responsive">
	                          <table class="table table-hover align-middle mb-0">
	                            <thead class="bg-light">
	                              <tr>
	                                <th>名称</th>
	                                <th>密钥提示</th>
	                                <th>状态</th>
	                                <th class="text-end">操作</th>
	                              </tr>
	                            </thead>
	                            <tbody>
	                              {{$channel := .Channel}}
	                              {{if .Credentials}}
	                                {{range .Credentials}}
	                                <tr>
	                                  <td>
	                                    {{if .Name}}
	                                      <span class="fw-semibold text-dark">{{.Name}}</span>
                                    {{else}}
                                      <span class="text-muted small">-</span>
                                    {{end}}
                                  </td>
                                  <td>
                                    {{if .APIKeyHint}}
                                      <code class="text-secondary bg-light border p-2 rounded d-inline-block" style="font-size: 0.9em;">{{.MaskedKey}}</code>
                                    {{else}}
                                      <span class="text-muted small">-</span>
                                    {{end}}
                                  </td>
                                  <td>
                                    {{if eq .Status 1}}
                                      <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">
                                        <i class="ri-checkbox-circle-line me-1"></i>启用
                                      </span>
                                    {{else}}
                                      <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">
                                        <i class="ri-close-circle-line me-1"></i>禁用
                                      </span>
	                                    {{end}}
	                                  </td>
	                                  <td class="text-end">
	                                    <form method="POST" action="{{if eq $channel.Type "anthropic"}}/admin/anthropic-credentials/{{.ID}}/delete{{else}}/admin/openai-credentials/{{.ID}}/delete{{end}}" onsubmit="return confirm('确认彻底删除该凭证？且不可恢复。')" class="d-inline">
	                                      <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                                      <button class="btn btn-sm btn-light border text-danger" type="submit" data-rlm-reopen-hash="#keys">
	                                        <i class="ri-delete-bin-line me-1"></i>删除
	                                      </button>
	                                    </form>
                                  </td>
                                </tr>
                                {{end}}
                              {{else}}
                                <tr>
                                  <td colspan="4" class="text-center text-muted py-3">暂无密钥</td>
                                </tr>
                              {{end}}
                            </tbody>
                          </table>
                        </div>

                        <hr class="my-4 text-muted opacity-25">

	                        <form method="POST" action="{{if eq .Channel.Type "anthropic"}}/admin/endpoints/{{.Endpoint.ID}}/anthropic-credentials{{else}}/admin/endpoints/{{.Endpoint.ID}}/openai-credentials{{end}}" data-rlm-reopen-hash="#keys">
                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                          <div class="row g-3">
                            <div class="col-md-4">
                              <label class="form-label fw-medium">备注名称（可选）</label>
                              <input name="name" type="text" class="form-control" placeholder="例如：team-a-gpt4" />
                            </div>
                            <div class="col-md-8">
                              <label class="form-label fw-medium">API 密钥</label>
	                              <input name="api_key" type="text" class="form-control font-monospace" required placeholder="{{if eq .Channel.Type "anthropic"}}sk-ant-...{{else}}sk-...{{end}}" />
                              <div class="form-text small text-muted">密钥将以明文存储。</div>
                            </div>
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-add-line me-1"></i>添加密钥
                          </button>
                        </form>
                      </div>
                    </div>
                  {{end}}

	                  {{if and (eq .Channel.Type "codex_oauth") (gt .Endpoint.ID 0)}}
	                  <!-- 授权账号 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseAccounts-{{.Channel.ID}}">授权账号</div>
	                    </div>
	                    <div class="card-body">
	                        <div class="d-flex flex-wrap gap-2 mb-3">
	                          <form method="POST" action="/admin/endpoints/{{.Endpoint.ID}}/codex-oauth/start" class="d-inline" target="_blank">
	                            <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                            <button type="submit" class="btn btn-sm btn-primary" data-rlm-reopen-hash="#accounts">
                              <i class="ri-external-link-line me-1"></i>发起授权（新窗口）
                            </button>
                          </form>
                          <form method="POST" action="/admin/endpoints/{{.Endpoint.ID}}/codex-accounts/refresh" class="d-inline">
                            <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                            <button class="btn btn-sm btn-light border" type="submit" data-rlm-reopen-hash="#accounts">
                              <i class="ri-refresh-line me-1"></i>全部刷新
                            </button>
                          </form>
                          <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="collapse" data-bs-target="#codexBatchRegisterCollapse-{{.Channel.ID}}" aria-expanded="false" aria-controls="codexBatchRegisterCollapse-{{.Channel.ID}}">
                            <i class="ri-group-line me-1"></i>批量注册
                          </button>
                        </div>

                        <div class="row g-3">
                          <div class="col-12 col-lg-6">
                            <div class="p-3 border rounded bg-light bg-opacity-10 h-100">
                              <div class="fw-semibold mb-2">完成授权（粘贴回调 URL）</div>
                              <form method="POST" action="/admin/endpoints/{{.Endpoint.ID}}/codex-oauth/complete" data-rlm-reopen-hash="#accounts">
                                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                <input name="callback_url" class="form-control" placeholder="http://localhost:1455/auth/callback?code=...&state=..." />
                                <div class="form-text small text-muted mt-2">如回跳失败，请将浏览器地址栏的完整 URL（含 code/state）粘贴到这里。</div>
                                <button class="btn btn-sm btn-light border w-100 mt-3" type="submit">完成授权</button>
                              </form>
                            </div>
                          </div>
                          <div class="col-12 col-lg-6">
                            <div class="p-3 border rounded bg-light bg-opacity-10 h-100">
                              <div class="fw-semibold mb-2">手工录入（可选）</div>
                              <form method="POST" action="/admin/endpoints/{{.Endpoint.ID}}/codex-accounts" data-rlm-reopen-hash="#accounts">
                                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                <div class="mb-2">
                                  <label class="form-label small text-muted mb-1">邮箱（可选）</label>
                                  <input name="email" class="form-control" type="email" placeholder="user@example.com" />
                                </div>
                                <div class="mb-2">
                                  <label class="form-label small text-muted mb-1">访问令牌</label>
                                  <input name="access_token" class="form-control font-monospace" required />
                                </div>
                                <div class="mb-2">
                                  <label class="form-label small text-muted mb-1">刷新令牌</label>
                                  <input name="refresh_token" class="form-control font-monospace" required />
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary w-100 mt-2">保存账号</button>
                              </form>
                            </div>
                          </div>
                        </div>

                        <div class="collapse mt-3" id="codexBatchRegisterCollapse-{{.Channel.ID}}">
                          <div class="p-3 border rounded bg-warning bg-opacity-10">
                            <div class="fw-semibold mb-2">批量注册 OpenAI 账号</div>
                            <div id="codexBatchRegisterErr-{{.Channel.ID}}" class="alert alert-danger py-2 small d-none mb-2"></div>
                            <div class="row g-3">
                              <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">数量</label>
                                <input type="number" id="codexBatchCount-{{.Channel.ID}}" class="form-control" min="1" max="10" value="1" />
                              </div>
                              <div class="col-md-9">
                                <label class="form-label small text-muted mb-1">Worker Domain</label>
                                <input type="url" id="codexWorkerDomain-{{.Channel.ID}}" class="form-control" placeholder="https://mail.example.workers.dev" />
                              </div>
                              <div class="col-md-6">
                                <label class="form-label small text-muted mb-1">Admin Token</label>
                                <input type="text" id="codexAdminToken-{{.Channel.ID}}" class="form-control" placeholder="your_admin_token" />
                              </div>
                              <div class="col-md-6">
                                <label class="form-label small text-muted mb-1">CRS API Base（可选）</label>
                                <input type="url" id="codexCrsApiBase-{{.Channel.ID}}" class="form-control" placeholder="https://crs.example.com" />
                              </div>
                              <div class="col-md-6">
                                <label class="form-label small text-muted mb-1">CRS Admin Token（可选）</label>
                                <input type="text" id="codexCrsAdminToken-{{.Channel.ID}}" class="form-control" placeholder="Bearer admin_token_xxx" />
                              </div>
                              <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" id="codexEnableTeamInvite-{{.Channel.ID}}" />
                                  <label class="form-check-label" for="codexEnableTeamInvite-{{.Channel.ID}}">启用团队邀请（可选）</label>
                                </div>
                              </div>
                            </div>
                            <div class="d-flex gap-2 mt-3">
                              <button type="button" class="btn btn-sm btn-warning" data-rlm-start-batch-register="{{.Channel.ID}}">
                                <i class="ri-play-line me-1"></i>开始注册
                              </button>
                            </div>
                          </div>
                        </div>

                        <div class="table-responsive mt-4">
                          <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted">
                              <tr>
                                <th style="width: 30%;">邮箱与套餐</th>
                                <th style="width: 45%;">订阅与额度</th>
                                <th style="width: 10%;">状态</th>
                                <th class="text-end" style="width: 15%;">操作</th>
                              </tr>
                            </thead>
                            <tbody>
                              {{if .Accounts}}
                                {{range .Accounts}}
                                <tr>
                                  <td>
                                    <div class="d-flex flex-column">
                                      <span class="fw-bold text-dark mb-1" style="font-size: 0.9rem;">{{if .Email}}{{.Email}}{{else}}未绑定邮箱{{end}}</span>
                                      <div>
                                        {{if .PlanType}}
                                          <span class="badge rounded-pill bg-info bg-opacity-10 text-info border border-info border-opacity-10 px-2" style="font-size: 0.75rem;">{{.PlanType}}</span>
                                        {{else}}
                                          <span class="text-muted small">-</span>
                                        {{end}}
                                      </div>
                                    </div>
                                  </td>
                                  <td>
                                    <div style="max-width: 520px;">
                                      {{if .QuotaError}}
                                        <div class="text-danger border border-danger border-opacity-10 bg-danger bg-opacity-10 p-2 rounded small">
                                          <i class="ri-error-warning-line me-1"></i>{{.QuotaError}}
                                        </div>
                                      {{else}}
                                        {{if ne .QuotaCredits "-" }}<div class="fw-bold text-dark mb-2" style="font-size: 0.9rem;"><i class="ri-coin-line me-1 text-primary"></i>{{.QuotaCredits}}</div>{{end}}

                                        {{if .QuotaPrimaryShow}}
                                        <div class="mb-3">
                                          <div class="d-flex justify-content-between align-items-end mb-1">
                                            <div>
                                              <span class="text-dark fw-bold" style="font-size: 0.85rem;" title="5 小时额度（$6/5h）"><i class="ri-flashlight-line me-1 text-warning"></i>5h 额度</span>
                                              {{if ne .QuotaPrimaryDetail "-"}}<span class="text-muted ms-2" style="font-size: 0.8rem;">{{.QuotaPrimaryDetail}}</span>{{end}}
                                            </div>
                                            <span class="text-dark fw-bold" style="font-size: 0.85rem;">{{.QuotaPrimaryUsed}}%</span>
                                          </div>
                                          <div class="progress" style="height: 8px; background-color: rgba(0,0,0,0.05); border-radius: 4px;">
                                            <div class="progress-bar {{if gt .QuotaPrimaryUsed 90}}bg-danger{{else if gt .QuotaPrimaryUsed 70}}bg-warning{{else}}bg-primary{{end}}"
                                                 role="progressbar"
                                                 style="width: {{.QuotaPrimaryUsed}}%; border-radius: 4px;"
                                                 aria-valuenow="{{.QuotaPrimaryUsed}}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100"></div>
                                          </div>
                                        </div>
                                        {{else if ne .QuotaPrimary "-"}}
                                          <div class="text-muted mb-2" style="font-size: 0.85rem;"><i class="ri-flashlight-line me-1"></i>5h 额度：{{.QuotaPrimary}}</div>
                                        {{end}}

                                        {{if .QuotaSecondaryShow}}
                                        <div class="mb-0">
                                          <div class="d-flex justify-content-between align-items-end mb-1">
                                            <div>
                                              <span class="text-dark fw-bold" style="font-size: 0.85rem;" title="周限额与代码审查额度（$20/week）"><i class="ri-shield-flash-line me-1 text-info"></i>周额度</span>
                                              {{if ne .QuotaSecondaryDetail "-"}}<span class="text-muted ms-2" style="font-size: 0.8rem;">{{.QuotaSecondaryDetail}}</span>{{end}}
                                            </div>
                                            <span class="text-dark fw-bold" style="font-size: 0.85rem;">{{.QuotaSecondaryUsed}}%</span>
                                          </div>
                                          <div class="progress" style="height: 8px; background-color: rgba(0,0,0,0.05); border-radius: 4px;">
                                            <div class="progress-bar {{if gt .QuotaSecondaryUsed 90}}bg-danger{{else if gt .QuotaSecondaryUsed 70}}bg-warning{{else}}bg-primary{{end}}"
                                                 role="progressbar"
                                                 style="width: {{.QuotaSecondaryUsed}}%; border-radius: 4px;"
                                                 aria-valuenow="{{.QuotaSecondaryUsed}}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100"></div>
                                          </div>
                                        </div>
                                        {{else if ne .QuotaSecondary "-"}}
                                          <div class="text-muted" style="font-size: 0.85rem;"><i class="ri-shield-flash-line me-1"></i>周额度：{{.QuotaSecondary}}</div>
                                        {{end}}

                                        {{if and (eq .QuotaCredits "-") (not .QuotaPrimaryShow) (eq .QuotaPrimary "-") (not .QuotaSecondaryShow) (eq .QuotaSecondary "-") (not .SubscriptionActive) }}<span class="text-muted">-</span>{{end}}
                                      {{end}}
                                    </div>
                                  </td>
                                  <td>
                                    {{if or .InCooldown (ne .Runtime.CoolingUntil "")}}
                                      <span class="badge rounded-pill bg-warning bg-opacity-10 text-warning px-3 py-2 border border-warning border-opacity-25" style="width: fit-content;">冷却中</span>
                                    {{else if eq .Status 1}}
                                      <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-3 py-2 border border-success border-opacity-25" style="width: fit-content;">运行中</span>
                                    {{else}}
                                      <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-3 py-2 border border-secondary border-opacity-25" style="width: fit-content;">已禁用</span>
                                    {{end}}
                                  </td>
                                  <td class="text-end">
                                    <div class="d-inline-flex gap-2">
                                      <form method="POST" action="/admin/codex-accounts/{{.ID}}/refresh" class="d-inline">
                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                        <button class="btn btn-sm btn-outline-primary" type="submit" data-rlm-reopen-hash="#accounts">
                                          <i class="ri-refresh-line me-1"></i>刷新
                                        </button>
                                      </form>
                                      <form method="POST" action="/admin/codex-accounts/{{.ID}}/delete" onsubmit="return confirm('确认彻底删除该账号？且不可恢复。')" class="d-inline">
                                        <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                                        <button class="btn btn-sm btn-outline-danger" type="submit" data-rlm-reopen-hash="#accounts">
                                          <i class="ri-delete-bin-line me-1"></i>删除
                                        </button>
                                      </form>
                                    </div>
                                  </td>
                                </tr>
                                {{end}}
                              {{else}}
                                <tr>
                                  <td colspan="4" class="text-center text-muted py-3">暂无账号</td>
                                </tr>
                              {{end}}
                            </tbody>
                          </table>
                        </div>

                        <!-- 批量注册进度弹窗 -->
                        <div class="modal fade" id="codexBatchProgressModal-{{.Channel.ID}}" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                          <div class="modal-dialog modal-lg">
                            <div class="modal-content border-0 shadow">
                              <div class="modal-header">
                                <h5 class="modal-title fw-bold"><i class="ri-loader-4-line me-2"></i>批量注册进行中...</h5>
                              </div>
                              <div class="modal-body">
                                <div class="mb-4">
                                  <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">总体进度</span>
                                    <span id="codexBatchProgressText-{{.Channel.ID}}" class="text-muted">0/0</span>
                                  </div>
                                  <div class="progress" style="height: 20px;">
                                    <div id="codexBatchProgressBar-{{.Channel.ID}}" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                  </div>
                                </div>
                                <div class="mb-3">
                                  <div class="fw-bold mb-2">当前状态</div>
                                  <div id="codexBatchCurrentStatus-{{.Channel.ID}}" class="text-muted small">等待开始...</div>
                                </div>
                                <div class="mb-3">
                                  <div class="fw-bold mb-2">执行日志</div>
                                  <div id="codexBatchLogContainer-{{.Channel.ID}}" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto; font-family: var(--bs-font-monospace); font-size: 0.85rem;">
                                    <div class="text-muted small">日志将在这里显示...</div>
                                  </div>
                                </div>
                              </div>
                              <div class="modal-footer border-top-0">
                                <button type="button" class="btn btn-light" id="codexBatchCloseProgressBtn-{{.Channel.ID}}" disabled>关闭</button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {{end}}

	                  {{if not $.Features.ModelsDisabled}}
	                  <!-- 模型绑定 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseModels-{{.Channel.ID}}">模型绑定</div>
	                    </div>
	                    <div class="card-body">
	                        <div class="d-flex flex-wrap gap-2 mb-3">
	                          <form method="POST" action="/admin/channels/test" data-ajax="1" data-ajax-reload="1" class="d-inline" data-rlm-reopen-hash="#models">
	                            <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                            <input type="hidden" name="_intent" value="test_channel" />
                            <input type="hidden" name="channel_id" value="{{.Channel.ID}}" />
                            <input type="hidden" name="return_to" value="/admin/channels" />
                            <button class="btn btn-sm btn-light border text-primary" type="submit">
                              <i class="ri-flashlight-line me-1"></i>测试全部
                            </button>
                          </form>
                        </div>

                        <div class="table-responsive">
                          <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                              <tr>
                                <th>对外 ID</th>
                                <th>上游模型</th>
                                <th>状态</th>
                                <th>更新时间</th>
                                <th class="text-end">操作</th>
                              </tr>
                            </thead>
	                            <tbody>
	                              {{$ch := .Channel}}
	                              {{range $cm := .ChannelModels}}
	                              <tr>
	                                <td class="fw-semibold text-dark">
	                                  <div class="d-flex align-items-center gap-2">
	                                    {{$icon := modelIconURL $cm.PublicID ""}}
	                                    {{if $icon}}
	                                      <img class="rlm-model-icon" src="{{$icon}}" alt="模型" title="{{$cm.PublicID}}" loading="lazy" onerror="this.style.display='none';" />
	                                    {{end}}
	                                    <select class="form-select form-select-sm" name="public_id" form="updateChannelModelForm-{{$ch.ID}}-{{$cm.ID}}" required>
	                                      {{range $.ManagedModels}}
	                                        <option value="{{.PublicID}}" {{if eq $cm.PublicID .PublicID}}selected{{end}}>{{.PublicID}}</option>
	                                      {{end}}
	                                    </select>
	                                  </div>
	                                </td>
	                                <td>
	                                  <input class="form-control form-control-sm font-monospace" name="upstream_model" form="updateChannelModelForm-{{$ch.ID}}-{{$cm.ID}}" type="text" value="{{$cm.UpstreamModel}}" placeholder="留空=同对外ID" />
	                                </td>
	                                <td>
	                                  <select class="form-select form-select-sm" name="status" form="updateChannelModelForm-{{$ch.ID}}-{{$cm.ID}}">
	                                    <option value="1" {{if eq $cm.Status 1}}selected{{end}}>启用</option>
	                                    <option value="0" {{if eq $cm.Status 0}}selected{{end}}>禁用</option>
	                                  </select>
	                                </td>
	                                <td class="small text-muted">{{$cm.UpdatedAt}}</td>
	                                <td class="text-end">
	                                  <form id="updateChannelModelForm-{{$ch.ID}}-{{$cm.ID}}" method="POST" action="/admin/channels/{{$ch.ID}}/models/{{$cm.ID}}" data-ajax="1" data-ajax-reload="1" data-rlm-reopen-hash="#models" class="d-none">
	                                    <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                                  </form>
	                                  <div class="d-flex justify-content-end gap-1">
	                                    <button type="submit" form="updateChannelModelForm-{{$ch.ID}}-{{$cm.ID}}" class="btn btn-sm btn-light border text-secondary">
	                                      <i class="ri-save-3-line me-1"></i>保存
	                                    </button>
	                                    <form method="POST" action="/admin/channels/test" data-ajax="1" data-ajax-reload="1" class="d-inline" data-rlm-reopen-hash="#models">
	                                      <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                                      <input type="hidden" name="_intent" value="test_channel" />
	                                      <input type="hidden" name="channel_id" value="{{$ch.ID}}" />
	                                      <input type="hidden" name="binding_id" value="{{.ID}}" />
	                                      <input type="hidden" name="return_to" value="/admin/channels" />
	                                      <button class="btn btn-sm btn-light border text-primary" type="submit">
	                                        <i class="ri-flashlight-line me-1"></i>测试
	                                      </button>
	                                    </form>
	                                    <form method="POST" action="/admin/channels/{{$ch.ID}}/models/{{$cm.ID}}/delete" data-ajax="1" data-ajax-reload="1" onsubmit="return confirm('确认删除该绑定? 不可恢复。')" class="d-inline" data-rlm-reopen-hash="#models">
	                                      <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                                      <button class="btn btn-sm btn-light border text-danger" type="submit">
	                                        <i class="ri-delete-bin-line me-1"></i>删除
	                                      </button>
	                                    </form>
	                                  </div>
	                                </td>
	                              </tr>
	                              {{end}}
                              {{if not .ChannelModels}}
                              <tr>
                                <td colspan="5" class="text-center text-muted py-3">暂无绑定</td>
                              </tr>
                              {{end}}
                            </tbody>
                          </table>
                        </div>

                        <hr class="my-4 text-muted opacity-25">

                        <form method="POST" action="/admin/channels/{{.Channel.ID}}/models" data-ajax="1" data-ajax-reload="1" data-rlm-reopen-hash="#models">
                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                          <div class="row g-3">
                            <div class="col-md-5">
                              <label class="form-label fw-medium">对外 ID</label>
                              <select name="public_id" class="form-select" required>
                                {{range $.ManagedModels}}
                                  <option value="{{.PublicID}}">{{.PublicID}}</option>
                                {{end}}
                              </select>
                              <div class="form-text small text-muted">如列表为空，请先到“模型管理”创建模型。</div>
                            </div>
                            <div class="col-md-5">
                              <label class="form-label fw-medium">上游模型</label>
                              <input name="upstream_model" type="text" class="form-control" placeholder="留空表示与对外 ID 相同" />
                            </div>
                            <div class="col-md-2">
                              <label class="form-label fw-medium">状态</label>
                              <select name="status" class="form-select">
                                <option value="1" selected>启用</option>
                                <option value="0">禁用</option>
                              </select>
                            </div>
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-add-line me-1"></i>新增绑定
                          </button>
                        </form>
                      </div>
                    </div>
                  {{end}}

		                  <!-- 分组 -->
		                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseGroups-{{.Channel.ID}}">分组设置</div>
	                    </div>
	                    <div class="card-body">
	                        <form method="POST" action="/admin/channels/{{.Channel.ID}}" data-ajax="1" data-ajax-reload="1">
	                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                          <input type="hidden" name="_intent" value="update_channel_groups" />
                          <input type="hidden" name="channel_id" value="{{.Channel.ID}}" />
                          <div class="card p-2" style="max-height: 260px; overflow-y: auto;">
                            {{$ch := .Channel}}
                            {{range $.ChannelGroups}}
                              {{$selected := csvHasGroup $ch.Groups .Name}}
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="groups" value="{{.Name}}" id="group_edit_{{$ch.ID}}_{{.Name}}"
                                       {{if $selected}}checked{{end}}
                                       {{if and (ne .Status 1) (not $selected)}}disabled{{end}}>
                                <label class="form-check-label w-100" for="group_edit_{{$ch.ID}}_{{.Name}}">
                                   {{.Name}}{{if ne .Status 1}} <span class="badge bg-secondary ms-1" style="font-size: 0.7em;">禁用</span>{{end}}
                                </label>
                              </div>
                            {{end}}
                          </div>
                          <div class="form-text small text-muted mt-2">用于上游调度选择渠道。</div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-save-line me-1"></i>保存分组
                          </button>
                        </form>
                      </div>
                    </div>

	                  <!-- 请求字段策略 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseRequestPolicy-{{.Channel.ID}}">请求字段策略</div>
	                    </div>
	                    <div class="card-body">
	                        <form method="POST" action="/admin/channels/{{.Channel.ID}}/request_policy" data-ajax="1" data-ajax-reload="1">
	                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                          <input type="hidden" name="return_to" value="/admin/channels" />
                          {{$ch := .Channel}}
                          <div class="d-flex flex-column gap-2">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="allow_service_tier" value="1" id="policy_service_tier_{{$ch.ID}}" {{if $ch.AllowServiceTier}}checked{{end}} />
                              <label class="form-check-label" for="policy_service_tier_{{$ch.ID}}">允许透传 <code>service_tier</code></label>
                              <div class="form-text small text-muted">可能触发上游额外计费；默认会过滤。</div>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="disable_store" value="1" id="policy_disable_store_{{$ch.ID}}" {{if $ch.DisableStore}}checked{{end}} />
                              <label class="form-check-label" for="policy_disable_store_{{$ch.ID}}">禁用透传 <code>store</code></label>
                              <div class="form-text small text-muted">涉及数据存储授权；默认允许透传。</div>
                            </div>
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="allow_safety_identifier" value="1" id="policy_safety_identifier_{{$ch.ID}}" {{if $ch.AllowSafetyIdentifier}}checked{{end}} />
                              <label class="form-check-label" for="policy_safety_identifier_{{$ch.ID}}">允许透传 <code>safety_identifier</code></label>
                              <div class="form-text small text-muted">可能暴露用户信息；默认会过滤。</div>
                            </div>
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-save-line me-1"></i>保存策略
                          </button>
                        </form>
                      </div>
                    </div>

	                  <!-- 参数改写 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseParamOverride-{{.Channel.ID}}">参数改写</div>
	                    </div>
	                    <div class="card-body">
	                        <form method="POST" action="/admin/channels/{{.Channel.ID}}/param_override" data-ajax="1" data-ajax-reload="1">
	                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                          <input type="hidden" name="return_to" value="/admin/channels" />
                          <textarea name="param_override" class="form-control font-monospace" rows="10" placeholder='{"operations":[{"path":"metadata.channel","mode":"set","value":"example"}]}'>{{.Channel.ParamOverride}}</textarea>
                          <div class="form-text small text-muted mt-2">
                            留空表示禁用。JSON 必须为对象（new-api 兼容格式），会在转发前按渠道应用。
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-save-line me-1"></i>保存改写
                          </button>
                        </form>
                      </div>
                    </div>

	                  <!-- Header Override -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseHeaderOverride-{{.Channel.ID}}">Header Override</div>
	                    </div>
	                    <div class="card-body">
	                        <form method="POST" action="/admin/channels/{{.Channel.ID}}/header_override" data-ajax="1" data-ajax-reload="1">
	                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                          <input type="hidden" name="return_to" value="/admin/channels" />
                          <textarea name="header_override" class="form-control font-monospace" rows="10" placeholder='{"OpenAI-Organization":"org_xxx","X-Proxy-Key":"{api_key}"}'>{{.Channel.HeaderOverride}}</textarea>
                          <div class="form-text small text-muted mt-2">
                            留空表示禁用。JSON 必须为对象，value 必须为字符串；支持变量 <code>{api_key}</code>（会替换为该渠道实际使用的上游 key/token）。
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-save-line me-1"></i>保存
                          </button>
                        </form>
                      </div>
                    </div>

	                  <!-- 模型后缀保护名单 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseModelSuffix-{{.Channel.ID}}">模型后缀保护名单</div>
	                    </div>
	                    <div class="card-body">
	                        <form method="POST" action="/admin/channels/{{.Channel.ID}}/model_suffix_preserve" data-ajax="1" data-ajax-reload="1">
	                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                          <input type="hidden" name="return_to" value="/admin/channels" />
                          <textarea name="model_suffix_preserve" class="form-control font-monospace" rows="6" placeholder='["o1-mini-high","gpt-5-mini-high"]'>{{.Channel.ModelSuffixPreserve}}</textarea>
                          <div class="form-text small text-muted mt-2">
                            留空表示禁用。JSON 必须为数组；命中时跳过模型后缀解析（<code>-low/-medium/-high/-minimal/-none/-xhigh</code>）。
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-save-line me-1"></i>保存
                          </button>
                        </form>
                      </div>
                    </div>

	                  <!-- 请求体黑白名单 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseBodyFilters-{{.Channel.ID}}">请求体黑白名单</div>
	                    </div>
	                    <div class="card-body">
	                        <div class="row g-3">
	                          <div class="col-12 col-lg-6">
	                            <form method="POST" action="/admin/channels/{{.Channel.ID}}/request_body_whitelist" data-ajax="1" data-ajax-reload="1">
	                              <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                              <input type="hidden" name="return_to" value="/admin/channels" />
                              <label class="form-label fw-medium mb-1">白名单（仅保留）</label>
                              <textarea name="request_body_whitelist" class="form-control font-monospace" rows="8" placeholder='["model","input","max_output_tokens","metadata.channel"]'>{{.Channel.RequestBodyWhitelist}}</textarea>
                              <div class="form-text small text-muted mt-2">
                                留空表示禁用。JSON 必须为数组，每项为 JSON path（gjson/sjson 语法）；启用后会先“仅保留白名单字段”，再应用黑名单与参数改写。
                              </div>
                              <button type="submit" class="btn btn-primary btn-sm mt-3">
                                <i class="ri-save-line me-1"></i>保存白名单
                              </button>
                            </form>
                          </div>
                          <div class="col-12 col-lg-6">
                            <form method="POST" action="/admin/channels/{{.Channel.ID}}/request_body_blacklist" data-ajax="1" data-ajax-reload="1">
                              <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                              <input type="hidden" name="return_to" value="/admin/channels" />
                              <label class="form-label fw-medium mb-1">黑名单（删除字段）</label>
                              <textarea name="request_body_blacklist" class="form-control font-monospace" rows="8" placeholder='["metadata.sensitive","user","store"]'>{{.Channel.RequestBodyBlacklist}}</textarea>
                              <div class="form-text small text-muted mt-2">
                                留空表示禁用。JSON 必须为数组，每项为 JSON path（gjson/sjson 语法）；会在每次 selection 转发前按渠道应用。
                              </div>
                              <button type="submit" class="btn btn-primary btn-sm mt-3">
                                <i class="ri-save-line me-1"></i>保存黑名单
                              </button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>

	                  <!-- 状态码映射 -->
	                  <div class="card border-0 shadow-sm">
	                    <div class="card-header bg-white fw-bold py-3">
	                      <div id="channelSettingsCollapseStatusCode-{{.Channel.ID}}">状态码映射</div>
	                    </div>
	                    <div class="card-body">
	                        <form method="POST" action="/admin/channels/{{.Channel.ID}}/status_code_mapping" data-ajax="1" data-ajax-reload="1">
	                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                          <input type="hidden" name="return_to" value="/admin/channels" />
                          <textarea name="status_code_mapping" class="form-control font-monospace" rows="6" placeholder='{"401":"200","429":"200"}'>{{.Channel.StatusCodeMapping}}</textarea>
                          <div class="form-text small text-muted mt-2">
                            留空表示禁用。仅影响对下游返回的 HTTP 状态码，不影响内部 failover 判定与日志/用量记录。
                          </div>
                          <button type="submit" class="btn btn-primary btn-sm mt-3">
                            <i class="ri-save-line me-1"></i>保存
                          </button>
                        </form>
                      </div>
                    </div>

	                  <!-- 删除 -->
	                  <div class="card border-danger border-opacity-25 shadow-sm">
	                    <div class="card-header bg-danger bg-opacity-10 text-danger fw-bold py-3">
	                      <div id="channelSettingsCollapseDanger-{{.Channel.ID}}">危险操作</div>
	                    </div>
	                    <div class="card-body">
	                        {{if ne .Channel.Type "codex_oauth"}}
	                        <form method="POST" action="/admin/channels/{{.Channel.ID}}/delete" data-ajax="1" data-ajax-reload="1" onsubmit="return confirm('确认删除渠道 {{.Channel.Name}}? 此操作不可撤销。')">
	                          <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                          <div class="form-text small text-muted mb-2">
                            删除会移除该渠道及其端点/密钥关联；请确认无业务在使用。
                          </div>
                          <button class="btn btn-sm btn-danger" type="submit">
                            <i class="ri-delete-bin-line me-1"></i>删除渠道
                          </button>
                        </form>
                        {{else}}
                        <div class="alert alert-light border small mb-0">内置渠道不可删除。</div>
                        {{end}}
                      </div>
                    </div>
                </div>
              </div>
              <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">关闭</button>
              </div>
	            </div>
	          </div>
	        </div></td></tr>
	        {{end}}
	      </tbody>
	    </table>
	  </div>
</div>

<!-- 创建渠道弹窗 -->
<div class="modal fade" id="createChannelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold">创建新渠道</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/channels" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body pt-4">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
          
          <div class="mb-3">
            <label class="form-label fw-medium">渠道名称</label>
            <input name="name" type="text" class="form-control" required placeholder="例如：OpenAI 官方" />
          </div>

          <div class="mb-3">
            <label class="form-label fw-medium">渠道类型</label>
            <select class="form-select" name="type" id="create_channel_type" required>
              <option value="openai_compatible" selected>openai_compatible</option>
              <option value="anthropic">anthropic</option>
            </select>
            <div class="form-text small text-muted" id="create_channel_type_help"><i class="ri-information-line me-1"></i>标准 OpenAI 兼容接口。</div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-medium">分组</label>
            <div class="card p-2" style="max-height: 200px; overflow-y: auto;">
              {{range .ChannelGroups}}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="groups" value="{{.Name}}" id="group_create_{{.Name}}" 
                        {{if eq .Name "default"}}checked{{end}} 
                        {{if ne .Status 1}}disabled{{end}}>
                  <label class="form-check-label w-100" for="group_create_{{.Name}}">
                    {{.Name}} {{if ne .Status 1}}<span class="badge bg-secondary ms-1" style="font-size: 0.7em;">禁用</span>{{end}}
                  </label>
                </div>
              {{end}}
            </div>
            <div class="form-text small text-muted">渠道可属于多个分组。</div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-medium">接口基础地址</label>
            <input name="base_url" type="url" class="form-control" id="create_channel_base_url" required placeholder="https://api.openai.com" />
            <div class="form-text small text-muted">必须是有效的公开 URL。默认禁止私有网络地址。</div>
          </div>

          <div class="row g-3">
            <div class="col-6">
              <label class="form-label fw-medium">优先级</label>
              <input name="priority" type="number" class="form-control" value="0" />
            </div>
            <div class="col-6">
              <label class="form-label fw-medium">推荐状态</label>
              <select name="promotion" class="form-select">
                <option value="0">普通</option>
                <option value="1">推荐</option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-medium mb-1">请求字段策略（可选）</label>
            <div class="d-flex flex-column gap-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="allow_service_tier" value="1" id="create_allow_service_tier" />
                <label class="form-check-label" for="create_allow_service_tier">允许透传 <code>service_tier</code></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="disable_store" value="1" id="create_disable_store" />
                <label class="form-check-label" for="create_disable_store">禁用透传 <code>store</code></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="allow_safety_identifier" value="1" id="create_allow_safety_identifier" />
                <label class="form-check-label" for="create_allow_safety_identifier">允许透传 <code>safety_identifier</code></label>
              </div>
            </div>
            <div class="form-text small text-muted">默认过滤 <code>service_tier</code> / <code>safety_identifier</code>，默认允许透传 <code>store</code>。</div>
          </div>
        </div>
        <div class="modal-footer border-top-0 pt-0 pb-4 pe-4">
          <button type="button" class="btn btn-light text-muted" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary px-4">创建渠道</button>
        </div>
      </form>
    </div>
  </div>
</div>

	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
	<script>
	  document.addEventListener('DOMContentLoaded', function () {
	    // 初始化 Tooltip
	    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
	    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
	      return new bootstrap.Tooltip(tooltipTriggerEl)
	    })

	    var channelSettingsReopenKey = 'rlm_admin_channels_reopen_settings'

	    function getCurrentCSRFToken() {
	      try {
	        var el = document.querySelector('input[name="_csrf"]')
	        return el ? (el.value || '').trim() : ''
	      } catch (e) {
	        return ''
	      }
	    }

	    function channelIDFromModalEl(modalEl) {
	      if (!modalEl || !modalEl.id) return ''
	      var m = modalEl.id.match(/^channelSettingsModal-(\d+)$/)
	      return m ? m[1] : ''
	    }

	    function collapseIDFromHash(channelID, hash) {
	      if (!channelID) return ''
	      if (!hash) return ''
	      if (hash === '#keys') return 'channelSettingsCollapseKeys-' + channelID
	      if (hash === '#accounts') return 'channelSettingsCollapseAccounts-' + channelID
	      if (hash === '#models') return 'channelSettingsCollapseModels-' + channelID
	      if (hash === '#groups') return 'channelSettingsCollapseGroups-' + channelID
	      return ''
	    }

		    function showCollapseByID(collapseID) {
		      var el = document.getElementById(collapseID)
		      if (!el) return false
		      try {
		        if (el.classList && el.classList.contains('collapse')) {
		          bootstrap.Collapse.getOrCreateInstance(el, { toggle: false }).show()
		        }
		        el.scrollIntoView({ block: 'start', behavior: 'smooth' })
		        return true
		      } catch (e) {
		        return false
		      }
		    }

	    function openChannelSettings(channelID, hash) {
	      var modalEl = document.getElementById('channelSettingsModal-' + channelID)
	      if (!modalEl) return false

	      var collapseID = collapseIDFromHash(channelID, (hash || '').trim())
	      if (collapseID) {
	        var onShown = function () {
	          try { modalEl.removeEventListener('shown.bs.modal', onShown) } catch (e) {}
	          showCollapseByID(collapseID)
	        }
	        modalEl.addEventListener('shown.bs.modal', onShown)
	      }

	      try {
	        bootstrap.Modal.getOrCreateInstance(modalEl).show()
	        return true
	      } catch (e) {
	        return false
	      }
	    }

	    // 创建渠道：根据类型切换默认 base_url
	    var typeSelect = document.getElementById('create_channel_type')
	    var baseURLInput = document.getElementById('create_channel_base_url')
	    var typeHelp = document.getElementById('create_channel_type_help')
    if (typeSelect && baseURLInput) {
      var applyChannelType = function () {
        var typ = typeSelect.value
        if (typ === 'anthropic') {
          baseURLInput.placeholder = 'https://api.anthropic.com'
          if (!baseURLInput.value) baseURLInput.value = 'https://api.anthropic.com'
          if (typeHelp) typeHelp.innerHTML = '<i class="ri-information-line me-1"></i>Anthropic Messages 兼容接口（/v1/messages）。'
        } else {
          baseURLInput.placeholder = 'https://api.openai.com'
          if (!baseURLInput.value) baseURLInput.value = 'https://api.openai.com'
          if (typeHelp) typeHelp.innerHTML = '<i class="ri-information-line me-1"></i>标准 OpenAI 兼容接口。'
        }
      }
	      typeSelect.addEventListener('change', applyChannelType)
	      applyChannelType()
	    }

		    // 点击快捷入口：定位到指定分区
		    document.addEventListener('click', function (e) {
		      try {
		        var trigger = e.target && e.target.closest ? e.target.closest('[data-rlm-open-collapse]') : null
		        if (!trigger) return
	        var collapseID = (trigger.getAttribute('data-rlm-open-collapse') || '').trim()
	        if (!collapseID) return
	        e.preventDefault()
	        showCollapseByID(collapseID)
	      } catch (e) {}
	    }, false)

	    // 记录“提交后需要重新打开的弹窗与分区”（支持 ajax reload 与普通 redirect）
	    document.addEventListener('submit', function (e) {
	      try {
	        var form = e.target
	        if (!(form instanceof HTMLFormElement)) return

	        var hash = ''
	        if (e.submitter && e.submitter.getAttribute) {
	          hash = (e.submitter.getAttribute('data-rlm-reopen-hash') || '').trim()
	        }
	        if (!hash) {
	          hash = (form.getAttribute('data-rlm-reopen-hash') || '').trim()
	        }
	        if (!hash) return
	        if (hash.charAt(0) !== '#') hash = '#' + hash

	        var modalEl = form.closest ? form.closest('.modal[id^="channelSettingsModal-"]') : null
	        if (!modalEl) return
	        var channelID = channelIDFromModalEl(modalEl)
	        if (!channelID) return

	        sessionStorage.setItem(channelSettingsReopenKey, JSON.stringify({ channel_id: channelID, hash: hash }))
	      } catch (e) {}
	    }, true)

	    // 批量注册（Codex OAuth）：启动任务 + SSE 进度
	    var batchEventSources = {}
	    function closeBatchEventSource(channelID) {
	      try {
	        if (batchEventSources[channelID]) {
	          batchEventSources[channelID].close()
	          delete batchEventSources[channelID]
	        }
	      } catch (e) {}
	    }

	    function setBatchError(channelID, msg) {
	      var el = document.getElementById('codexBatchRegisterErr-' + channelID)
	      if (!el) return
	      if (msg) {
	        el.textContent = msg
	        el.classList.remove('d-none')
	      } else {
	        el.textContent = ''
	        el.classList.add('d-none')
	      }
	    }

	    function appendBatchLog(channelID, message) {
	      var container = document.getElementById('codexBatchLogContainer-' + channelID)
	      if (!container) return
	      var line = document.createElement('div')
	      line.className = 'mb-1'
	      line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + (message || '')
	      container.appendChild(line)
	      container.scrollTop = container.scrollHeight
	    }

	    function updateBatchProgress(channelID, current, total, status) {
	      var pct = 0
	      if (total > 0) pct = Math.round((current / total) * 100)
	      if (pct < 0) pct = 0
	      if (pct > 100) pct = 100

	      var bar = document.getElementById('codexBatchProgressBar-' + channelID)
	      if (bar) bar.style.width = pct + '%'

	      var text = document.getElementById('codexBatchProgressText-' + channelID)
	      if (text) text.textContent = String(current) + '/' + String(total)

	      var st = document.getElementById('codexBatchCurrentStatus-' + channelID)
	      if (st) st.textContent = status || '处理中...'
	    }

	    function subscribeBatchProgress(channelID, taskID) {
	      closeBatchEventSource(channelID)
	      var es = new EventSource('/admin/batch-register-progress/' + encodeURIComponent(taskID))
	      batchEventSources[channelID] = es

	      es.addEventListener('progress', function (evt) {
	        try {
	          var data = JSON.parse(evt.data || '{}')
	          updateBatchProgress(channelID, data.current_index || 0, data.total_count || 0, data.current_status || '')
	        } catch (e) {}
	      })

	      es.addEventListener('log', function (evt) {
	        try {
	          var data = JSON.parse(evt.data || '{}')
	          appendBatchLog(channelID, data.message || '')
	        } catch (e) {}
	      })

	      es.addEventListener('complete', function (evt) {
	        var status = ''
	        try {
	          var data = JSON.parse(evt.data || '{}')
	          status = (data.status || '').toString()
	        } catch (e) {}

	        if (status === 'failed') {
	          appendBatchLog(channelID, '❌ 任务失败')
	        } else if (status === 'cancelled') {
	          appendBatchLog(channelID, '⚠️ 任务已取消')
	        } else {
	          appendBatchLog(channelID, '✅ 任务完成')
	        }

	        var st = document.getElementById('codexBatchCurrentStatus-' + channelID)
	        if (st) {
	          var html = '<span class="text-success fw-bold">已完成</span>'
	          if (status === 'failed') html = '<span class="text-danger fw-bold">已失败</span>'
	          if (status === 'cancelled') html = '<span class="text-warning fw-bold">已取消</span>'
	          st.innerHTML = html
	        }

	        var closeBtn = document.getElementById('codexBatchCloseProgressBtn-' + channelID)
	        if (closeBtn) closeBtn.disabled = false
	        closeBatchEventSource(channelID)

	        // 成功时自动刷新页面以展示最新账号状态（并重新打开当前渠道的账号分区）
	        if (status !== 'failed' && status !== 'cancelled') {
	          try {
	            sessionStorage.setItem(channelSettingsReopenKey, JSON.stringify({ channel_id: channelID, hash: '#accounts' }))
	          } catch (e) {}
	          window.setTimeout(function () { window.location.reload() }, 3000)
	        }
	      })

	      es.onerror = function () {
	        appendBatchLog(channelID, '⚠️ 连接中断，尝试重连...')
	        window.setTimeout(function () {
	          var closeBtn = document.getElementById('codexBatchCloseProgressBtn-' + channelID)
	          if (closeBtn && closeBtn.disabled) subscribeBatchProgress(channelID, taskID)
	        }, 2000)
	      }
	    }

	    document.addEventListener('click', function (e) {
	      var btn = e.target && e.target.closest ? e.target.closest('[data-rlm-start-batch-register]') : null
	      if (!btn) return
	      e.preventDefault()

	      var channelID = (btn.getAttribute('data-rlm-start-batch-register') || '').trim()
	      if (!channelID) return

	      setBatchError(channelID, '')

	      var countEl = document.getElementById('codexBatchCount-' + channelID)
	      var workerDomainEl = document.getElementById('codexWorkerDomain-' + channelID)
	      var adminTokenEl = document.getElementById('codexAdminToken-' + channelID)
	      var crsApiBaseEl = document.getElementById('codexCrsApiBase-' + channelID)
	      var crsAdminTokenEl = document.getElementById('codexCrsAdminToken-' + channelID)
	      var enableTeamInviteEl = document.getElementById('codexEnableTeamInvite-' + channelID)

	      var count = parseInt((countEl && countEl.value) || '0', 10)
	      var workerDomain = ((workerDomainEl && workerDomainEl.value) || '').trim()
	      var adminToken = ((adminTokenEl && adminTokenEl.value) || '').trim()
	      var crsApiBase = ((crsApiBaseEl && crsApiBaseEl.value) || '').trim()
	      var crsAdminToken = ((crsAdminTokenEl && crsAdminTokenEl.value) || '').trim()
	      var enableTeamInvite = !!(enableTeamInviteEl && enableTeamInviteEl.checked)

	      if (!count || count < 1 || count > 10) {
	        setBatchError(channelID, '注册数量必须在 1-10 之间')
	        return
	      }
	      if (!workerDomain || !adminToken) {
	        setBatchError(channelID, 'Worker Domain 和 Admin Token 不能为空')
	        return
	      }

	      var progressModalEl = document.getElementById('codexBatchProgressModal-' + channelID)
	      if (!progressModalEl) {
	        setBatchError(channelID, '进度弹窗未找到')
	        return
	      }
	      var progressModal = bootstrap.Modal.getOrCreateInstance(progressModalEl)

	      // 重置进度 UI
	      var bar = document.getElementById('codexBatchProgressBar-' + channelID)
	      if (bar) bar.style.width = '0%'
	      var text = document.getElementById('codexBatchProgressText-' + channelID)
	      if (text) text.textContent = '0/' + String(count)
	      var st = document.getElementById('codexBatchCurrentStatus-' + channelID)
	      if (st) st.textContent = '正在启动...'
	      var logContainer = document.getElementById('codexBatchLogContainer-' + channelID)
	      if (logContainer) logContainer.innerHTML = ''
	      var closeBtn = document.getElementById('codexBatchCloseProgressBtn-' + channelID)
	      if (closeBtn) {
	        closeBtn.disabled = true
	        closeBtn.onclick = function () {
	          try {
	            progressModal.hide()
	          } catch (e) {}
	        }
	      }

	      progressModal.show()

	      fetch('/admin/batch-register', {
	        method: 'POST',
	        headers: {
	          'Content-Type': 'application/json',
	          'X-CSRF-Token': getCurrentCSRFToken()
	        },
	        credentials: 'same-origin',
	        body: JSON.stringify({
	          count: count,
	          worker_domain: workerDomain,
	          admin_token: adminToken,
	          crs_api_base: crsApiBase,
	          crs_admin_token: crsAdminToken,
	          enable_team_invite: enableTeamInvite
	        })
	      })
	      .then(function (resp) {
	        return resp.text().then(function (txt) {
	          var data = null
	          try { data = JSON.parse(txt || '{}') } catch (e) {}
	          return { ok: resp.ok, status: resp.status, data: data, text: txt }
	        })
	      })
	      .then(function (res) {
	        if (!res.ok) {
	          appendBatchLog(channelID, '❌ 启动失败（HTTP ' + res.status + '）')
	          if (res.data && res.data.error) appendBatchLog(channelID, String(res.data.error))
	          if (closeBtn) closeBtn.disabled = false
	          return
	        }
	        if (res.data && res.data.task_id) {
	          subscribeBatchProgress(channelID, res.data.task_id)
	          return
	        }
	        appendBatchLog(channelID, '❌ 启动失败: ' + (res.text || 'unknown'))
	        if (closeBtn) closeBtn.disabled = false
	      })
	      .catch(function (err) {
	        appendBatchLog(channelID, '❌ 请求失败: ' + err)
	        if (closeBtn) closeBtn.disabled = false
	      })
	    }, false)

	    // 页面加载后：支持通过 query 或 sessionStorage 自动打开弹窗并定位分区
	    ;(function () {
	      try {
	        var params = new URLSearchParams(window.location.search || '')
	        var channelID = (params.get('open_channel_settings') || '').trim()
	        var hash = (window.location.hash || '').trim()
	        if (!channelID) {
	          var raw = sessionStorage.getItem(channelSettingsReopenKey) || ''
	          if (raw) {
	            var state = JSON.parse(raw)
	            if (state && state.channel_id) channelID = String(state.channel_id)
	            if (state && state.hash) hash = String(state.hash)
	          }
	          sessionStorage.removeItem(channelSettingsReopenKey)
	        }
	        if (channelID) openChannelSettings(channelID, hash)
	      } catch (e) {}
	    })()

	    // 初始化 Sortable
	    var el = document.getElementById('channels-table-body');
			    if (el) {
			        Sortable.create(el, {
			            handle: '.drag-handle-cell',
		            draggable: 'tr[data-id]',
		            animation: 150,
		            ghostClass: 'bg-light',
		            onEnd: function (evt) {
	                var ids = [];
	                el.querySelectorAll('tr[data-id]').forEach(function (row) {
	                    var id = row.getAttribute('data-id');
	                    if (id) {
	                        ids.push(parseInt(id));
	                    }
                });

                // 将新顺序提交到服务端
                fetch('/admin/channels/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '{{$.CSRFToken}}'
                    },
                    body: JSON.stringify(ids)
                }).then(response => {
                    if (response.ok) {
                        // 刷新页面以展示新的优先级顺序
                        window.location.reload();
                    } else {
                        alert('保存排序失败，请重试');
                    }
                }).catch(err => {
                    console.error('错误:', err);
                    alert('网络请求失败');
                });
            }
        });
    }
  });
</script>
{{end}}
