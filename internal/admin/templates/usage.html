{{define "admin_usage"}}
<!-- 引入 Flatpickr 样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

<!-- 页面顶栏：标题 + 全局筛选 (Realms 风格) -->
<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4 gap-3">
  <div>
    <div class="d-flex align-items-center mb-1">
      <h4 class="fw-bold mb-0 text-dark">全站用量统计</h4>
      <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 ms-2 small fw-normal">实时监控</span>
    </div>
    <p class="text-muted smaller mb-0">系统级数据汇总，涵盖所有用户及上游通道。</p>
  </div>

  <!-- 全局筛选胶囊 -->
  <div class="d-flex align-items-center bg-white border border-opacity-75 rounded-pill p-1 shadow-sm">
    <div class="d-flex align-items-center px-3 border-end border-opacity-10">
      <i class="ri-calendar-2-line text-primary me-2"></i>
      <input type="text" id="dateStart" class="form-control form-control-sm border-0 bg-transparent p-0 mb-0 fw-medium" style="width: 85px; font-size: 0.85rem;" value="{{.UsageStart}}">
      <span class="mx-2 text-muted opacity-25">|</span>
      <input type="text" id="dateEnd" class="form-control form-control-sm border-0 bg-transparent p-0 mb-0 fw-medium" style="width: 85px; font-size: 0.85rem;" value="{{.UsageEnd}}">
    </div>

    <div class="d-none d-lg-flex gap-1 px-2 border-end border-opacity-10">
      <button type="button" class="btn btn-sm rounded-pill text-muted px-2 mb-0 quick-range-btn" style="font-size: 0.75rem; background: transparent;" data-days="0" onclick="setQuickRange(0, this)">今天</button>
      <button type="button" class="btn btn-sm rounded-pill text-muted px-2 mb-0 quick-range-btn" style="font-size: 0.75rem; background: transparent;" data-days="1" onclick="setQuickRange(1, this)">昨天</button>
      <button type="button" class="btn btn-sm rounded-pill text-muted px-2 mb-0 quick-range-btn" style="font-size: 0.75rem; background: transparent;" data-days="7" onclick="setQuickRange(7, this)">7天</button>
      <button type="button" class="btn btn-sm rounded-pill text-muted px-2 mb-0 quick-range-btn" style="font-size: 0.75rem; background: transparent;" data-days="30" onclick="setQuickRange(30, this)">30天</button>
    </div>

    <form class="d-flex align-items-center gap-2 ps-2 pe-1 mb-0" method="GET" action="/admin/usage" id="usageFilterForm">
      <input type="hidden" name="start" id="hiddenStart" value="{{.UsageStart}}">
      <input type="hidden" name="end" id="hiddenEnd" value="{{.UsageEnd}}">
      <select name="limit" class="form-select form-select-sm border-0 bg-transparent pe-4 mb-0 text-muted" style="width: auto; font-size: 0.85rem; box-shadow: none;">
        <option value="20" {{if eq .UsageLimit 20}}selected{{end}}>20条</option>
        <option value="50" {{if eq .UsageLimit 50}}selected{{end}}>50条</option>
        <option value="100" {{if eq .UsageLimit 100}}selected{{end}}>100条</option>
      </select>
      <button type="submit" class="btn btn-sm btn-primary rounded-pill px-3 mb-0 shadow-sm">
        <i class="ri-search-2-line"></i>
      </button>
    </form>
  </div>
</div>

<div class="row g-4">
  
  {{with index .UsageWins 0}}
  <div class="col-12">
    <div class="card shadow-sm border-0 overflow-hidden mb-4 p-0">
      <!-- 顶部信息条 -->
      <div class="bg-primary bg-opacity-10 py-3 px-4 d-flex justify-content-between align-items-center">
        <div>
           <span class="text-primary fw-bold text-uppercase small">{{.Window}}</span>
           <span class="text-primary text-opacity-75 smaller ms-2">统计区间: {{.Since}} ~ {{.Until}}</span>
        </div>
        <div class="text-primary text-opacity-75 smaller">
           <i class="ri-shield-check-line me-1"></i> 实时统计数据
        </div>
      </div>

      <div class="card-body p-4">
        <div class="row g-4">
          <!-- 左侧：费用 -->
          <div class="col-lg-4 border-end">
            <div class="mb-4">
              <div class="text-muted smaller mb-1">总营收流水（USD）</div>
              <h1 class="display-5 fw-bold mb-0 text-dark">{{.TotalUSD}}</h1>
            </div>

            <div class="row g-0 py-3 bg-light rounded-3 px-3">
              <div class="col-6 border-end">
                <div class="text-muted smaller">已结算</div>
                <div class="fw-bold h5 mb-0 text-success">{{.CommittedUSD}}</div>
              </div>
              <div class="col-6 ps-3">
                <div class="text-muted smaller">预留中</div>
                <div class="fw-bold h5 mb-0 text-warning">{{.ReservedUSD}}</div>
              </div>
            </div>
            <div class="mt-3 smaller text-muted">
              <i class="ri-information-line me-1"></i> 预留中费用指尚未结束或结算中的请求估算。
            </div>
          </div>

          <!-- 右侧：详细指标 -->
          <div class="col-lg-8 ps-lg-4">
            <div class="row g-3">
              <!-- 指标网格 -->
              <div class="col-sm-6 col-md-3">
                <div class="metric-card p-3 rounded-3 border">
                  <div class="text-muted smaller mb-1">全局请求数</div>
                  <div class="h4 fw-bold mb-1">{{.Requests}}</div>
                  <div class="text-primary smaller fw-medium">{{.RPM}} RPM</div>
                </div>
              </div>
              <div class="col-sm-6 col-md-3">
                <div class="metric-card p-3 rounded-3 border">
                  <div class="text-muted smaller mb-1">Token 吞吐</div>
                  <div class="h4 fw-bold mb-1">{{.Tokens}}</div>
                  <div class="text-primary smaller fw-medium">{{.TPM}} TPM</div>
                </div>
              </div>
              <div class="col-sm-6 col-md-3">
                <div class="metric-card p-3 rounded-3 border">
                  <div class="text-muted smaller mb-1">全局缓存比</div>
                  <div class="h4 fw-bold mb-1 text-success">{{.CacheRatio}}</div>
                  <div class="text-success smaller fw-medium">系统优化率</div>
                </div>
              </div>
              <div class="col-sm-6 col-md-3">
                <div class="metric-card p-3 rounded-3 border">
                  <div class="text-muted smaller mb-1">缓存 Token</div>
                  <div class="h4 fw-bold mb-1">{{.CachedTokens}}</div>
                  <div class="text-muted smaller fw-medium">输入 + 输出</div>
                </div>
              </div>

              <!-- 次级明细 -->
              <div class="col-12 mt-3">
                 <div class="bg-light p-3 rounded-3">
                   <div class="row text-center small">
                     <div class="col-6 border-end">
                        <div class="text-muted smaller">输入总计</div>
                        <div class="fw-medium">{{.InputTokens}}</div>
                     </div>
                     <div class="col-6">
                        <div class="text-muted smaller">输出总计</div>
                        <div class="fw-medium">{{.OutputTokens}}</div>
                     </div>
                   </div>
                 </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {{end}}

  <!-- 用户排行 -->
  <div class="col-12">
      <div class="card shadow-sm border-0 p-0 overflow-hidden">
      <div class="card-header bg-white py-3 border-bottom-0 px-4">
        <h5 class="mb-0 fw-bold"><i class="ri-group-line me-2"></i>消费排行用户（统计区间）</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 border-0">
            <thead class="bg-light text-muted smaller uppercase">
              <tr>
                <th class="ps-4 border-0">用户</th>
                <th class="border-0">状态</th>
                <th class="text-end border-0">已结算费用</th>
                <th class="text-end pe-4 border-0">预留中</th>
              </tr>
            </thead>
            <tbody>
              {{range .UsageTop}}
              <tr>
                <td class="ps-4">
                  <div class="d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; font-size: 0.8rem;">
                      {{printf "%.1s" .Email}}
                    </div>
                    <div>
                      <div class="fw-bold small">{{.Email}}</div>
                      <div class="text-muted smaller">{{.Role}}</div>
                    </div>
                  </div>
                </td>
                <td>
                  {{if eq .Status 1}}
                    <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-2">正常</span>
                  {{else}}
                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-2">禁用</span>
                  {{end}}
                </td>
                <td class="text-end font-monospace small fw-bold text-dark">{{.CommittedUSD}}</td>
                <td class="text-end font-monospace small text-muted pe-4">{{.ReservedUSD}}</td>
              </tr>
              {{end}}
              {{if not .UsageTop}}
              <tr>
                <td colspan="4" class="text-center py-5 text-muted small">暂无用户用量数据</td>
              </tr>
              {{end}}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 请求明细 -->
  <div class="col-12">
    <div class="card shadow-sm border-0 p-0 overflow-hidden">
      <div class="card-header bg-white py-3 border-bottom-0 px-4">
        <h5 class="mb-0 fw-bold"><i class="ri-list-check-2 me-2"></i>请求明细</h5>
      </div>
      
      <div class="card-body p-0 border-top">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 border-0">
            <thead class="bg-light text-muted smaller uppercase">
              <tr>
                <th class="ps-4 border-0">时间</th>
                <th class="border-0">用户</th>
                <th class="border-0">接口 / 模型</th>
                <th class="text-center border-0">状态码</th>
                <th class="text-end border-0">耗时</th>
                <th class="text-end border-0">Tokens (In/Out/Cache)</th>
                <th class="text-end border-0">费用</th>
                <th class="text-center border-0">状态</th>
                <th class="text-center border-0">渠道</th>
                <th class="pe-4 border-0">Request ID</th>
              </tr>
            </thead>
            <tbody class="small" id="rlmAdminUsageEvents">
              {{range .UsageEvents}}
              <tr class="rlm-usage-row" role="button" data-bs-toggle="collapse" data-bs-target="#rlmAdminUsageDetail{{.ID}}" aria-expanded="false" aria-controls="rlmAdminUsageDetail{{.ID}}">
                <td class="ps-4 text-nowrap font-monospace">
                  <i class="ri-arrow-right-s-line text-muted rlm-usage-chevron me-1 align-middle"></i>
                  <span class="align-middle">{{.Time}}</span>
                </td>
                <td class="text-nowrap">
                  <div class="fw-bold small">{{.UserEmail}}</div>
                  <div class="text-muted smaller">ID: {{.UserID}}</div>
                </td>
                <td class="text-nowrap">
                  <div class="badge bg-light text-dark border fw-normal">{{.Model}}</div>
                  <div class="text-muted smaller mt-1 font-monospace">{{.Endpoint}}</div>
                </td>
                <td class="text-center">
                  {{if eq .StatusCode "200"}}
                    <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">200</span>
                  {{else}}
                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill">{{.StatusCode}}</span>
                  {{end}}
                </td>
                <td class="text-end font-monospace text-muted">{{.LatencyMS}} ms</td>
                <td class="text-end font-monospace">
                   <div><span class="text-muted">In:</span> {{.InputTokens}}</div>
                   <div><span class="text-muted">Out:</span> {{.OutputTokens}}</div>
                   {{if ne .CachedTokens "-"}}
                   <div class="text-success smaller"><i class="ri-flashlight-fill"></i> {{.CachedTokens}}</div>
                   {{end}}
                </td>
                <td class="text-end font-monospace fw-bold text-dark">{{.CostUSD}}</td>
                <td class="text-center text-nowrap">
                   <span class="badge rounded-pill px-2 {{.StateBadgeClass}} mb-1">{{.StateLabel}}</span>
                   {{if .IsStream}}
                     <div class="badge bg-info-subtle text-info border border-info-subtle rounded-pill px-2 scale-90">STREAM</div>
                   {{end}}
                   {{if ne .Error ""}}
                     <div class="text-danger smaller mt-1" title="{{.Error}}"><i class="ri-error-warning-line"></i> 错误</div>
                   {{end}}
                </td>
                <td class="text-center font-monospace text-muted">{{.UpstreamChannelID}}</td>
                <td class="pe-4 font-monospace text-muted small user-select-all" onclick="event.stopPropagation();" style="max-width: 120px; overflow: hidden; text-overflow: ellipsis;" title="{{.RequestID}}">{{.RequestID}}</td>
              </tr>
              <tr class="rlm-usage-detail-row">
                <td colspan="10" class="p-0 border-0">
                  <div class="collapse" id="rlmAdminUsageDetail{{.ID}}" data-bs-parent="#rlmAdminUsageEvents" data-event-id="{{.ID}}">
                    <div class="bg-light border-top px-4 py-3">
                      <div class="row g-3 small">
                        <div class="col-12 col-lg-6">
                          <div class="text-muted smaller">Request ID</div>
                          <div class="font-monospace user-select-all">{{.RequestID}}</div>
                        </div>
                        <div class="col-6 col-lg-3">
                          <div class="text-muted smaller">Event ID</div>
                          <div class="font-monospace">{{.ID}}</div>
                        </div>
                        <div class="col-6 col-lg-3">
                          <div class="text-muted smaller">渠道</div>
                          <div class="font-monospace">{{.UpstreamChannelID}}</div>
                        </div>

                        <div class="col-12 col-lg-6">
                          <div class="text-muted smaller">用户</div>
                          <div class="font-monospace">{{.UserEmail}} (ID: {{.UserID}})</div>
                        </div>
                        <div class="col-12 col-lg-6">
                          <div class="text-muted smaller">Endpoint</div>
                          <div class="font-monospace">{{.Method}} {{.Endpoint}}</div>
                        </div>

                        <div class="col-12 col-lg-6">
                          <div class="text-muted smaller">模型</div>
                          <div class="font-monospace">{{.Model}}</div>
                        </div>
                        <div class="col-6 col-lg-3">
                          <div class="text-muted smaller">状态码</div>
                          <div class="font-monospace">{{.StatusCode}}</div>
                        </div>
                        <div class="col-6 col-lg-3">
                          <div class="text-muted smaller">耗时</div>
                          <div class="font-monospace">{{.LatencyMS}} ms</div>
                        </div>

                        <div class="col-6 col-lg-3">
                          <div class="text-muted smaller">请求/响应大小</div>
                          <div class="font-monospace">{{.RequestBytes}} / {{.ResponseBytes}} bytes</div>
                        </div>
                        <div class="col-6 col-lg-3">
                          <div class="text-muted smaller">费用</div>
                          <div class="font-monospace">{{.CostUSD}}</div>
                        </div>
                        <div class="col-12 col-lg-6">
                          <div class="text-muted smaller">Tokens</div>
                          <div class="font-monospace">In: {{.InputTokens}} / Out: {{.OutputTokens}} / Cache: {{.CachedTokens}}</div>
                        </div>
                        <div class="col-12 col-lg-6">
                          <div class="text-muted smaller">状态</div>
                          <div class="font-monospace">{{.StateLabel}}{{if .IsStream}} · STREAM{{end}}</div>
                        </div>

                        <div class="col-12 col-lg-3">
                          <div class="text-muted smaller">错误类型</div>
                          <div class="font-monospace">{{if .ErrorClass}}{{.ErrorClass}}{{else}}-{{end}}</div>
                        </div>
                        <div class="col-12 col-lg-9">
                          <div class="text-muted smaller">错误信息</div>
                          {{if .ErrorMessage}}
                            <pre class="mb-0 font-monospace rlm-prewrap">{{.ErrorMessage}}</pre>
                          {{else if .Error}}
                            <pre class="mb-0 font-monospace rlm-prewrap">{{.Error}}</pre>
                          {{else}}
                            <div class="text-muted">-</div>
                          {{end}}
                        </div>

                        <div class="col-12">
                          <hr class="my-2">
                          <div class="text-muted smaller">转发请求体（最终）<span class="ms-2">· 仅失败请求会保存</span></div>
                          <pre class="mb-0 font-monospace rlm-prewrap rlm-usage-detail-pre" id="rlmAdminUsageUpReq{{.ID}}">（展开后自动加载）</pre>
                        </div>
                        <div class="col-12">
                          <div class="text-muted smaller">上游响应体</div>
                          <pre class="mb-0 font-monospace rlm-prewrap rlm-usage-detail-pre" id="rlmAdminUsageUpResp{{.ID}}">（展开后自动加载）</pre>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {{end}}
              {{if not .UsageEvents}}
              <tr>
                <td colspan="10" class="text-center py-5 text-muted small">
                  <div class="mb-2"><i class="ri-inbox-line fs-1 text-muted opacity-25"></i></div>
                  暂无请求明细数据
                </td>
              </tr>
              {{end}}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 分页控制 -->
      {{if or .UsageNextBeforeID .UsagePrevAfterID .UsageCursorActive}}
      <div class="card-footer bg-light py-3 px-4">
        <nav aria-label="Usage pagination">
          <ul class="pagination justify-content-center mb-0">
            <!-- 回到最新 (首页) -->
            <li class="page-item {{if not .UsageCursorActive}}disabled{{end}}">
              <a class="page-link" href="/admin/usage?start={{.UsageStart}}&end={{.UsageEnd}}&limit={{.UsageLimit}}" aria-label="First">
                <span aria-hidden="true"><i class="ri-skip-back-line"></i> 最新</span>
              </a>
            </li>
            
            <!-- 上一页 (较新) -> after_id -->
            <li class="page-item {{if not .UsagePrevAfterID}}disabled{{end}}">
              <a class="page-link" href="{{if .UsagePrevAfterID}}/admin/usage?start={{.UsageStart}}&end={{.UsageEnd}}&limit={{.UsageLimit}}&after_id={{.UsagePrevAfterID}}{{else}}#{{end}}">
                <i class="ri-arrow-left-s-line"></i> 上一页
              </a>
            </li>

            <li class="page-item disabled">
               <span class="page-link text-muted border-0 bg-transparent">
                 {{if .UsageCursorActive}}历史数据{{else}}第一页{{end}}
               </span>
            </li>

            <!-- 下一页 (较早) -> before_id -->
            <li class="page-item {{if not .UsageNextBeforeID}}disabled{{end}}">
              <a class="page-link" href="{{if .UsageNextBeforeID}}/admin/usage?start={{.UsageStart}}&end={{.UsageEnd}}&limit={{.UsageLimit}}&before_id={{.UsageNextBeforeID}}{{else}}#{{end}}">
                下一页 <i class="ri-arrow-right-s-line"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
      {{end}}
    </div>
  </div>

</div>

<style>
  .btn-xs { padding: 0.1rem 0.5rem; font-size: 0.75rem; }
  .scale-90 { transform: scale(0.9); transform-origin: center; display: inline-block; }
  .flatpickr-input { background-color: #fff !important; }
  .rlm-usage-row { cursor: pointer; }
  .rlm-usage-chevron { font-size: 18px; transition: transform 0.15s ease; }
  .rlm-usage-row[aria-expanded="true"] .rlm-usage-chevron { transform: rotate(90deg); }
  .rlm-prewrap { white-space: pre-wrap; word-break: break-word; }
  .rlm-usage-detail-pre { max-height: 320px; overflow: auto; background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(0,0,0,0.08); border-radius: 0.5rem; padding: 0.75rem; }

  .quick-range-btn { 
    border: none;
    transition: all 0.2s;
  }
  .quick-range-btn:hover {
    background: rgba(0,0,0,0.03) !important;
    color: var(--bs-primary) !important;
  }
  .quick-range-btn.active {
    background: #fff !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1) !important;
    color: var(--bs-primary) !important;
    font-weight: 600 !important;
  }
</style>

<script>
function syncUsageFilterDatesToHidden() {
  const startInput = document.getElementById('dateStart');
  const endInput = document.getElementById('dateEnd');
  const hiddenStart = document.getElementById('hiddenStart');
  const hiddenEnd = document.getElementById('hiddenEnd');
  if (hiddenStart && startInput) hiddenStart.value = startInput.value;
  if (hiddenEnd && endInput) hiddenEnd.value = endInput.value;
}

function submitUsageFilterForm() {
  const form = document.getElementById('usageFilterForm');
  if (!form) return;
  // 注意：form.submit() 不会触发 submit 事件监听器，所以这里必须显式同步一次。
  syncUsageFilterDatesToHidden();
  form.submit();
}

document.addEventListener("DOMContentLoaded", function() {
  flatpickr("#dateStart", {
    locale: "zh",
    dateFormat: "Y-m-d",
    allowInput: true,
    onChange: function() { updateActiveQuickRange(); }
  });
  flatpickr("#dateEnd", {
    locale: "zh",
    dateFormat: "Y-m-d",
    allowInput: true,
    onChange: function() { updateActiveQuickRange(); }
  });

  // 简单的表单同步逻辑，确保顶部日期控件的值传给 Form
  document.getElementById('usageFilterForm').addEventListener('submit', function() {
    syncUsageFilterDatesToHidden();
  });

  // 用量事件详情：点击展开后拉取请求/响应明细（仅失败请求会保存）。
  document.querySelectorAll('#rlmAdminUsageEvents .collapse[data-event-id]').forEach(function(el) {
    el.addEventListener('shown.bs.collapse', function() {
      const eventID = el.getAttribute('data-event-id');
      if (!eventID) return;
      if (el.getAttribute('data-detail-loaded') === '1') return;
      el.setAttribute('data-detail-loaded', '1');

      const reqEl = document.getElementById('rlmAdminUsageUpReq' + eventID);
      const respEl = document.getElementById('rlmAdminUsageUpResp' + eventID);
      if (reqEl) reqEl.textContent = '加载中...';
      if (respEl) respEl.textContent = '加载中...';

      fetch('/admin/usage/events/' + eventID + '/detail', { headers: { 'Accept': 'application/json' } })
        .then(function(r) {
          if (r.status === 404) return { available: false };
          if (!r.ok) {
            return r.text().then(function(t) {
              throw new Error(t || ('HTTP ' + r.status));
            });
          }
          return r.json();
        })
        .then(function(data) {
          if (!data || !data.available) {
            if (reqEl) reqEl.textContent = '（无明细：仅对失败请求保存，或该条记录未启用存储）';
            if (respEl) respEl.textContent = '-';
            return;
          }
          if (reqEl) reqEl.textContent = data.upstream_request_body || '-';
          if (respEl) respEl.textContent = data.upstream_response_body || '-';
        })
        .catch(function(err) {
          el.setAttribute('data-detail-loaded', '0');
          const msg = (err && err.message) ? err.message : String(err);
          if (reqEl) reqEl.textContent = '加载失败：' + msg;
          if (respEl) respEl.textContent = '-';
        });
    });
  });

  updateActiveQuickRange();
});

function setQuickRange(days, btn) {
  const end = new Date();
  const start = new Date();
  
  if (days === 1) {
      // 昨天
      start.setDate(start.getDate() - 1);
      end.setDate(end.getDate() - 1);
  } else if (days > 1) {
      // 最近N天
      start.setDate(start.getDate() - (days - 1)); // 包含今天
  } else {
      // 今天 (days=0)
      // default
  }

  const fmt = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  };
  
  const startPicker = document.querySelector("#dateStart")._flatpickr;
  const endPicker = document.querySelector("#dateEnd")._flatpickr;
  
  startPicker.setDate(fmt(start));
  endPicker.setDate(fmt(end));

  // Highlight active
  document.querySelectorAll('.quick-range-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  // 一键快捷区间：切换后立即刷新查询结果，避免“日期变了但数据没变”的错觉。
  submitUsageFilterForm();
}

function updateActiveQuickRange() {
  const startVal = document.getElementById('dateStart').value;
  const endVal = document.getElementById('dateEnd').value;
  
  const fmt = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${dd}`;
  };

  document.querySelectorAll('.quick-range-btn').forEach(btn => {
    const days = parseInt(btn.getAttribute('data-days'));
    const expectedEnd = new Date();
    const expectedStart = new Date();
    
    if (days === 1) {
      expectedEnd.setDate(expectedEnd.getDate() - 1);
      expectedStart.setDate(expectedStart.getDate() - 1);
    } else if (days > 1) {
      expectedStart.setDate(expectedStart.getDate() - (days - 1));
    }
    
    if (startVal === fmt(expectedStart) && endVal === fmt(expectedEnd)) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
}
</script>
{{end}}
