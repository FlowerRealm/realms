{{define "admin_channel_group_detail"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-1">渠道组</h2>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb breadcrumb-sm mb-1">
        <li class="breadcrumb-item"><a href="/admin/channel-groups">分组列表</a></li>
        {{range .GroupBreadcrumb}}
          {{if and $.CurrentGroup (eq .ID $.CurrentGroup.ID)}}
            <li class="breadcrumb-item active" aria-current="page">{{.Name}}</li>
          {{else}}
            <li class="breadcrumb-item"><a href="/admin/channel-groups/{{.ID}}">{{.Name}}</a></li>
          {{end}}
        {{end}}
      </ol>
    </nav>
    {{if .CurrentGroup}}
      <p class="text-muted small mb-0">
        <span class="me-2">名称：<code class="bg-light px-2 py-1 rounded border user-select-all">{{.CurrentGroup.Name}}</code></span>
        <span class="me-2">max_attempts：<code class="bg-light px-2 py-1 rounded border user-select-all">{{.CurrentGroup.MaxAttempts}}</code></span>
        <span class="me-2">倍率：<code class="bg-light px-2 py-1 rounded border user-select-all">{{formatMultiplierPlain .CurrentGroup.PriceMultiplier}}</code></span>
      </p>
    {{end}}
  </div>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-light border" data-bs-toggle="modal" data-bs-target="#addChannelToGroupModal">
      <i class="ri-add-line me-1"></i> 添加渠道
    </button>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createChildGroupModal">
      <i class="ri-add-line me-1"></i> 新建子组
    </button>
  </div>
</div>

{{if .Notice}}
<div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{{end}}

{{if .Error}}
<div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
  <i class="ri-alert-line me-2"></i>{{.Error}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{{end}}

<div class="card border-0 shadow-sm mb-4">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th style="width: 60px;" class="text-center text-muted">排序</th>
          <th style="width: 50%;">成员</th>
          <th style="width: 20%;">类型</th>
          <th style="width: 15%;">状态</th>
          <th class="text-end pe-4" style="width: 15%;">操作</th>
        </tr>
      </thead>
      <tbody id="channel-group-members-body">
        {{range .ChannelGroupMembers}}
        <tr data-id="{{.MemberID}}">
          <td class="text-center text-muted drag-handle-cell" style="cursor: move;" title="拖动排序">
            <i class="ri-drag-move-2-line fs-5"></i>
          </td>
          <td>
            {{if .MemberGroupID}}
              <div class="d-flex flex-column">
                <div class="d-flex align-items-center gap-2">
                  <a class="fw-bold text-dark text-decoration-none" href="/admin/channel-groups/{{.MemberGroupID}}">
                    {{if .MemberGroupName}}{{.MemberGroupName}}{{else}}(未命名){{end}}
                  </a>
                  <span class="badge rounded-pill bg-light text-secondary border small" style="font-size: 0.7em;">group</span>
                </div>
                {{if .MemberGroupMaxAttempts}}
                  <div class="text-muted small">max_attempts：{{.MemberGroupMaxAttempts}}</div>
                {{end}}
              </div>
            {{else if .MemberChannelID}}
              <div class="d-flex flex-column">
                <div class="d-flex align-items-center gap-2">
                  <span class="fw-bold text-dark">{{if .MemberChannelName}}{{.MemberChannelName}}{{else}}channel-{{.MemberChannelID}}{{end}}</span>
                  {{if .MemberChannelType}}
                    <span class="badge rounded-pill bg-light text-secondary border small" style="font-size: 0.7em;">{{.MemberChannelType}}</span>
                  {{end}}
                </div>
                {{if .MemberChannelGroups}}
                  <div class="text-muted small">groups：<code class="bg-light px-2 py-1 rounded border user-select-all">{{.MemberChannelGroups}}</code></div>
                {{end}}
              </div>
            {{else}}
              <span class="text-muted small fst-italic">-</span>
            {{end}}
          </td>
          <td>
            {{if .MemberGroupID}}
              <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary px-2">子组</span>
            {{else if .MemberChannelID}}
              <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">渠道</span>
            {{else}}
              <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">未知</span>
            {{end}}
          </td>
          <td>
            {{if .MemberGroupID}}
              {{if and .MemberGroupStatus (eq .MemberGroupStatus 1)}}
                <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">
                  <i class="ri-checkbox-circle-line me-1"></i>启用
                </span>
              {{else}}
                <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">
                  <i class="ri-close-circle-line me-1"></i>禁用
                </span>
              {{end}}
            {{else if .MemberChannelID}}
              {{if and .MemberChannelStatus (eq .MemberChannelStatus 1)}}
                <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">
                  <i class="ri-checkbox-circle-line me-1"></i>启用
                </span>
              {{else}}
                <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">
                  <i class="ri-close-circle-line me-1"></i>禁用
                </span>
              {{end}}
            {{else}}
              <span class="text-muted small">-</span>
            {{end}}
          </td>
          <td class="text-end text-nowrap pe-4">
            <div class="d-flex justify-content-end gap-1">
              {{if .MemberGroupID}}
                <a href="/admin/channel-groups/{{.MemberGroupID}}" class="btn btn-sm btn-light border text-secondary" title="进入">
                  <i class="ri-folder-open-line"></i>
                </a>
                <form method="POST" action="/admin/channel-groups/{{$.CurrentGroup.ID}}/children/groups/{{.MemberGroupID}}/delete" data-ajax="1" data-ajax-reload="1">
                  <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                  <button class="btn btn-sm btn-light border text-danger" type="submit" title="移除" onclick="return confirm('确认从该组移除子组？');">
                    <i class="ri-delete-bin-line"></i>
                  </button>
                </form>
              {{else if .MemberChannelID}}
                <form method="POST" action="/admin/channel-groups/{{$.CurrentGroup.ID}}/children/channels/{{.MemberChannelID}}/delete" data-ajax="1" data-ajax-reload="1">
                  <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                  <button class="btn btn-sm btn-light border text-danger" type="submit" title="移除" onclick="return confirm('确认从该组移除渠道？');">
                    <i class="ri-delete-bin-line"></i>
                  </button>
                </form>
              {{end}}
            </div>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>
</div>

<!-- Create Child Group Modal -->
<div class="modal fade" id="createChildGroupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">新建子组</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="/admin/channel-groups/{{.CurrentGroup.ID}}/children/groups" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

          <div class="mb-3">
            <label class="form-label">分组名称</label>
            <input name="name" type="text" class="form-control" required placeholder="例如：vip" />
            <div class="form-text">仅允许字母/数字及 _ -，最多 64 位。</div>
          </div>

          <div class="mb-3">
            <label class="form-label">描述（可选）</label>
            <input name="description" type="text" class="form-control" placeholder="例如：VIP 用户专用上游" />
            <div class="form-text">最多 255 字符。</div>
          </div>

          <div class="mb-3">
            <label class="form-label">价格倍率</label>
            <div class="input-group">
              <span class="input-group-text">×</span>
              <input name="price_multiplier" type="number" step="0.000001" min="0" class="form-control" required value="1" />
            </div>
            <div class="form-text">最终计费 = 模型单价 × 倍率（最多 6 位小数）。</div>
          </div>

          <div class="mb-3">
            <label class="form-label">组内最大尝试次数</label>
            <input name="max_attempts" type="number" min="1" step="1" class="form-control" required value="5" />
            <div class="form-text">组内成员 failover 尝试上限。</div>
          </div>

          <div class="mb-3">
            <label class="form-label">状态</label>
            <select name="status" class="form-select">
              <option value="1" selected>启用</option>
              <option value="0">禁用</option>
            </select>
          </div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">创建</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Channel Modal -->
<div class="modal fade" id="addChannelToGroupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">添加渠道到该组</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="/admin/channel-groups/{{.CurrentGroup.ID}}/children/channels" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

          <div class="mb-3">
            <label class="form-label">选择渠道</label>
            <select name="channel_id" class="form-select" required>
              <option value="" selected disabled>请选择</option>
              {{range .Channels}}
                <option value="{{.ID}}">{{.Name}} (id={{.ID}}, {{.Type}})</option>
              {{end}}
            </select>
            <div class="form-text">添加后会更新该渠道的 groups 缓存（用于权限/对话分组筛选）。</div>
          </div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">添加</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('channel-group-members-body');
    if (!el) return;

    Sortable.create(el, {
      handle: '.drag-handle-cell',
      animation: 150,
      ghostClass: 'bg-light',
      onEnd: function () {
        var ids = [];
        el.querySelectorAll('tr').forEach(function (row) {
          var id = row.getAttribute('data-id');
          if (id) ids.push(parseInt(id));
        });

        fetch('/admin/channel-groups/{{.CurrentGroup.ID}}/children/reorder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{$.CSRFToken}}'
          },
          body: JSON.stringify(ids)
        }).then(function (response) {
          if (response.ok) {
            window.location.reload();
          } else {
            alert('保存排序失败，请重试');
          }
        }).catch(function () {
          alert('网络请求失败');
        });
      }
    });
  });
</script>
{{end}}

