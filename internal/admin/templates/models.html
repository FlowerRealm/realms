{{define "admin_models"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-0">模型管理</h2>
    <p class="text-muted small mb-0">模型目录是本服务对外暴露与强制校验的唯一来源（白名单 + 展示元信息）。模型绑定请到“上游渠道”里按渠道配置。</p>
  </div>
  <div class="d-flex gap-2">
    <button type="button" class="btn btn-light border" data-bs-toggle="modal" data-bs-target="#importPricingModal">
      <i class="ri-upload-2-line me-1"></i> 导入价格表
    </button>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModelModal">
      <i class="ri-add-line me-1"></i> 新增模型
    </button>
  </div>
</div>

{{if .Notice}}
<div class="alert alert-success mb-4">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
</div>
{{end}}

{{if .Error}}
<div class="alert alert-danger mb-4">
  <i class="ri-alert-line me-2"></i>{{.Error}}
</div>
{{end}}

<div class="card overflow-hidden">
	  <div class="table-responsive">
	    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th class="ps-4">对外 ID</th>
          <th>归属方</th>
          <th>计费 <span class="text-muted small">（每 1M Token）</span></th>
          <th>状态</th>
          <th class="text-end pe-4">操作</th>
        </tr>
      </thead>
      <tbody>
        {{range .ManagedModels}}
        <tr>
          {{$icon := modelIconURL .PublicID .OwnedBy}}
          <td class="ps-4 fw-semibold text-dark">
            <div class="d-flex align-items-center gap-2">
              {{if $icon}}
                <img class="rlm-model-icon" src="{{$icon}}" alt="{{.OwnedBy}}" title="{{.OwnedBy}}" loading="lazy" onerror="this.style.display='none';" />
              {{end}}
              <span>{{.PublicID}}</span>
            </div>
          </td>
          <td>
            {{if .OwnedBy}}
              <span class="badge rounded-pill bg-light text-secondary border px-2">{{.OwnedBy}}</span>
            {{else}}
              <span class="text-muted small">-</span>
            {{end}}
          </td>
          <td class="small text-nowrap">
            <div class="d-flex align-items-center gap-4">
              <div class="d-flex align-items-center"><span class="text-muted me-2" style="font-size: 0.75rem;">输入</span> <span class="fw-bold text-dark">${{.InputUSDPer1M}}</span></div>
              <div class="d-flex align-items-center"><span class="text-muted me-2" style="font-size: 0.75rem;">输出</span> <span class="fw-bold text-dark">${{.OutputUSDPer1M}}</span></div>
              <div class="d-flex align-items-center"><span class="text-muted me-2" style="font-size: 0.75rem;">缓存输入</span> <span class="fw-bold text-dark">${{.CacheInputUSDPer1M}}</span></div>
              <div class="d-flex align-items-center"><span class="text-muted me-2" style="font-size: 0.75rem;">缓存输出</span> <span class="fw-bold text-dark">${{.CacheOutputUSDPer1M}}</span></div>
            </div>
          </td>
          <td>
            {{if eq .Status 1}}
              <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">
                <i class="ri-checkbox-circle-line me-1"></i>启用
              </span>
            {{else}}
              <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">
                <i class="ri-close-circle-line me-1"></i>禁用
              </span>
            {{end}}
          </td>
          <td class="text-end">
            <div class="d-flex justify-content-end gap-1">
              <a href="/admin/models/{{.ID}}" class="btn btn-sm btn-light border text-secondary">
                <i class="ri-settings-3-line me-1"></i>编辑
              </a>
	              <form method="POST" action="/admin/models/{{.ID}}/delete" data-ajax="1" data-ajax-reload="1" onsubmit="return confirm('确认删除该模型? 不可恢复。')">
	                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
	                <button class="btn btn-sm btn-light border text-danger" type="submit" formmethod="POST" formaction="/admin/models/{{.ID}}/delete">
	                  <i class="ri-delete-bin-line me-1"></i>删除
	                </button>
	              </form>
            </div>
          </td>
        </tr>
        {{end}}
      </tbody>
	    </table>
	  </div>

  {{if not .ManagedModels}}
  <div class="text-center py-5 text-muted">
    <i class="ri-inbox-2-line fs-1 d-block mb-3"></i>
    暂无模型，请先新增模型后再对外提供服务。
  </div>
  {{end}}
</div>

<!-- 新增模型弹窗 -->
<div class="modal fade" id="createModelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">新增模型</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/models" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

	          <div class="row">
	            <div class="col-md-6">
	              <label class="form-label">对外 ID</label>
	              <div class="input-group">
	                <input id="rlmCreateModelPublicID" name="public_id" type="text" class="form-control" required placeholder="例如：gpt-4.1-mini" />
	                <button id="rlmCreateModelLookupBtn" type="button" class="btn btn-outline-secondary">
	                  <i class="ri-search-line me-1"></i>从模型库填充
	                </button>
	              </div>
		              <div class="form-text small text-muted">
		                数据来源：models.dev（GitHub 开源模型目录）。将填充“归属方/输入单价/输出单价/缓存输入单价/缓存输出单价”，不会自动保存。如遇多个候选可用 <code>openai/gpt-4o</code> 形式指定 provider。
		                <img id="rlmCreateModelIconPreview" class="rlm-model-icon ms-1" alt="icon" style="display:none;" loading="lazy" onerror="this.style.display='none';" />
		              </div>
	            </div>
	            <div class="col-md-6">
	              <label class="form-label">状态</label>
	              <select name="status" class="form-select">
	                <option value="1" selected>启用</option>
                <option value="0">禁用</option>
              </select>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <label class="form-label">输入单价</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
                <input name="input_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="5" />
                <span class="input-group-text">/ 1M Token</span>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">输出单价</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
                <input name="output_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="15" />
                <span class="input-group-text">/ 1M Token</span>
              </div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <label class="form-label">缓存输入单价</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
                <input name="cache_input_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="5" />
                <span class="input-group-text">/ 1M Token</span>
              </div>
              <div class="form-text small">用于提示缓存（prompt cache）命中的输入 Token 结算（如上游返回 cached_input_tokens / cached_tokens）。</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">缓存输出单价</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
                <input name="cache_output_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="5" />
                <span class="input-group-text">/ 1M Token</span>
              </div>
              <div class="form-text small">用于提示缓存（prompt cache）命中的输出 Token 结算（如上游返回 cached_output_tokens）。</div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-12">
              <label class="form-label">归属方（展示用，可选）</label>
              <input name="owned_by" type="text" class="form-control" placeholder="例如：openai / anthropic / internal" />
            </div>
          </div>

          <div class="form-text small mb-3">单位说明：USD / 1M Token（支持最多 6 位小数）。</div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 导入价格表弹窗 -->
<div class="modal fade" id="importPricingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">导入价格表</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/models/import-pricing" enctype="multipart/form-data" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
          <input type="hidden" name="return_to" value="/admin/models" />

          <div class="mb-3">
            <label class="form-label fw-medium">JSON 文件（优先）</label>
            <input name="pricing_file" type="file" accept="application/json" class="form-control" />
            <div class="form-text small text-muted">上传后将批量写入/更新 managed_models 的定价字段。</div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-medium">或粘贴 JSON</label>
            <textarea name="pricing_json" class="form-control" rows="10" placeholder='{"gpt-4.1-mini":{"input_usd_per_1m":0.15,"output_usd_per_1m":0.60,"cache_input_usd_per_1m":0.00,"cache_output_usd_per_1m":0.00}}'></textarea>
          </div>

          <div class="form-text small">
            支持两种格式：Realms 简化格式（usd_per_1m）与 LiteLLM 常见格式（cost_per_token）。
            新模型会以“禁用(status=0)”创建；已存在模型仅更新价格字段（不改 public_id/status/owned_by）。
          </div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">开始导入</button>
        </div>
      </form>
    </div>
	  </div>
	</div>

		<script>
		(function () {
		  try {
		    const modal = document.getElementById('createModelModal');
		    const btn = document.getElementById('rlmCreateModelLookupBtn');
		    if (!modal || !btn) return;

		    const form = modal.querySelector('form');
		    const idInput = document.getElementById('rlmCreateModelPublicID');
		    const ownedByInput = form ? form.querySelector('input[name="owned_by"]') : null;
		    const inPrice = form ? form.querySelector('input[name="input_usd_per_1m"]') : null;
		    const outPrice = form ? form.querySelector('input[name="output_usd_per_1m"]') : null;
		    const cacheInPrice = form ? form.querySelector('input[name="cache_input_usd_per_1m"]') : null;
		    const cacheOutPrice = form ? form.querySelector('input[name="cache_output_usd_per_1m"]') : null;
		    const iconPreview = document.getElementById('rlmCreateModelIconPreview');
		    const csrf = form ? ((form.querySelector('input[name="_csrf"]') || {}).value || '').trim() : '';

		    function normalizeMsg(raw, maxLen) {
		      try {
		        let s = (raw || '').toString();
		        s = s.replace(/[\r\n]+/g, ' ');
		        s = s.replace(/\s+/g, ' ').trim();
		        const lim = (Number.isFinite(maxLen) && maxLen > 0) ? maxLen : 160;
		        if (s.length > lim) s = s.slice(0, lim) + '...';
		        return s;
		      } catch (e) {}
		      return '';
		    }

		    function show(kind, message) {
		      try {
		        const host = document.getElementById('rlmAjaxAlertHost');
		        if (!host) return;
		        host.textContent = '';

		        const alert = document.createElement('div');
		        const cls = (kind === 'success') ? 'success' : 'danger';
		        alert.className = 'alert alert-' + cls + ' alert-dismissible fade show shadow-sm mb-4';
		        alert.setAttribute('role', 'alert');

		        const msg = document.createElement('span');
		        msg.textContent = normalizeMsg(message, 160) || (cls === 'success' ? '操作成功' : '请求失败');

		        const closeBtn = document.createElement('button');
		        closeBtn.type = 'button';
		        closeBtn.className = 'btn-close';
		        closeBtn.setAttribute('data-bs-dismiss', 'alert');
		        closeBtn.setAttribute('aria-label', '关闭');

		        alert.appendChild(msg);
		        alert.appendChild(closeBtn);
		        host.appendChild(alert);
		      } catch (e) {}
		    }

		    async function lookup() {
		      if (!idInput) return;
		      const modelID = (idInput.value || '').trim();
		      if (modelID === '') {
		        show('danger', '请先填写对外 ID');
		        return;
		      }
		      const prevText = btn.innerHTML;
		      btn.disabled = true;
		      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" aria-hidden="true"></span>查询中…';

	      try {
	        const params = new URLSearchParams();
	        params.set('model_id', modelID);

	        const headers = {
	          'Accept': 'application/json',
	          'X-Realms-Ajax': '1',
	          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
	        };
	        if (csrf !== '') headers['X-CSRF-Token'] = csrf;

	        const resp = await fetch('/admin/models/library-lookup', {
	          method: 'POST',
	          headers,
	          body: params.toString(),
	          credentials: 'same-origin',
	        });

		        const ct = (resp.headers.get('Content-Type') || '').toLowerCase();
		        if (ct.indexOf('application/json') === -1) {
		          const txt = (await resp.text()) || '';
		          const msg = (txt || ('请求失败（HTTP ' + resp.status + '）')).slice(0, 200);
		          show('danger', msg);
		          return;
		        }
		        const payload = await resp.json();
		        if (payload && payload.ok) {
		          if (ownedByInput && typeof payload.owned_by === 'string') ownedByInput.value = payload.owned_by;
		          if (inPrice && typeof payload.input_usd_per_1m === 'string') inPrice.value = payload.input_usd_per_1m;
		          if (outPrice && typeof payload.output_usd_per_1m === 'string') outPrice.value = payload.output_usd_per_1m;
		          if (cacheInPrice && typeof payload.cache_input_usd_per_1m === 'string') cacheInPrice.value = payload.cache_input_usd_per_1m;
		          if (cacheOutPrice && typeof payload.cache_output_usd_per_1m === 'string') cacheOutPrice.value = payload.cache_output_usd_per_1m;
		          if (iconPreview) {
		            const url = (payload.icon_url || '').toString().trim();
		            if (url !== '') {
		              iconPreview.src = url;
		              iconPreview.style.display = '';
		            } else {
		              iconPreview.style.display = 'none';
		            }
		          }
		          show('success', (payload.notice || '已填充').toString());
		          return;
		        }
		        const errMsg = (payload && payload.error) ? payload.error.toString() : '';
		        show('danger', errMsg || '查询失败');
		      } catch (e) {
		        show('danger', '查询失败，请稍后重试。');
		      } finally {
		        btn.disabled = false;
		        btn.innerHTML = prevText;
		      }
		    }

	    btn.addEventListener('click', function (e) {
	      try { e.preventDefault(); } catch (e2) {}
	      lookup();
	    });
	  } catch (e) {}
	})();
	</script>

	{{end}}

	{{define "admin_model_edit"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-0">编辑模型</h2>
  </div>
  <a href="/admin/models" class="btn btn-light border">
    <i class="ri-arrow-left-line me-1"></i>返回列表
  </a>
</div>

{{if .Notice}}
<div class="alert alert-success mb-4">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
</div>
{{end}}

{{if .Error}}
<div class="alert alert-danger mb-4">
  <i class="ri-alert-line me-2"></i>{{.Error}}
</div>
{{end}}

<div class="card p-4">
  <form method="POST" action="/admin/models/{{.ManagedModel.ID}}" data-ajax="1">
    <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

    <label class="form-label">对外 ID</label>
    <input name="public_id" type="text" class="form-control" required value="{{.ManagedModel.PublicID}}" />

    <div class="row mt-3">
      <div class="col-md-3">
        <label class="form-label">输入单价</label>
        <div class="input-group">
          <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
          <input name="input_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="{{.ManagedModel.InputUSDPer1M}}" />
          <span class="input-group-text">/ 1M Token</span>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">输出单价</label>
        <div class="input-group">
          <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
          <input name="output_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="{{.ManagedModel.OutputUSDPer1M}}" />
          <span class="input-group-text">/ 1M Token</span>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">缓存输入单价</label>
        <div class="input-group">
          <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
          <input name="cache_input_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="{{.ManagedModel.CacheInputUSDPer1M}}" />
          <span class="input-group-text">/ 1M Token</span>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">缓存输出单价</label>
        <div class="input-group">
          <span class="input-group-text"><i class="ri-money-dollar-circle-line"></i></span>
          <input name="cache_output_usd_per_1m" type="number" step="0.000001" min="0" class="form-control" required value="{{.ManagedModel.CacheOutputUSDPer1M}}" />
          <span class="input-group-text">/ 1M Token</span>
        </div>
      </div>
    </div>
    <div class="form-text mb-3">单位说明：USD / 1M Token（支持最多 6 位小数）。</div>

    <label class="form-label">归属方（展示用，可选）</label>
    <input name="owned_by" type="text" class="form-control" value="{{.ManagedModel.OwnedBy}}" placeholder="例如：openai / anthropic / internal" />

    <label class="form-label">状态</label>
    <select name="status" class="form-select">
      <option value="1" {{if eq .ManagedModel.Status 1}}selected{{end}}>启用</option>
      <option value="0" {{if eq .ManagedModel.Status 0}}selected{{end}}>禁用</option>
    </select>

    <div class="d-flex justify-content-end mt-4">
      <button type="submit" class="btn btn-primary">
        <i class="ri-save-3-line me-1"></i>保存
      </button>
    </div>
  </form>
</div>
{{end}}
