{{define "admin_settings"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-1">系统设置</h2>
    <p class="text-muted small mb-0">少量运行期配置（持久化到数据库，优先于配置文件默认）。</p>
  </div>
</div>

{{if .Notice}}
<div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>
</div>
{{end}}

{{if .Error}}
<div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
  <i class="ri-alert-line me-2"></i>{{.Error}}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>
</div>
{{end}}

<form method="POST" action="/admin/settings" data-ajax="1" data-ajax-reload="0" data-ajax-autosave="1" data-ajax-autosave-status="settingsAutosaveStatus" data-ajax-autosave-debounce="900">
  <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

  <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 mb-4">
      <ul class="nav nav-pills" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active d-flex align-items-center gap-2" id="settingsTabFeatures" data-bs-toggle="tab" data-bs-target="#settingsPaneFeatures" type="button" role="tab" aria-controls="settingsPaneFeatures" aria-selected="true">
            <i class="ri-function-line"></i> 功能开关
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link d-flex align-items-center gap-2" id="settingsTabBase" data-bs-toggle="tab" data-bs-target="#settingsPaneBase" type="button" role="tab" aria-controls="settingsPaneBase" aria-selected="false">
            <i class="ri-settings-4-line"></i> 基础设置
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link d-flex align-items-center gap-2" id="settingsTabEmail" data-bs-toggle="tab" data-bs-target="#settingsPaneEmail" type="button" role="tab" aria-controls="settingsPaneEmail" aria-selected="false">
            <i class="ri-mail-settings-line"></i> 邮件服务
          </button>
        </li>
        {{if not .Features.BillingDisabled}}
        <li class="nav-item" role="presentation">
          <button class="nav-link d-flex align-items-center gap-2" id="settingsTabBilling" data-bs-toggle="tab" data-bs-target="#settingsPaneBilling" type="button" role="tab" aria-controls="settingsPaneBilling" aria-selected="false">
            <i class="ri-bank-card-line"></i> 计费支付
          </button>
        </li>
        {{end}}
      </ul>

      <div class="d-flex align-items-center gap-3">
        <div id="settingsAutosaveStatus" class="small text-muted"></div>
        <div class="d-flex gap-2">
            <button type="submit" name="action" value="save" class="btn btn-primary btn-sm">
            <i class="ri-save-3-line me-1"></i> 保存
            </button>
            <button type="submit" name="action" value="reset" class="btn btn-outline-secondary btn-sm" data-ajax-reload="1">
            恢复默认
            </button>
        </div>
      </div>
  </div>

  <div class="tab-content" id="settingsTabContent">
    <!-- Features -->
    <div class="tab-pane fade show active" id="settingsPaneFeatures" role="tabpanel" aria-labelledby="settingsTabFeatures" tabindex="0">
      <div class="card border-0 shadow-sm mb-4">
          <div class="card-header bg-transparent border-0 pt-3 pb-2">
            <h5 class="card-title fw-semibold mb-1">功能禁用</h5>
            <div class="card-subtitle text-muted small">
                开关默认开启（功能启用）；关闭则表示禁用该功能（隐藏入口并在后端返回 404）。部分开关同时会改变数据面语义。
            </div>
          </div>
          <div class="card-body pt-0">
              {{range .FeatureBanGroups}}
              <div class="mb-4">
                <h6 class="fw-medium text-dark border-bottom pb-2 mb-3">{{.Title}}</h6>
                <div class="row g-3">
                  {{range .Items}}
                  <div class="col-md-6 col-lg-4">
                    <div class="d-flex align-items-center justify-content-between p-3 border rounded bg-light bg-opacity-10 h-100">
                        <div class="d-flex flex-column">
                            <label class="form-check-label fw-medium mb-1" style="cursor: pointer;" for="featureBan_{{.Key}}">{{.Label}}</label>
                            {{if .ForcedByBuild}}
                            <div><span class="badge bg-warning-subtle text-warning-emphasis border smaller" style="font-size: 0.7rem;">编译期剔除</span></div>
                            {{else if .ForcedBySelfMode}}
                            <div><span class="badge bg-warning-subtle text-warning-emphasis border smaller" style="font-size: 0.7rem;">自用模式强制</span></div>
                            {{else if .Override}}
                            <div><span class="badge bg-light text-dark border smaller" style="font-size: 0.7rem;">已禁用</span></div>
                            {{end}}
                        </div>
                        <div class="form-check form-switch ms-2">
                            <input class="form-check-input" type="checkbox" role="switch" id="featureBan_{{.Key}}" name="{{.Key}}" value="1" {{if not .Disabled}}checked{{end}} {{if not .Editable}}disabled{{end}}>
                        </div>
                    </div>
                  </div>
                  {{end}}
                </div>
              </div>
              {{end}}
          </div>
      </div>
    </div>

    <!-- Base -->
    <div class="tab-pane fade" id="settingsPaneBase" role="tabpanel" aria-labelledby="settingsTabBase" tabindex="0">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0 pt-3">
                        <h5 class="card-title fw-semibold mb-0">站点地址</h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label fw-medium d-flex align-items-center justify-content-between">
                            <span>Base URL</span>
                            {{if .SiteBaseURLOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{else}}<span class="badge bg-light text-dark border">配置文件默认</span>{{end}}
                        </label>
                        <input name="site_base_url" type="url" class="form-control mb-2" value="{{.SiteBaseURL}}" placeholder="https://realms.example.com" />
                        <div class="form-text small text-muted">
                            用于页面展示的对外基础地址，以及支付回调/返回地址与 Codex OAuth 回跳链接生成。
                            <br>当前生效：<strong class="text-dark user-select-all">{{.SiteBaseURLEffective}}</strong>
                            {{if .SiteBaseURLInvalid}}<br><span class="text-danger">当前覆盖值不合法，已忽略。</span>{{end}}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0 pt-3">
                        <h5 class="card-title fw-semibold mb-0">系统时区</h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label fw-medium d-flex align-items-center justify-content-between">
                            <span>Timezone</span>
                            {{if .AdminTimeZoneOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{else}}<span class="badge bg-light text-dark border">默认值</span>{{end}}
                        </label>
                        <input name="admin_time_zone" type="text" class="form-control mb-2" value="{{.AdminTimeZone}}" placeholder="Asia/Shanghai" list="adminTimeZones" />
                        <datalist id="adminTimeZones">
                            <option value="Asia/Shanghai"></option>
                            <option value="UTC"></option>
                            <option value="America/Los_Angeles"></option>
                            <option value="Europe/London"></option>
                        </datalist>
                        <div class="form-text small text-muted">
                            用于管理后台展示时间（如：Codex 配额重置、订单时间等）。
                            <br>当前生效：<strong class="text-dark user-select-all">{{.AdminTimeZoneEffective}}</strong>
                            {{if .AdminTimeZoneInvalid}}<br><span class="text-danger">当前覆盖值不合法，已忽略。</span>{{end}}
                        </div>
                    </div>
                </div>
            </div>
            {{if .StartupConfigKeys}}
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0 pt-3">
                        <h5 class="card-title fw-semibold mb-0">启动期配置（只读）</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-text small text-muted mb-3">
                            以下配置项仅能在配置文件（如 <code>config.yaml</code>）中修改；修改后需要重启服务生效。本页仅展示清单以便排障。
                        </div>
                        <div class="row g-2">
                            {{range .StartupConfigKeys}}
                            <div class="col-md-6 col-lg-4"><code>{{.}}</code></div>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Email -->
    <div class="tab-pane fade" id="settingsPaneEmail" role="tabpanel" aria-labelledby="settingsTabEmail" tabindex="0">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <h5 class="fw-semibold mb-1">邮箱验证码</h5>
                    <p class="text-muted small mb-0">
                        开启后注册页将要求验证码，并开放 <code>/api/email/verification/send</code>。
                        {{if .EmailVerificationOverride}}<span class="badge bg-light text-dark border ms-1">界面覆盖</span>{{else}}<span class="badge bg-light text-dark border ms-1">配置文件默认</span>{{end}}
                    </p>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="emailVerificationEnabled" name="email_verification_enable" value="1" {{if .EmailVerificationEnabled}}checked{{end}} style="width: 3em; height: 1.5em;">
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pt-3">
                <h5 class="card-title fw-semibold mb-0">SMTP 配置</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-medium d-flex justify-content-between">
                            <span>Host</span>
                            {{if .SMTPServerOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{end}}
                        </label>
                        <input name="SMTPServer" type="text" class="form-control" value="{{.SMTPServer}}" placeholder="smtp.example.com" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-medium d-flex justify-content-between">
                            <span>Port</span>
                            {{if .SMTPPortOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{end}}
                        </label>
                        <input name="SMTPPort" type="number" min="1" max="65535" class="form-control" value="{{.SMTPPort}}" placeholder="587" />
                    </div>

                    <div class="col-md-3">
                         <label class="form-label fw-medium d-flex justify-content-between">
                            <span>SSL/TLS</span>
                             {{if .SMTPSSLEnabledOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{end}}
                        </label>
                        <div class="form-control border-0 bg-transparent px-0">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="smtpSSLEnabled" name="SMTPSSLEnabled" value="1" {{if .SMTPSSLEnabled}}checked{{end}}>
                                <label class="form-check-label" for="smtpSSLEnabled">启用 SSL</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-medium d-flex justify-content-between">
                            <span>Account</span>
                             {{if .SMTPAccountOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{end}}
                        </label>
                        <input name="SMTPAccount" type="text" class="form-control" value="{{.SMTPAccount}}" placeholder="noreply@example.com" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-medium d-flex justify-content-between">
                            <span>From Address</span>
                             {{if .SMTPFromOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{end}}
                        </label>
                        <input name="SMTPFrom" type="text" class="form-control" value="{{.SMTPFrom}}" placeholder="noreply@example.com" />
                        <div class="form-text small text-muted">格式："Name &lt;addr@example.com&gt;"</div>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-medium d-flex justify-content-between">
                            <span>Password / Token</span>
                            {{if .SMTPTokenOverride}}<span class="badge bg-light text-dark border">界面覆盖</span>{{end}}
                        </label>
                        <input name="SMTPToken" type="password" class="form-control" placeholder="留空表示保持不变" autocomplete="new-password" />
                        <div class="form-text small text-muted">
                            当前状态：{{if .SMTPTokenSet}}已设置{{else}}未设置{{end}}。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	    <!-- Billing -->
      {{if not .Features.BillingDisabled}}
	    <div class="tab-pane fade" id="settingsPaneBilling" role="tabpanel" aria-labelledby="settingsTabBilling" tabindex="0">
	        <div class="card border-0 shadow-sm mb-4">
	             <div class="card-header bg-transparent border-0 pt-3 d-flex align-items-center justify-content-between">
	                <h5 class="card-title fw-semibold mb-0">按量计费 (余额)</h5>
	                <div class="form-check form-switch">
	                     <input class="form-check-input" type="checkbox" role="switch" id="billingEnablePayAsYouGo" name="billing_enable_pay_as_you_go" value="1" {{if .BillingEnablePayAsYouGo}}checked{{end}}>
                     <label class="form-check-label" for="billingEnablePayAsYouGo">启用</label>
                </div>
            </div>
            <div class="card-body pt-0">
                <div class="row g-3">
                     <div class="col-md-6">
                        <label class="form-label fw-medium">
                            最小充值金额 (CNY)
                             {{if .BillingMinTopupCNYOverride}}<span class="badge bg-light text-dark border ms-2">界面覆盖</span>{{end}}
                        </label>
                        <input name="billing_min_topup_cny" type="number" min="0" step="0.01" class="form-control" value="{{.BillingMinTopupCNY}}" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-medium">
                            充值入账比例 (USD/CNY)
                             {{if .BillingCreditUSDPerCNYOverride}}<span class="badge bg-light text-dark border ms-2">界面覆盖</span>{{end}}
                        </label>
                        <input name="billing_credit_usd_per_cny" type="number" min="0" step="0.000001" class="form-control" value="{{.BillingCreditUSDPerCNY}}" />
                        <div class="form-text small text-muted">例：0.14 表示 1 CNY = 0.14 USD</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- EPay -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                     <div class="card-header bg-transparent border-0 pt-3 d-flex align-items-center justify-content-between">
                        <h5 class="card-title fw-semibold mb-0">EPay (易支付)</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="paymentEPayEnable" name="payment_epay_enable" value="1" {{if .PaymentEPayEnable}}checked{{end}}>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="mb-3">
                            <label class="form-label fw-medium">Gateway</label>
                            <input name="payment_epay_gateway" type="text" class="form-control" value="{{.PaymentEPayGateway}}" placeholder="https://epay.example.com" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-medium">Partner ID</label>
                            <input name="payment_epay_partner_id" type="text" class="form-control" value="{{.PaymentEPayPartnerID}}" placeholder="10001" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-medium">Key</label>
                            <input name="payment_epay_key" type="password" class="form-control" placeholder="留空保持不变" autocomplete="new-password" />
                            <div class="form-text small text-muted">当前：{{if .PaymentEPayKeySet}}已设置{{else}}未设置{{end}}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stripe -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-transparent border-0 pt-3 d-flex align-items-center justify-content-between">
                        <h5 class="card-title fw-semibold mb-0">Stripe</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="paymentStripeEnable" name="payment_stripe_enable" value="1" {{if .PaymentStripeEnable}}checked{{end}}>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        <div class="mb-3">
                            <label class="form-label fw-medium">Currency</label>
                            <input name="payment_stripe_currency" type="text" class="form-control" value="{{.PaymentStripeCurrency}}" placeholder="cny" />
                        </div>
                         <div class="mb-3">
                            <label class="form-label fw-medium">Secret Key</label>
                            <input name="payment_stripe_secret_key" type="password" class="form-control" placeholder="留空保持不变" autocomplete="new-password" />
                            <div class="form-text small text-muted">当前：{{if .PaymentStripeSecretKeySet}}已设置{{else}}未设置{{end}}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-medium">Webhook Secret</label>
                            <input name="payment_stripe_webhook_secret" type="password" class="form-control" placeholder="留空保持不变" autocomplete="new-password" />
                            <div class="form-text small text-muted">当前：{{if .PaymentStripeWebhookSecretSet}}已设置{{else}}未设置{{end}}</div>
                        </div>
                    </div>
                </div>
            </div>
	        </div>
	    </div>
      {{end}}
	  </div>
	</form>
	{{end}}
