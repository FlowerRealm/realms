{{define "admin_base"}}
<!doctype html>
<html lang="zh-CN" class="h-100 admin-html">
  <head>
	    <meta charset="utf-8" />
	    <meta name="viewport" content="width=device-width, initial-scale=1" />
	    <title>{{.Title}}</title>
	    <link rel="icon" href="/assets/realms_icon.svg" type="image/svg+xml" sizes="any" />
	    <link rel="preconnect" href="https://fonts.googleapis.com">
	    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
	    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <style>
      :root {
        --bs-font-sans-serif: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --bs-font-monospace: 'JetBrains Mono', SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --bs-primary: #8b5cf6; /* Violet 500 */
        --bs-primary-rgb: 139, 92, 246;
        --bs-secondary: #64748b;
        --bs-body-bg: #f8fafc;
        --bs-body-color: #334155; /* Slate 700 - Unified text color */
        --bs-border-color: rgba(0, 0, 0, 0.08);
        --sidebar-width: 260px;
        --top-header-height: 64px;
      }
      body {
        font-family: var(--bs-font-sans-serif);
        color: var(--bs-body-color);
        background: linear-gradient(135deg, #ccfbf1 0%, #e0e7ff 50%, #f3e8ff 100%);
        background-attachment: fixed;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      .admin-html, .admin-body { height: 100%; overflow: hidden; }
      .main-wrapper { display: flex; flex-direction: column; min-width: 0; min-height: 0; }
      code {
        font-family: var(--bs-font-monospace);
        color: #d946ef;
        background: #fae8ff;
        padding: 0.2em 0.4em;
        border-radius: 0.25em;
        font-size: 0.875em;
      }
      pre code {
        background: transparent;
        padding: 0;
        color: inherit;
      }
      
      /* Animations */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .fade-in-up {
        animation: fadeIn 0.4s ease-out forwards;
      }
      
      /* Interactive Element Transitions */
      .btn, .form-control, .form-select, .card, .sidebar-link, a {
        transition: all 0.2s ease-in-out;
      }
      
      h1, h2, h3, h4, h5, h6, .brand-font {
        font-weight: 600;
        letter-spacing: -0.025em;
        color: #1e293b; /* Slate 800 */
      }

      /* Modern Cards */
      .card { 
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 6px -1px rgba(30, 41, 59, 0.05), 0 2px 4px -1px rgba(30, 41, 59, 0.03);
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
      }
      .card-header {
        background-color: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 600;
        padding: 1rem 1.25rem;
        color: #334155; /* Slate 700 */
        font-size: 0.95rem;
      }
      .card-body { padding: 1.25rem; }
      
      /* Tables */
      .table {
        margin-bottom: 0;
        color: #334155; /* Slate 700 */
      }
      .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #334155;
        background-color: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        padding: 0.75rem 1rem;
      }
      .table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      }
      .table tr:last-child td { border-bottom: none; }
      
      /* Inputs */
      .form-control, .form-select { 
        padding: 0.5rem 0.8rem; 
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        background-color: #fff;
        color: #334155;
        box-shadow: 0 1px 2px 0 rgba(30, 41, 59, 0.05);
        transition: all 0.2s;
      }
      .form-control:focus, .form-select:focus { 
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
      }
      
      /* Input Groups */
      .input-group-text { 
        background-color: #f8fafc; 
        border: 1px solid #e2e8f0;
        color: #64748b;
        font-size: 0.9rem;
      }
      
      /* Buttons */
      .btn { 
        padding: 0.4rem 0.8rem; 
        font-weight: 500; 
        border-radius: 0.5rem;
        transition: all 0.2s;
        border: 1px solid transparent;
        font-size: 0.9rem;
        box-shadow: 0 1px 2px 0 rgba(30, 41, 59, 0.05);
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(30, 41, 59, 0.1), 0 2px 4px -1px rgba(30, 41, 59, 0.06);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn-primary {
        background-color: var(--bs-primary);
        color: #fff;
        border-color: transparent;
      }
      .btn-primary:hover {
        background-color: #7c3aed; /* Violet 600 */
      }
      .btn-light, .btn-white, .btn-secondary {
        background-color: #fff;
        border-color: #e2e8f0;
        color: #475569;
      }
      .btn-light:hover, .btn-white:hover, .btn-secondary:hover {
        background-color: #f8fafc;
        border-color: #cbd5e1;
        color: #1e293b;
      }
      
      /* Badges & Alerts */
      .badge { 
        border-radius: 9999px;
        padding: 0.35em 0.8em;
        font-weight: 500;
        font-size: 0.75rem;
      }
      .alert {
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(30, 41, 59, 0.05);
        font-size: 0.9rem;
      }

      /* Sidebar */
      .sidebar { 
        width: var(--sidebar-width); 
        height: 100vh; 
        overflow: hidden; 
        background-color: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-right: 1px solid rgba(0, 0, 0, 0.05);
      }
      .sidebar-link { 
        display: flex; align-items: center; padding: 0.6rem 1rem; color: #475569; /* Slate 600 */
        text-decoration: none; margin-bottom: 0.2rem; font-weight: 500; 
        border-radius: 0.5rem;
        transition: all 0.2s;
        font-size: 0.9rem;
      }
      .sidebar-link:hover { 
        background-color: rgba(139, 92, 246, 0.05); 
        color: var(--bs-primary);
      }
      .sidebar-link.active { 
        background-color: rgba(139, 92, 246, 0.1); 
        color: var(--bs-primary); 
      }
      .sidebar-link i { font-size: 1.1rem; margin-right: 0.75rem; opacity: 0.8; }
      
      /* Top Header */
      .top-header { 
        height: var(--top-header-height); 
        background-color: transparent; 
        /* border-bottom: 1px solid rgba(0,0,0,0.05); */
        padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; 
      }
      .content-scrollable { flex: 1; overflow-y: auto; padding: 2rem; }

      /* Misc */
      code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; color: #d946ef; background: #fdf4ff; padding: 2px 6px; font-size: 0.9em; border-radius: 0.25rem; }
      a { color: var(--bs-primary); text-decoration: none; transition: color 0.2s; }
      a:hover { color: #7c3aed; }
      
      /* Utility classes overrides */
      .bg-opacity-10 { opacity: 1 !important; }
      
      @media (max-width: 768px) {
        .sidebar { position: fixed; height: 100%; z-index: 1040; transform: translateX(-100%); transition: transform 0.3s ease; }
        .sidebar.show { transform: translateX(0); box-shadow: 10px 0 20px rgba(30, 41, 59, 0.1); }
        .content-scrollable { padding: 1rem; }
      }    </style>
  </head>
  <body class="h-100 admin-body">
    
    <div class="d-flex h-100">
      
      <!-- 侧边栏 -->
	      <aside class="sidebar d-flex flex-column flex-shrink-0 p-3" id="sidebarMenu">
	        <a href="/admin" class="d-flex align-items-center mb-4 mb-md-0 me-md-auto text-decoration-none px-2 mt-2">
			          <div class="me-2 d-flex align-items-center justify-content-center flex-shrink-0" style="width: 36px; height: 36px;">
			             <img src="/assets/realms_icon.svg" alt="Realms" style="width: 24px; height: 24px;" />
			          </div>
	          <span class="fs-5 fw-bold text-body tracking-tight">管理后台</span>
	        </a>
        <hr class="text-secondary opacity-50 my-3">
        
        <ul class="nav flex-column sidebar-nav mb-0">
          <li class="nav-item">
            <a href="/admin" class="sidebar-link">
              <i class="ri-dashboard-line"></i> 概览
            </a>
          </li>
          {{if not .Features.AdminChannelsDisabled}}
          <li>
            <a href="/admin/channels" class="sidebar-link">
              <i class="ri-git-merge-line"></i> 上游渠道
            </a>
          </li>
          {{end}}
          {{if not .Features.AdminChannelGroupsDisabled}}
          <li>
            <a href="/admin/channel-groups" class="sidebar-link">
              <i class="ri-folder-settings-line"></i> 分组
            </a>
          </li>
          {{end}}
          {{if not .Features.ModelsDisabled}}
          <li>
            <a href="/admin/models" class="sidebar-link">
              <i class="ri-function-line"></i> 模型管理
            </a>
          </li>
          {{end}}
          {{if not .Features.AdminUsersDisabled}}
          <li>
            <a href="/admin/users" class="sidebar-link">
              <i class="ri-user-settings-line"></i> 用户管理
            </a>
          </li>
          {{end}}
          {{if not .Features.BillingDisabled}}
	          <li>
	            <a href="/admin/subscriptions" class="sidebar-link">
	              <i class="ri-vip-crown-line"></i> 订阅套餐
	            </a>
	          </li>
	          <li>
	            <a href="/admin/orders" class="sidebar-link">
	              <i class="ri-bill-line"></i> 订单
	            </a>
	          </li>
	          {{end}}
	          {{if not .Features.AdminUsageDisabled}}
		          <li>
		            <a href="/admin/usage" class="sidebar-link">
		              <i class="ri-line-chart-line"></i> 用量统计
		            </a>
		          </li>
		          {{end}}
		          {{if not .Features.TicketsDisabled}}
		          <li>
		            <a href="/admin/tickets" class="sidebar-link">
		              <i class="ri-customer-service-2-line"></i> 工单
	            </a>
	          </li>
	          {{end}}
	          {{if not .Features.AdminAnnouncementsDisabled}}
	          <li>
	            <a href="/admin/announcements" class="sidebar-link">
	              <i class="ri-megaphone-line"></i> 公告
	            </a>
	          </li>
	          {{end}}
		          <li>
		            <a href="/admin/oauth-apps" class="sidebar-link">
		              <i class="ri-apps-2-line"></i> OAuth Apps
		            </a>
		          </li>
		          <li>
		            <a href="/admin/settings" class="sidebar-link">
		              <i class="ri-settings-3-line"></i> 系统设置
		            </a>
		          </li>
          <li class="mt-4 mb-2 ms-2 text-uppercase text-muted" style="font-size: 0.75rem; letter-spacing: 0.05em; font-weight: 600;">应用</li>
          <li>
            <a href="/dashboard" class="sidebar-link">
              <i class="ri-external-link-line"></i> 用户控制台
            </a>
          </li>
        </ul>

        <div class="mt-auto px-2 pb-2">
           <span class="text-muted small opacity-50">Realms 管理后台</span>
        </div>
      </aside>

      <!-- 主内容 -->
      <div class="main-wrapper w-100">
        <header class="top-header">
          <button class="btn btn-link text-body d-md-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <i class="ri-menu-line fs-4"></i>
          </button>
          
          <div class="ms-auto">
             <span class="text-muted small me-2">当前登录</span>
             <span class="fw-bold small text-body">{{.User.Email}}</span>
          </div>
        </header>

        <main class="content-scrollable">
          <div class="container-fluid" style="max-width: 1600px;">
            <div id="rlmAjaxAlertHost"></div>
            {{.ContentHTML}}
            
            <footer id="rlmProjectFooter" data-rlm-github="FlowerRealm/realms" class="mt-5 text-center text-muted small pb-4 opacity-50">
              管理面板 &copy; 2026 · <a href="https://github.com/FlowerRealm/realms" target="_blank" rel="noopener noreferrer" class="link-secondary text-decoration-none">GitHub: FlowerRealm/realms</a>
            </footer>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function () {
        try {
          if (typeof window === "undefined") return;
          window.alert = function () {};
          window.confirm = function () { return true; };
          window.prompt = function () { return null; };
        } catch (e) {}
      })();

      document.addEventListener("DOMContentLoaded", function() {
        // Fix Modal backdrop issue: Move all modals to body immediately
        document.querySelectorAll('.modal').forEach(function(modal) {
          document.body.appendChild(modal);
        });

        try {
          const url = new URL(window.location.href);
          if (url.searchParams.has("msg") || url.searchParams.has("err")) {
            url.searchParams.delete("msg");
            url.searchParams.delete("err");
            const clean = url.pathname + url.search + url.hash;
            window.history.replaceState({}, "", clean);
          }
        } catch (e) {}

        function persistAjaxAlert(kind, message) {
          try {
            const payload = {
              kind: (kind || "").toString(),
              message: (message || "").toString(),
              t: Date.now(),
            };
            sessionStorage.setItem("realms_ajax_alert", JSON.stringify(payload));
          } catch (e) {}
        }

        function showAjaxAlert(kind, message) {
          try {
            const host = document.getElementById("rlmAjaxAlertHost");
            if (!host) return;
            host.textContent = "";

            const alert = document.createElement("div");
            const cls = kind === "success" ? "success" : "danger";
            alert.className = "alert alert-" + cls + " alert-dismissible fade show shadow-sm mb-4";
            alert.setAttribute("role", "alert");

            const text = document.createElement("span");
            text.textContent = (message || "").toString();
            alert.appendChild(text);

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn-close";
            btn.setAttribute("data-bs-dismiss", "alert");
            btn.setAttribute("aria-label", "Close");
            alert.appendChild(btn);

            host.appendChild(alert);
            host.scrollIntoView({ block: "start", behavior: "smooth" });
          } catch (e) {}
        }

        function normalizeAlertMessage(message, maxLen) {
          try {
            let s = (message || "").toString();
            s = s.replace(/[\r\n]+/g, " ");
            s = s.replace(/\s+/g, " ").trim();
            const lim = (Number.isFinite(maxLen) && maxLen > 0) ? maxLen : 160;
            if (s.length > lim) s = s.slice(0, lim) + "...";
            return s;
          } catch (e) {}
          return "";
        }

        try {
          const raw = sessionStorage.getItem("realms_ajax_alert") || "";
          if (raw.trim() !== "") {
            sessionStorage.removeItem("realms_ajax_alert");
            const data = JSON.parse(raw);
            if (data && data.kind && data.message) {
              showAjaxAlert(data.kind, data.message);
            }
          }
        } catch (e) {}

        async function submitAjaxForm(form, submitter, opts) {
          opts = opts || {};
          const csrf = (form.querySelector('input[name="_csrf"]') || {}).value || "";
          const headers = {
            "Accept": "application/json",
            "X-Realms-Ajax": "1",
          };
          if (csrf.trim() !== "") headers["X-CSRF-Token"] = csrf.trim();

          const enctype = (form.enctype || "").toLowerCase();
          const hasFile = !!form.querySelector('input[type="file"]');
          const useFormData = hasFile || enctype.indexOf("multipart/form-data") !== -1;

          let body;
          if (useFormData) {
            body = new FormData(form);
            if (submitter && submitter.name) body.append(submitter.name, submitter.value || "");
          } else {
            const fd = new FormData(form);
            const params = new URLSearchParams();
            for (const [k, v] of fd.entries()) {
              if (typeof v === "string") params.append(k, v);
            }
            if (submitter && submitter.name) params.append(submitter.name, submitter.value || "");
            headers["Content-Type"] = "application/x-www-form-urlencoded; charset=UTF-8";
            body = params;
          }

          // 注意：HTMLFormElement 是 legacy platform object；当存在 name="action" 的控件时，
          // 直接访问 form.action 可能返回 RadioNodeList 而不是 form 的 action URL。
          let method = ((form.getAttribute("method") || "POST").trim() || "POST").toUpperCase();
          if (submitter && submitter.getAttribute) {
            const m = (submitter.getAttribute("formmethod") || "").trim();
            if (m !== "") method = m.toUpperCase();
          }

          let url = "";
          if (submitter && submitter.getAttribute) {
            url = (submitter.getAttribute("formaction") || "").trim();
          }
          if (url === "") url = (form.getAttribute("action") || "").trim();
          if (url === "") url = window.location.href;

          let reload = ((form.getAttribute("data-ajax-reload") || "").trim() === "1");
          if (submitter && submitter.getAttribute) {
            const overrideReload = (submitter.getAttribute("data-ajax-reload") || "").trim();
            if (overrideReload !== "") reload = (overrideReload === "1");
          }
          if (typeof opts.reload === "boolean") reload = opts.reload;

          const buttons = Array.from(form.querySelectorAll('button[type="submit"], input[type="submit"]'));
          const prev = buttons.map(b => ({ b, disabled: b.disabled }));
          prev.forEach(({ b }) => { b.disabled = true; });

          try {
            const resp = await fetch(url, {
              method,
              headers,
              body,
              credentials: "same-origin",
            });
            const ct = (resp.headers.get("Content-Type") || "").toLowerCase();
            if (ct.indexOf("application/json") === -1) {
              if (resp.url && resp.url.indexOf("/login") !== -1) {
                window.location.href = resp.url;
                return;
              }
              const txt = (await resp.text()) || "";
              const rawMsg = normalizeAlertMessage(txt, 200);
              const looksLikeHTML = ct.indexOf("text/html") !== -1 || /<!doctype|<html|<head|<body/i.test(txt);
              const msg = looksLikeHTML ? "" : normalizeAlertMessage(rawMsg, 120);
              showAjaxAlert("danger", msg || ("请求失败（HTTP " + resp.status + "）"));
              return;
            }
            const payload = await resp.json();
            if (payload && payload.ok) {
              const okMsg = normalizeAlertMessage(payload.notice || "", 120) || "操作成功";
              if (typeof opts.onSuccess === "function") {
                try { opts.onSuccess(okMsg, payload); } catch (e) {}
              }
              if (reload) {
                persistAjaxAlert("success", okMsg);
                window.location.reload();
                return;
              }
              if (!opts.silentOK) showAjaxAlert("success", okMsg);
              return;
            }
            const errMsg = normalizeAlertMessage((payload && payload.error ? payload.error : "") || "", 120) || "请求失败";
            if (typeof opts.onError === "function") {
              try { opts.onError(errMsg, payload); } catch (e) {}
            }
            showAjaxAlert("danger", errMsg);
          } catch (e) {
            if (typeof opts.onError === "function") {
              try { opts.onError("请求失败，请稍后重试。", null); } catch (e) {}
            }
            showAjaxAlert("danger", "请求失败，请稍后重试。");
          } finally {
            prev.forEach(({ b, disabled }) => { b.disabled = disabled; });
          }
        }

        document.addEventListener("submit", function (event) {
          try {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) return;
            if ((form.getAttribute("data-ajax") || "").trim() !== "1") return;
            if (event.defaultPrevented) return;
            event.preventDefault();
            submitAjaxForm(form, event.submitter);
          } catch (e) {}
        }, false);

        function setupAjaxAutosave(form) {
          if (!form) return;
          if ((form.getAttribute("data-ajax") || "").trim() !== "1") return;
          if ((form.getAttribute("data-ajax-autosave") || "").trim() !== "1") return;

          const debounceRaw = (form.getAttribute("data-ajax-autosave-debounce") || "").trim();
          let debounce = parseInt(debounceRaw || "800", 10);
          if (!Number.isFinite(debounce) || debounce < 200) debounce = 800;

          const statusID = (form.getAttribute("data-ajax-autosave-status") || "").trim();
          const statusEl = statusID !== "" ? document.getElementById(statusID) : null;

          let timer = null;
          let inFlight = false;
          let pending = false;
          let lastOKAt = 0;

          function setStatus(msg) {
            if (!statusEl) return;
            statusEl.textContent = (msg || "").toString();
          }

          async function run() {
            if (inFlight) {
              pending = true;
              return;
            }
            inFlight = true;
            pending = false;
            setStatus("正在保存…");
            await submitAjaxForm(form, null, {
              reload: false,
              silentOK: true,
              onSuccess: function () {
                lastOKAt = Date.now();
                setStatus("已保存");
                window.setTimeout(function () {
                  if (Date.now() - lastOKAt >= 1200) setStatus("");
                }, 1500);
              },
              onError: function () {
                setStatus("保存失败");
              },
            });
            inFlight = false;
            if (pending) schedule();
          }

          function schedule() {
            if (timer) window.clearTimeout(timer);
            timer = window.setTimeout(run, debounce);
          }

          function shouldIgnore(target) {
            try {
              if (!target) return true;
              if (target.closest && target.closest('[data-ajax-autosave-ignore="1"]')) return true;
              const tag = (target.tagName || "").toLowerCase();
              if (tag === "button") return true;
              if (tag === "input") {
                const t = (target.getAttribute("type") || "").toLowerCase();
                if (t === "hidden" || t === "submit") return true;
              }
            } catch (e) {}
            return false;
          }

          form.addEventListener("input", function (e) {
            try {
              if (shouldIgnore(e.target)) return;
              setStatus("已修改");
              schedule();
            } catch (e) {}
          }, true);

          form.addEventListener("change", function (e) {
            try {
              if (shouldIgnore(e.target)) return;
              setStatus("已修改");
              schedule();
            } catch (e) {}
          }, true);

          form.addEventListener("submit", function () {
            try {
              if (timer) window.clearTimeout(timer);
              timer = null;
            } catch (e) {}
          }, true);
        }

        document.querySelectorAll('form[data-ajax="1"][data-ajax-autosave="1"]').forEach(setupAjaxAutosave);

        const currentPath = window.location.pathname;
        const currentHash = window.location.hash || '';
        const links = document.querySelectorAll('.sidebar-link');
        let best = null;
        let bestScore = -1;
        links.forEach(link => {
          const href = link.getAttribute('href');
          if (!href) return;

          let hrefPath = '';
          let hrefHash = '';
          try {
            const u = new URL(href, window.location.origin);
            hrefPath = u.pathname;
            hrefHash = u.hash || '';
          } catch (e) {
            return;
          }

          let score = -1;
          if (currentPath === hrefPath) {
            score = 100;
            if (hrefHash) {
              score = hrefHash === currentHash ? 200 : 50;
            }
          } else if (!hrefHash && hrefPath !== '/admin' && currentPath.startsWith(hrefPath)) {
            score = hrefPath.length;
          }

          if (score > bestScore) {
            bestScore = score;
            best = link;
          }
        });
        if (best) best.classList.add('active');

        function applyCodexOAuthCallback(data) {
          if (!data || data.type !== 'realms_codex_oauth_callback') return;

          let target = '';
          if (typeof data.redirectPath === 'string' && data.redirectPath.trim() !== '') {
            target = data.redirectPath.trim();
          } else if (typeof data.redirectURL === 'string' && data.redirectURL.trim() !== '') {
            const u = new URL(data.redirectURL, window.location.origin);
            target = u.pathname + u.search + u.hash;
          } else {
            return;
          }
          if (!target.startsWith('/admin')) return;

          const current = window.location.pathname + window.location.search + window.location.hash;
          if (target === current) {
            window.location.reload();
            return;
          }
          window.location.href = target;
        }

        window.addEventListener('message', function (event) {
          try { applyCodexOAuthCallback(event.data); } catch (e) {}
        });

        // OpenAI OAuth 页面会设置 COOP=same-origin，导致回调窗口无法再访问 window.opener。
        // 使用 localStorage 作为兜底“广播”通道：回调窗口跳转回 /admin 后写入 localStorage，原页面收到 storage 事件后刷新。
        window.addEventListener('storage', function (event) {
          try {
            if (event.key !== 'realms_codex_oauth_callback' || !event.newValue) return;
            const data = JSON.parse(event.newValue);
            applyCodexOAuthCallback(data);
          } catch (e) {}
        });

        try {
          const params = new URLSearchParams(window.location.search);
          const oauth = (params.get('oauth') || '').trim();
          const isPopupReturn = (window.name || '') === 'realms_codex_oauth_popup';
          if ((oauth === 'ok' || oauth === 'error') && isPopupReturn) {
            localStorage.setItem('realms_codex_oauth_callback', JSON.stringify({
              type: 'realms_codex_oauth_callback',
              redirectPath: window.location.pathname + window.location.search + window.location.hash,
              t: Date.now()
            }));

            // 避免该窗口后续误判为回调窗口
            try { window.name = ''; } catch (e) {}
            setTimeout(function () {
              try { window.close(); } catch (e) {}
            }, 150);
          }
        } catch (e) {}

        (function installProjectFooterGuard() {
          try {
            const footerID = "rlmProjectFooter";
            const githubSlug = "FlowerRealm/realms";
            const githubURL = "https://github.com/FlowerRealm/realms";
            const restoredFlagKey = "realms_admin_project_footer_restored";

            function footerHTML() {
              return '<footer id="' + footerID + '" data-rlm-github="' + githubSlug + '" class="mt-5 text-center text-muted small pb-4 opacity-50">管理面板 &copy; 2026 · <a href="' + githubURL + '" target="_blank" rel="noopener noreferrer" class="link-secondary text-decoration-none">GitHub: ' + githubSlug + "</a></footer>";
            }

            function findMount() {
              const appContainer = document.querySelector('main.content-scrollable > .container-fluid');
              if (appContainer) return appContainer;
              return document.body;
            }

            function ensureFooter() {
              if (document.getElementById(footerID)) return;
              const mount = findMount();
              if (!mount) return;
              mount.insertAdjacentHTML("beforeend", footerHTML());
              if (!sessionStorage.getItem(restoredFlagKey)) {
                sessionStorage.setItem(restoredFlagKey, "1");
                try { console.warn("[Realms] 检测到项目声明底栏被移除，已自动恢复。"); } catch (e) {}
              }
            }

            ensureFooter();

            let scheduled = false;
            function scheduleEnsure() {
              if (scheduled) return;
              scheduled = true;
              requestAnimationFrame(function () {
                scheduled = false;
                ensureFooter();
              });
            }

            if (typeof MutationObserver !== "undefined") {
              const obs = new MutationObserver(function () {
                try {
                  if (!document.getElementById(footerID)) scheduleEnsure();
                } catch (e) {}
              });
              obs.observe(document.body, { childList: true, subtree: true });
            }

            window.addEventListener("pageshow", function () {
              try { scheduleEnsure(); } catch (e) {}
            });
          } catch (e) {}
        })();
      });
    </script>
  </body>
</html>
{{end}}
