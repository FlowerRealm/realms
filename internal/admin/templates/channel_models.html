{{define "admin_channel_models"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-0">渠道模型绑定</h2>
    <p class="text-muted small mb-0">
      类型：<code class="text-dark bg-light border px-1">{{.Channel.Type}}</code>
    </p>
    <p class="text-muted small mb-0">说明：绑定决定该渠道可服务哪些对外模型，以及转发时使用的上游模型映射（别名）。</p>
  </div>
  <div class="d-flex gap-2">
    <a href="/admin/channels" class="btn btn-light border">
      <i class="ri-arrow-left-line me-1"></i>返回渠道
    </a>
    <form method="POST" action="/admin/channels/test" data-ajax="1">
      <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
      <input type="hidden" name="_intent" value="test_channel" />
      <input type="hidden" name="channel_id" value="{{.Channel.ID}}" />
      <input type="hidden" name="return_to" value="/admin/channels/{{.Channel.ID}}/models" />
      <button class="btn btn-light border text-primary" type="submit">
        <i class="ri-flashlight-line me-1"></i>测试全部
      </button>
    </form>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createChannelModelModal">
      <i class="ri-add-line me-1"></i>新增绑定
    </button>
  </div>
</div>

{{if .Notice}}
<div class="alert alert-success mb-4">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
</div>
{{end}}

{{if .Error}}
<div class="alert alert-danger mb-4">
  <i class="ri-alert-line me-2"></i>{{.Error}}
</div>
{{end}}

<div class="card overflow-hidden">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th>对外 ID</th>
          <th>上游模型</th>
          <th>状态</th>
          <th>更新时间</th>
          <th class="text-end">操作</th>
        </tr>
      </thead>
      <tbody>
        {{range .ChannelModels}}
        <tr>
          {{$icon := modelIconURL .PublicID ""}}
          <td class="fw-semibold text-dark">
            <div class="d-flex align-items-center gap-2">
              {{if $icon}}
                <img class="rlm-model-icon" src="{{$icon}}" alt="模型" title="{{.PublicID}}" loading="lazy" onerror="this.style.display='none';" />
              {{end}}
              <span>{{.PublicID}}</span>
            </div>
          </td>
          <td><code class="text-secondary bg-light border px-1">{{.UpstreamModel}}</code></td>
          <td>
            {{if eq .Status 1}}
              <span class="badge rounded-pill bg-success bg-opacity-10 text-success px-2">
                <i class="ri-checkbox-circle-line me-1"></i>启用
              </span>
            {{else}}
              <span class="badge rounded-pill bg-secondary bg-opacity-10 text-secondary px-2">
                <i class="ri-close-circle-line me-1"></i>禁用
              </span>
            {{end}}
          </td>
          <td class="small text-muted">{{.UpdatedAt}}</td>
          <td class="text-end">
            <div class="d-flex justify-content-end gap-1">
              <form method="POST" action="/admin/channels/test" data-ajax="1">
                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                <input type="hidden" name="_intent" value="test_channel" />
                <input type="hidden" name="channel_id" value="{{$.Channel.ID}}" />
                <input type="hidden" name="return_to" value="/admin/channels/{{$.Channel.ID}}/models" />
                <input type="hidden" name="binding_id" value="{{.ID}}" />
                <button class="btn btn-sm btn-light border text-primary" type="submit">
                  <i class="ri-flashlight-line me-1"></i>测试
                </button>
              </form>
              <a href="/admin/channels/{{$.Channel.ID}}/models/{{.ID}}" class="btn btn-sm btn-light border text-secondary">
                <i class="ri-settings-3-line me-1"></i>编辑
              </a>
              <form method="POST" action="/admin/channels/{{$.Channel.ID}}/models/{{.ID}}/delete" data-ajax="1" data-ajax-reload="1" onsubmit="return confirm('确认删除该绑定? 不可恢复。')">
                <input type="hidden" name="_csrf" value="{{$.CSRFToken}}" />
                <button class="btn btn-sm btn-light border text-danger" type="submit">
                  <i class="ri-delete-bin-line me-1"></i>删除
                </button>
              </form>
            </div>
          </td>
        </tr>
        {{end}}
      </tbody>
    </table>
  </div>

  {{if not .ChannelModels}}
  <div class="text-center py-5 text-muted">
    <i class="ri-inbox-2-line fs-1 d-block mb-3"></i>
    暂无绑定。请新增绑定后，该渠道才能服务对应模型。
  </div>
  {{end}}
</div>

<!-- 新增渠道模型绑定弹窗 -->
<div class="modal fade" id="createChannelModelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">新增渠道模型绑定</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <form method="POST" action="/admin/channels/{{.Channel.ID}}/models" data-ajax="1" data-ajax-reload="1">
        <div class="modal-body">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

          <div class="row">
            <div class="col-md-6">
              <label class="form-label">对外 ID</label>
              <select name="public_id" class="form-select" required>
                {{range .ManagedModels}}
                  <option value="{{.PublicID}}">{{.PublicID}}</option>
                {{end}}
              </select>
              <div class="form-text small">如列表为空，请先到“模型管理”创建模型。</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">上游模型</label>
              <input name="upstream_model" type="text" class="form-control" placeholder="留空表示与对外 ID 相同" />
              <div class="form-text small">用于别名映射：public_id → upstream_model。</div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-6">
              <label class="form-label">状态</label>
              <select name="status" class="form-select">
                <option value="1" selected>启用</option>
                <option value="0">禁用</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>
{{end}}

{{define "admin_channel_model_edit"}}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="h4 fw-bold mb-0">编辑渠道模型绑定</h2>
    <p class="text-muted small mb-0">
      类型：<code class="text-dark bg-light border px-1">{{.Channel.Type}}</code>
    </p>
  </div>
  <a href="/admin/channels/{{.Channel.ID}}/models" class="btn btn-light border">
    <i class="ri-arrow-left-line me-1"></i>返回列表
  </a>
</div>

{{if .Notice}}
<div class="alert alert-success mb-4">
  <i class="ri-checkbox-circle-line me-2"></i>{{.Notice}}
</div>
{{end}}

{{if .Error}}
<div class="alert alert-danger mb-4">
  <i class="ri-alert-line me-2"></i>{{.Error}}
</div>
{{end}}

<div class="card">
  <form method="POST" action="/admin/channels/{{.Channel.ID}}/models/{{.ChannelModel.ID}}" data-ajax="1">
    <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

    <label class="form-label">对外 ID</label>
    <select name="public_id" class="form-select" required>
      {{range .ManagedModels}}
        <option value="{{.PublicID}}" {{if eq $.ChannelModel.PublicID .PublicID}}selected{{end}}>{{.PublicID}}</option>
      {{end}}
    </select>

    <label class="form-label mt-3">上游模型</label>
    <input name="upstream_model" type="text" class="form-control" value="{{.ChannelModel.UpstreamModel}}" placeholder="留空表示与对外 ID 相同" />

    <label class="form-label mt-3">状态</label>
    <select name="status" class="form-select">
      <option value="1" {{if eq .ChannelModel.Status 1}}selected{{end}}>启用</option>
      <option value="0" {{if eq .ChannelModel.Status 0}}selected{{end}}>禁用</option>
    </select>

    <div class="d-flex justify-content-end mt-3">
      <button type="submit" class="btn btn-primary">
        <i class="ri-save-3-line me-1"></i>保存
      </button>
    </div>
  </form>
</div>
{{end}}
