{{define "page_topup"}}
<div class="row g-4">
  
  {{if .Notice}}
  <div class="col-12">
    <div class="alert alert-success d-flex align-items-center" role="alert">
      <span class="me-2 material-symbols-rounded">check_circle</span>
      <div>{{.Notice}}</div>
    </div>
  </div>
  {{end}}

  {{if .Error}}
  <div class="col-12">
    <div class="alert alert-danger d-flex align-items-center" role="alert">
      <span class="me-2 material-symbols-rounded">warning</span>
      <div>{{.Error}}</div>
    </div>
  </div>
  {{end}}

  <!-- 余额概览 -->
  <div class="col-12">
    <div class="d-flex align-items-center mb-3">
      <h4 class="mb-0 fw-bold">余额</h4>
      {{if .PayAsYouGoEnabled}}
        <span class="badge bg-success bg-opacity-10 text-success ms-2">按量计费已启用</span>
      {{else}}
        <span class="badge bg-secondary bg-opacity-10 text-secondary ms-2">按量计费未启用</span>
      {{end}}
    </div>

    <div class="card  border-0">
      <div class="card-body p-4">
        <div class="display-6 fw-bold text-dark">{{.BalanceUSD}}</div>
        <div class="text-muted small mt-1">余额用于无订阅/订阅额度不足时的按量计费扣费。</div>
      </div>
    </div>
  </div>

  <!-- 创建充值订单 -->
  <div class="col-12">
    <div class="d-flex align-items-center mb-3">
      <h4 class="mb-0 fw-bold">创建充值订单</h4>
    </div>

    <div class="card  border-0">
      <div class="card-body p-4">
        {{if and (not .PaymentStripeEnabled) (not .PaymentEPayEnabled)}}
        <div class="alert alert-warning d-flex align-items-center" role="alert">
          <span class="me-2 material-symbols-rounded">error</span>
          <div>当前未配置任何支付方式，请联系管理员在「管理后台 → 支付渠道」配置渠道，或在「管理后台 → 设置」启用旧版 Stripe/EPay。</div>
        </div>
        {{end}}

        <form method="POST" action="/topup/create" class="row g-3">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />

          <div class="col-md-6">
            <label class="form-label">充值金额（CNY）</label>
            <input name="amount_cny" type="text" class="form-control" placeholder="10.00" />
            <div class="form-text small text-muted">最低充值：{{.TopupMinCNY}}（示例：10.00）</div>
          </div>

          <div class="col-md-6 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100 fw-bold" {{if and (not .PaymentStripeEnabled) (not .PaymentEPayEnabled)}}disabled{{end}}>
              创建订单并选择支付方式
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 订单列表 -->
  <div class="col-12 mt-2">
    <div class="d-flex align-items-center mb-3">
      <h4 class="mb-0 fw-bold">我的充值订单</h4>
    </div>

    <div class="card  border-0 overflow-hidden">
      {{if .TopupOrders}}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>订单号</th>
              <th>金额</th>
              <th>入账额度</th>
              <th>状态</th>
              <th>创建时间</th>
              <th>支付时间</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{range .TopupOrders}}
            <tr data-href="/pay/topup/{{.ID}}" style="cursor: pointer;">
              <td class="font-monospace"><a class="link-primary text-decoration-none" href="/pay/topup/{{.ID}}">#{{.ID}}</a></td>
              <td class="fw-semibold">{{.AmountCNY}}</td>
              <td class="text-muted small">{{.CreditUSD}}</td>
              <td>
                {{if eq .Status "已入账"}}
                  <span class="badge bg-success bg-opacity-10 text-success">已入账</span>
                {{else if eq .Status "待支付"}}
                  <span class="badge bg-warning bg-opacity-10 text-warning">待支付</span>
                {{else if eq .Status "已取消"}}
                  <span class="badge bg-secondary bg-opacity-10 text-secondary">已取消</span>
                {{else}}
                  <span class="badge bg-secondary bg-opacity-10 text-secondary">{{.Status}}</span>
                {{end}}
              </td>
              <td class="text-muted small">{{.CreatedAt}}</td>
              <td class="text-muted small">{{if .PaidAt}}{{.PaidAt}}{{else}}-{{end}}</td>
              <td class="text-end">
                {{if eq .Status "待支付"}}
                  <a class="btn btn-sm btn-outline-primary" href="/pay/topup/{{.ID}}">去支付</a>
                {{else}}
                  <span class="text-muted small">-</span>
                {{end}}
              </td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </div>
      {{else}}
      <div class="card-body p-4 text-muted">
        暂无充值订单。
      </div>
      {{end}}
    </div>
  </div>

  <script>
    (function () {
      function isInteractiveTarget(el) {
        return !!(el && el.closest && el.closest('a, button, input, select, textarea, label, form'));
      }
      document.addEventListener("click", function (e) {
        try {
          const tr = e.target && e.target.closest ? e.target.closest("tr[data-href]") : null;
          if (!tr || isInteractiveTarget(e.target)) return;
          const href = (tr.getAttribute("data-href") || "").trim();
          if (!href) return;
          if (e.metaKey || e.ctrlKey) return void window.open(href, "_blank", "noopener");
          window.location.href = href;
        } catch (err) {}
      }, false);
    })();
  </script>

</div>
{{end}}
