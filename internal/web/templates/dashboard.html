{{define "page_dashboard"}}
<div class="row g-4">
  <!-- 账户概览 -->
  <div class="col-12">
    <div class="row g-4">
      <!-- 今日费用卡片 -->
      <div class="col-md-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="bg-primary bg-opacity-10 text-primary rounded-pill p-2 me-3">
                <span class="fs-4 px-1 material-symbols-rounded">attach_money</span>
              </div>
              <h6 class="card-title mb-0 fw-bold">今日费用</h6>
            </div>
            <div class="mb-3">
              <h3 class="fw-bold mb-1">{{.TodayUsageUSD}}</h3>
              <p class="text-muted small mb-0">预估消耗 (USD)</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 今日请求卡片 -->
      <div class="col-md-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="bg-info bg-opacity-10 text-info rounded-pill p-2 me-3">
                <span class="fs-4 px-1 material-symbols-rounded">chat</span>
              </div>
              <h6 class="card-title mb-0 fw-bold">今日请求</h6>
            </div>
            <div class="mb-3">
              <h3 class="fw-bold mb-1">{{.TodayRequests}}</h3>
              <div class="text-muted small">
                <span class="badge bg-light text-secondary border fw-normal">RPM: {{.TodayRPM}}</span>
                <span class="ms-1">次调用</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 今日 Token 卡片 -->
      <div class="col-md-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="bg-success bg-opacity-10 text-success rounded-pill p-2 me-3">
                <span class="fs-4 px-1 material-symbols-rounded">memory</span>
              </div>
              <h6 class="card-title mb-0 fw-bold">今日 Token</h6>
            </div>
            <div class="mb-3">
              <h3 class="fw-bold mb-1">{{.TodayTokens}}</h3>
              <div class="text-muted small">
                <span class="badge bg-light text-secondary border fw-normal">TPM: {{.TodayTPM}}</span>
                <span class="ms-1">Tokens</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 订阅卡片 -->
      {{if .Subscription}}
      <div class="col-md-6 col-xl-3">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="bg-warning bg-opacity-10 text-warning rounded-pill p-2 me-3">
                <span class="fs-4 px-1 material-symbols-rounded">diamond</span>
              </div>
              <h6 class="card-title mb-0 fw-bold">当前订阅</h6>
            </div>
            <div class="mb-1">
              <h5 class="fw-bold mb-1">{{.Subscription.PlanName}}</h5>
              <p class="text-muted small mb-0">至: {{.Subscription.EndAt}}</p>
            </div>
            {{range .Subscription.UsageWindows}}
            <div class="mt-2">
              <div class="d-flex justify-content-between mb-0 small" style="font-size: 0.7rem;">
                <span class="text-muted">{{.Window}}</span>
                <span class="fw-medium">{{.UsedUSD}}/{{.LimitUSD}}</span>
              </div>
              <div class="progress" style="height: 4px;">
                <div class="progress-bar {{if gt .UsedPercent 90}}bg-danger{{else if gt .UsedPercent 70}}bg-warning{{else}}bg-success{{end}}" 
                     role="progressbar" style="width: {{.UsedPercent}}%"></div>
              </div>
            </div>
            {{end}}
          </div>
        </div>
      </div>
      {{else}}
      <div class="col-md-6 col-xl-3">
        <div class="card h-100 border-dashed">
          <div class="card-body d-flex flex-column align-items-center justify-content-center text-center py-4">
            <div class="bg-light text-muted rounded-circle p-2 mb-2">
              <span class="fs-4 material-symbols-rounded">event_available</span>
            </div>
            <h6 class="fw-bold small mb-1">暂无订阅</h6>
            <a href="/subscriptions" class="btn btn-outline-primary btn-sm px-3 py-1" style="font-size: 0.75rem;">
              浏览套餐
            </a>
          </div>
        </div>
      </div>
      {{end}}
      
      <!-- 公告卡片 -->
      {{if and (not .Features.WebAnnouncementsDisabled) (gt .UnreadAnnouncementsCount 0)}}
      <div class="col-12">
        <div class="card h-100 bg-warning bg-opacity-10">
          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-center mb-3">
              <div class="bg-warning bg-opacity-25 text-warning rounded-pill p-2 me-3">
                <span class="fs-4 px-1 material-symbols-rounded">campaign</span>
              </div>
              <h6 class="card-title mb-0 fw-bold text-warning-emphasis">重要公告</h6>
            </div>
            <div class="flex-grow-1">
              <p class="fw-semibold mb-1">你有 {{.UnreadAnnouncementsCount}} 条未读公告</p>
              <p class="text-muted small">请及时查看最新动态和维护通知。</p>
            </div>
            <a href="/announcements" class="btn btn-warning btn-sm w-100 mt-2">
              查看公告
            </a>
          </div>
        </div>
      </div>
      {{end}}
    </div>
  </div>

  <!-- 用量分析图表 -->
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-bold"><span class="text-primary me-2 material-symbols-rounded">pie_chart</span>用量分析 (今日)</h6>
          <ul class="nav nav-pills nav-pills-sm small" id="chartTabs" role="tablist" style="font-size: 0.75rem;">
            <li class="nav-item" role="presentation">
              <button class="nav-link active py-1 px-2" id="model-tab" data-bs-toggle="tab" data-bs-target="#model-pane" type="button" role="tab">模型分布</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link py-1 px-2" id="token-tab" data-bs-toggle="tab" data-bs-target="#token-pane" type="button" role="tab">Token</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link py-1 px-2" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing-pane" type="button" role="tab">费用</button>
            </li>
          </ul>
        </div>
      </div>
      <div class="card-body px-3 pb-3 pt-0">
        <div class="tab-content pt-2">
          <div class="tab-pane fade show active" id="model-pane" role="tabpanel">
            <div class="row align-items-center g-3">
              <div class="col-lg-4 text-center">
                <div style="position: relative; height: 140px; width: 100%; margin: 0 auto;">
                  <canvas id="modelPieChart"></canvas>
                </div>
              </div>
              <div class="col-lg-8">
                <div class="table-responsive" style="max-height: 150px;">
                  <table class="table table-sm table-hover align-middle border-0 mb-0" style="font-size: 0.75rem;">
                    <thead class="sticky-top bg-white" style="z-index: 1;">
                      <tr class="text-muted text-uppercase">
                        <th class="border-0 ps-0 pb-1 fw-medium">模型</th>
                        <th class="border-0 text-end pb-1 fw-medium">请求</th>
                        <th class="border-0 text-end pb-1 fw-medium">Token</th>
                        <th class="border-0 text-end pb-1 pe-1 fw-medium">USD</th>
                      </tr>
                    </thead>
                    <tbody class="border-top-0">
                      {{range .DashboardCharts.ModelStats}}
                      <tr>
                        <td class="border-0 ps-0 py-1">
                          <div class="d-flex align-items-center">
                            <span class="rounded-circle me-2" style="width: 6px; height: 6px; background-color: {{.Color}};"></span>
                            <img src="{{if .IconURL}}{{.IconURL}}{{else}}data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2a10 10 0 1 0 10 10H12V2z'/%3E%3Cpath d='M12 12L2.5 12'/%3E%3Cpath d='M12 12l9.5 0'/%3E%3Cpath d='M12 12l-6.7 6.7'/%3E%3Cpath d='M12 12l6.7 6.7'/%3E%3C/svg%3E{{end}}" 
                                 class="rlm-model-icon me-2" 
                                 style="width: 14px; height: 14px;">
                            <span class="text-dark text-truncate" style="max-width: 120px;">{{.Model}}</span>
                          </div>
                        </td>
                        <td class="border-0 text-end text-secondary py-1">{{.Requests}}</td>
                        <td class="border-0 text-end text-secondary py-1">{{.Tokens}}</td>
                        <td class="border-0 text-end fw-bold text-dark py-1 pe-1">${{.CommittedUSD}}</td>
                      </tr>
                      {{else}}
                      <tr><td colspan="4" class="text-center py-4 text-muted">无记录</td></tr>
                      {{end}}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="token-pane" role="tabpanel">
            <div style="height: 150px; width: 100%;">
              <canvas id="tokenBarChart"></canvas>
            </div>
          </div>
          <div class="tab-pane fade" id="billing-pane" role="tabpanel">
            <div style="height: 150px; width: 100%;">
              <canvas id="billingBarChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 快速指引 -->
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center mb-4">
          <span class="text-primary me-2 material-symbols-rounded">bolt</span>
          <h5 class="mb-0 fw-bold">快速开始</h5>
        </div>
        
        <div class="row g-4">
          <div class="col-12">
            <div class="bg-dark rounded-3 p-3  position-relative overflow-hidden mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-secondary text-uppercase fw-bold" style="font-size: 0.65rem;">终端配置</small>
                <div class="d-flex gap-1">
                  <div class="rounded-circle bg-danger" style="width: 8px; height: 8px;"></div>
                  <div class="rounded-circle bg-warning" style="width: 8px; height: 8px;"></div>
                  <div class="rounded-circle bg-success" style="width: 8px; height: 8px;"></div>
                </div>
              </div>
              <pre class="mb-0 text-light small overflow-auto" style="font-family: 'Fira Code', monospace; font-size: 0.75rem; white-space: pre-wrap;"><code># Linux/macOS
export OPENAI_BASE_URL="{{.BaseURL}}/v1"
export OPENAI_API_KEY="rlm_..."

# ~/.codex/config.toml
model_provider = "realms"

[model_providers.realms]
name = "Realms"
base_url = "{{.BaseURL}}/v1"
wire_api = "responses"
requires_openai_auth = true</code></pre>
            </div>
            <div class="alert alert-light border-0 bg-light small d-flex align-items-start mb-0">
              <span class="me-2 mt-1 text-primary material-symbols-rounded">info</span>
              <div>API 基础地址：<strong class="user-select-all ms-1">{{.BaseURL}}/v1</strong></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const chartsData = {{.DashboardCharts}};
    
    // 1. Model Pie Chart
    const modelCtx = document.getElementById('modelPieChart').getContext('2d');
    const modelLabels = chartsData.model_stats.map(s => s.model);
    const modelCosts = chartsData.model_stats.map(s => parseFloat(s.committed_usd));
    const modelColors = chartsData.model_stats.map(s => s.color);
    
    new Chart(modelCtx, {
      type: 'doughnut',
      data: {
        labels: modelLabels,
        datasets: [{
          data: modelCosts,
          backgroundColor: modelColors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        cutout: '70%'
      }
    });

    const timeLabels = chartsData.time_series_stats.map(s => s.label);

    // 2. Token Bar Chart
    const tokenCtx = document.getElementById('tokenBarChart').getContext('2d');
    new Chart(tokenCtx, {
      type: 'bar',
      data: {
        labels: timeLabels,
        datasets: [{
          label: 'Tokens',
          data: chartsData.time_series_stats.map(s => s.tokens),
          backgroundColor: 'rgba(16, 185, 129, 0.6)',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { display: false } },
          x: { grid: { display: false } }
        }
      }
    });

    // 3. Billing Bar Chart
    const billingCtx = document.getElementById('billingBarChart').getContext('2d');
    new Chart(billingCtx, {
      type: 'bar',
      data: {
        labels: timeLabels,
        datasets: [{
          label: '费用 (USD)',
          data: chartsData.time_series_stats.map(s => s.committed_usd),
          backgroundColor: 'rgba(99, 102, 241, 0.6)',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { display: false }, ticks: { callback: v => '$' + v } },
          x: { grid: { display: false } }
        }
      }
    });

    // Re-render on tab switch (fix Chart.js sizing in hidden tabs)
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(el => {
      el.addEventListener('shown.bs.tab', () => {
        window.dispatchEvent(new Event('resize'));
      });
    });
  })();
</script>

<style>
  .border-dashed {
    border: 1px dashed #e2e8f0 !important;
  }
  @media (min-width: 992px) {
    .border-start-lg {
      border-left: 1px solid #f1f5f9 !important;
    }
  }
  .rlm-model-icon {
    filter: grayscale(0.2);
    transition: filter 0.2s;
  }
  tr:hover .rlm-model-icon {
    filter: grayscale(0);
  }
</style>
{{end}}
