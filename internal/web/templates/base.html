{{define "base"}}
<!doctype html>
<html lang="zh-CN" class="h-100 {{if .User}}app-html{{end}}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{.Title}}</title>
    <link rel="icon" href="/assets/realms_icon.svg" type="image/svg+xml" sizes="any" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
      :root {
        --bs-font-sans-serif: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --bs-font-monospace: 'JetBrains Mono', SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        --bs-primary: #8b5cf6; /* Violet 500 */
        --bs-primary-rgb: 139, 92, 246;
        --bs-secondary: #64748b;
        --bs-body-bg: #f8fafc;
        --bs-body-color: #334155; /* Slate 700 - Unified text color */
        --bs-border-color: rgba(0, 0, 0, 0.08);
        --sidebar-width: 260px;
        --top-header-height: 64px;
      }
      body {
        font-family: var(--bs-font-sans-serif);
        color: var(--bs-body-color);
        background: linear-gradient(135deg, #ccfbf1 0%, #e0e7ff 50%, #f3e8ff 100%);
        background-attachment: fixed;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      .app-html, .app-body { height: 100%; overflow: hidden; }
      .app-shell { height: 100%; min-height: 0; min-width: 0; }
      .main-wrapper { display: flex; flex-direction: column; min-width: 0; min-height: 0; }
      code {
        font-family: var(--bs-font-monospace);
        color: #d946ef;
        background: #fae8ff;
        padding: 0.2em 0.4em;
        border-radius: 0.25em;
        font-size: 0.875em;
      }
      pre code {
        background: transparent;
        padding: 0;
        color: inherit;
      }
      
      /* Animations */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .fade-in-up {
        animation: fadeIn 0.4s ease-out forwards;
      }
      
      /* Interactive Element Transitions */
      .btn, .form-control, .form-select, .card, .sidebar-link, a {
        transition: all 0.2s ease-in-out;
      }
      
      h1, h2, h3, h4, h5, h6, .brand-font {
        font-weight: 600;
        letter-spacing: -0.025em;
        color: #1e293b; /* Slate 800 */
      }

      /* Modern Cards */
      .card { 
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 6px -1px rgba(30, 41, 59, 0.05), 0 2px 4px -1px rgba(30, 41, 59, 0.03);
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
      }
      .card-header {
        background-color: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 600;
        padding: 1rem 1.25rem;
        color: #334155; /* Slate 700 */
        font-size: 0.95rem;
      }
      .card-body { padding: 1.25rem; }
      
      /* Tables */
      .table {
        margin-bottom: 0;
        color: #334155; /* Slate 700 */
      }
      .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #64748b;
        background-color: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        padding: 0.75rem 1rem;
      }
      .table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      }
      .table tr:last-child td { border-bottom: none; }
      
      /* Inputs */
      .form-control, .form-select { 
        padding: 0.5rem 0.8rem; 
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        background-color: #fff;
        color: #334155;
        box-shadow: 0 1px 2px 0 rgba(30, 41, 59, 0.05);
        transition: all 0.2s;
      }
      .form-control:focus, .form-select:focus { 
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
      }
      
      /* Input Groups */
      .input-group-text { 
        background-color: #f8fafc; 
        border: 1px solid #e2e8f0;
        color: #64748b;
        font-size: 0.9rem;
      }
      
      /* Buttons */
      .btn { 
        padding: 0.4rem 0.8rem; 
        font-weight: 500; 
        border-radius: 0.5rem;
        transition: all 0.2s;
        border: 1px solid transparent;
        font-size: 0.9rem;
        box-shadow: 0 1px 2px 0 rgba(30, 41, 59, 0.05);
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(30, 41, 59, 0.1), 0 2px 4px -1px rgba(30, 41, 59, 0.06);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn-primary {
        background-color: var(--bs-primary);
        color: #fff;
        border-color: transparent;
      }
      .btn-primary:hover {
        background-color: #7c3aed; /* Violet 600 */
      }
      .btn-light, .btn-white, .btn-secondary {
        background-color: #fff;
        border-color: #e2e8f0;
        color: #475569;
      }
      .btn-light:hover, .btn-white:hover, .btn-secondary:hover {
        background-color: #f8fafc;
        border-color: #cbd5e1;
        color: #1e293b;
      }
      
      /* Badges & Alerts */
      .badge { 
        border-radius: 9999px;
        padding: 0.35em 0.8em;
        font-weight: 500;
        font-size: 0.75rem;
      }
      .alert {
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(30, 41, 59, 0.05);
        font-size: 0.9rem;
      }

      
      /* Sidebar */
      .sidebar { 
        width: var(--sidebar-width); 
        height: 100vh; 
        overflow: hidden; 
        background-color: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-right: 1px solid rgba(0, 0, 0, 0.05);
      }
      .sidebar-link { 
        display: flex; align-items: center; padding: 0.75rem 1.1rem; color: #475569; /* Slate 600 */
        text-decoration: none; margin-bottom: 0.4rem; font-weight: 500; 
        border-radius: 0.6rem;
        transition: all 0.2s;
        font-size: 0.9rem;
        letter-spacing: 0.01em;
      }
      .sidebar-link:hover { 
        background-color: rgba(139, 92, 246, 0.05); 
        color: var(--bs-primary);
      }
      .sidebar-link.active { 
        background-color: rgba(139, 92, 246, 0.1); 
        color: var(--bs-primary); 
      }
      
      /* Material Symbols Adaptation */
      .sidebar-link .material-symbols-rounded {
        font-size: 1.1rem;
        margin-right: 0.75rem;
        opacity: 0.8;
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      .sidebar-link:hover .material-symbols-rounded, .sidebar-link.active .material-symbols-rounded {
        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      .material-symbols-rounded {
        vertical-align: middle;
        line-height: 1;
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      .btn .material-symbols-rounded {
        font-size: 1.1rem;
      }
      
      /* Top Header */
      .top-header { 
        height: var(--top-header-height); 
        background-color: transparent; 
        padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; 
      }
      .content-scrollable { flex: 1; overflow-y: auto; padding: 2rem; }

      /* Simple Header (Login) */
      .simple-header {
        background: transparent;
        padding: 1rem 0;
        border-bottom: 1px solid #e2e8f0 !important;
      }

      /* Utility classes overrides */
      .bg-opacity-10 { opacity: 1 !important; }

      /* Mobile */
      @media (max-width: 768px) {
        .sidebar:not(.no-fixed) { 
          position: fixed; top: 0; bottom: 0; left: 0; height: 100%; 
          z-index: 1040; transform: translateX(-100%); 
        }
        .sidebar.show { 
          transform: translateX(0);
          box-shadow: 10px 0 20px rgba(30, 41, 59, 0.1); 
        }
        .content-scrollable { padding: 1rem; }
      }
    </style>
  </head>
  <body class="min-vh-100 d-flex flex-column {{if .User}}app-body{{end}}">
    
    {{if .User}}
    <!-- 应用布局 -->
    <div class="app-shell d-flex flex-grow-1">
      
	      <!-- 侧边栏 -->
	      <aside class="sidebar d-flex flex-column flex-shrink-0 p-3" id="sidebarMenu">
	        <a href="/" class="d-flex align-items-center mb-4 mb-md-0 me-md-auto text-decoration-none px-2 mt-2">
			          <div class="me-2 d-flex align-items-center justify-content-center flex-shrink-0" style="width: 36px; height: 36px;">
			            <img src="/assets/realms_icon.svg" alt="Realms" style="width: 24px; height: 24px;" />
			          </div>
	          <span class="fs-5 fw-bold text-body tracking-tight">Realms</span>
	        </a>
        <hr class="text-secondary opacity-50 my-3">
        
        <ul class="nav flex-column mb-auto" style="gap: 0.1rem;">
          <li class="nav-item">
            <a href="/dashboard" class="sidebar-link">
              <span class="material-symbols-rounded">dashboard</span> 控制台
            </a>
          </li>
          {{if not .Features.WebAnnouncementsDisabled}}
          <li>
            <a href="/announcements" class="sidebar-link">
              <span class="material-symbols-rounded">campaign</span> 公告
            </a>
          </li>
          {{end}}
          {{if not .Features.WebTokensDisabled}}
          <li>
            <a href="/tokens" class="sidebar-link">
              <span class="material-symbols-rounded">key</span> API 令牌
            </a>
          </li>
          {{end}}
          {{if not .Features.ModelsDisabled}}
          <li>
            <a href="/models" class="sidebar-link">
              <span class="material-symbols-rounded">smart_toy</span> 模型列表
            </a>
          </li>
          {{end}}
	          {{if not .Features.BillingDisabled}}
	          <li>
	            <a href="/subscription" class="sidebar-link">
	              <span class="material-symbols-rounded">credit_card</span> 订阅管理
	            </a>
	          </li>
	          <li>
	            <a href="/topup" class="sidebar-link">
	              <span class="material-symbols-rounded">account_balance_wallet</span> 余额充值
	            </a>
	          </li>
	          {{end}}
	          {{if not .Features.WebUsageDisabled}}
	          <li>
	            <a href="/usage" class="sidebar-link">
	              <span class="material-symbols-rounded">monitoring</span> 用量统计
	            </a>
	          </li>
	          {{end}}
	          {{if not .Features.TicketsDisabled}}
	          <li>
	            <a href="/tickets" class="sidebar-link">
	              <span class="material-symbols-rounded">support_agent</span> 工单
	            </a>
	          </li>
	          {{end}}
	          <li>
	            <a href="/account" class="sidebar-link">
	              <span class="material-symbols-rounded">manage_accounts</span> 账号设置
	            </a>
	          </li>
          
          {{if eq .User.Role "root"}}
          <li class="mt-4 mb-2 ms-2 text-uppercase text-muted" style="font-size: 0.75rem; letter-spacing: 0.05em; font-weight: 600;">管理</li>
          <li>
            <a href="/admin" class="sidebar-link">
              <span class="material-symbols-rounded">admin_panel_settings</span> 管理后台
            </a>
          </li>
          {{end}}
        </ul>

        <div class="mt-auto px-2 pb-2">
           <span class="text-muted small opacity-50">v1.0.0</span>
        </div>
      </aside>

      <!-- 主内容 -->
      <div class="main-wrapper w-100">
        <header class="top-header">
          <button class="btn btn-link text-body d-md-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="fs-4 material-symbols-rounded">menu</span>
          </button>
          
          <div class="ms-auto d-flex align-items-center">
             <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-body text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                  <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                     {{printf "%.1s" .User.Email}}
                  </div>
                  <span class="d-none d-sm-inline fw-medium small text-secondary">{{.User.Email}}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg mt-2 p-2 rounded-4" aria-labelledby="dropdownUser1">
                  <li><div class="dropdown-header">角色: {{.User.Role}}</div></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item rounded-2" href="/account">
                      <span class="me-2 material-symbols-rounded">manage_accounts</span>账号设置
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form method="POST" action="/logout">
                       <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
                       <button class="dropdown-item rounded-2 text-danger" type="submit">
                         <span class="me-2 material-symbols-rounded">logout</span>退出登录
                       </button>
                    </form>
                  </li>
                </ul>
             </div>
          </div>
        </header>

        <main class="content-scrollable">
          <div class="container-fluid" style="max-width: 1400px;">
            <div id="rlmAjaxAlertHost"></div>
            {{.ContentHTML}}
            
            <footer id="rlmProjectFooter" data-rlm-github="FlowerRealm/realms" class="mt-5 text-center text-muted small pb-4 opacity-50">
              Realms 中转服务 &copy; 2026<span id="rlmBuildInfoWrap" class="d-none"> · <span id="rlmBuildInfo"></span></span> · <a href="https://github.com/FlowerRealm/realms" target="_blank" rel="noopener noreferrer" class="link-secondary text-decoration-none">GitHub: FlowerRealm/realms</a>
            </footer>
          </div>
        </main>
      </div>
    </div>

    {{else}}
    <!-- 公共布局（登录/注册） -->
	    <div class="container-fluid d-flex flex-column min-vh-100 p-0">
	      <header class="simple-header d-flex flex-wrap justify-content-center py-3 mb-4">
	        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-body text-decoration-none ms-4">
			          <div class="me-2 d-flex align-items-center justify-content-center flex-shrink-0" style="width: 32px; height: 32px;">
			             <img src="/assets/realms_icon.svg" alt="Realms" style="width: 22px; height: 22px;" />
			          </div>
	          <span class="fs-4 fw-bold tracking-tight">Realms</span>
	        </a>
        <ul class="nav nav-pills me-4">
          <li class="nav-item"><a href="/login" class="nav-link text-secondary">登录</a></li>
          {{if .AllowRegister}}
          <li class="nav-item"><a href="/register" class="nav-link active rounded-pill px-4">注册</a></li>
          {{end}}
        </ul>
      </header>
      
      <main class="flex-fill d-flex flex-column justify-content-center align-items-center">
        <div class="w-100" style="max-width: 520px;">
           <div id="rlmAjaxAlertHost"></div>
           {{.ContentHTML}}
        </div>
      </main>

      <footer id="rlmProjectFooter" data-rlm-github="FlowerRealm/realms" class="py-3 my-4 text-center text-muted small opacity-50">
         &copy; 2026 Realms 服务<span id="rlmBuildInfoWrap" class="d-none"> · <span id="rlmBuildInfo"></span></span> · <a href="https://github.com/FlowerRealm/realms" target="_blank" rel="noopener noreferrer" class="link-secondary text-decoration-none">GitHub: FlowerRealm/realms</a>
      </footer>
    </div>
    {{end}}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 简单高亮当前侧边栏链接
      document.addEventListener("DOMContentLoaded", function() {
        // Fix Modal backdrop issue: Move all modals to body immediately
        document.querySelectorAll('.modal').forEach(function(modal) {
          document.body.appendChild(modal);
        });

        try {
          const url = new URL(window.location.href);
          if (url.searchParams.has("msg") || url.searchParams.has("err")) {
            url.searchParams.delete("msg");
            url.searchParams.delete("err");
            const clean = url.pathname + url.search + url.hash;
            window.history.replaceState({}, "", clean);
          }
        } catch (e) {}

        function persistAjaxAlert(kind, message) {
          try {
            const payload = {
              kind: (kind || "").toString(),
              message: (message || "").toString(),
              t: Date.now(),
            };
            sessionStorage.setItem("realms_ajax_alert", JSON.stringify(payload));
          } catch (e) {}
        }

        function showAjaxAlert(kind, message) {
          try {
            const host = document.getElementById("rlmAjaxAlertHost");
            if (!host) return;
            host.textContent = "";

            const alert = document.createElement("div");
            const cls = kind === "success" ? "success" : "danger";
            alert.className = "alert alert-" + cls + " alert-dismissible fade show  mb-4";
            alert.setAttribute("role", "alert");

            const text = document.createElement("span");
            text.textContent = (message || "").toString();
            alert.appendChild(text);

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn-close";
            btn.setAttribute("data-bs-dismiss", "alert");
            btn.setAttribute("aria-label", "Close");
            alert.appendChild(btn);

            host.appendChild(alert);
            host.scrollIntoView({ block: "start", behavior: "smooth" });
          } catch (e) {}
        }

        try {
          const raw = sessionStorage.getItem("realms_ajax_alert") || "";
          if (raw.trim() !== "") {
            sessionStorage.removeItem("realms_ajax_alert");
            const data = JSON.parse(raw);
            if (data && data.kind && data.message) {
              showAjaxAlert(data.kind, data.message);
            }
          }
        } catch (e) {}

        async function submitAjaxForm(form, submitter) {
          const csrf = (form.querySelector('input[name="_csrf"]') || {}).value || "";
          const headers = {
            "Accept": "application/json",
            "X-Realms-Ajax": "1",
          };
          if (csrf.trim() !== "") headers["X-CSRF-Token"] = csrf.trim();

          const enctype = (form.enctype || "").toLowerCase();
          const hasFile = !!form.querySelector('input[type="file"]');
          const useFormData = hasFile || enctype.indexOf("multipart/form-data") !== -1;

          let body;
          if (useFormData) {
            body = new FormData(form);
            if (submitter && submitter.name) body.append(submitter.name, submitter.value || "");
          } else {
            const fd = new FormData(form);
            const params = new URLSearchParams();
            for (const [k, v] of fd.entries()) {
              if (typeof v === "string") params.append(k, v);
            }
            if (submitter && submitter.name) params.append(submitter.name, submitter.value || "");
            headers["Content-Type"] = "application/x-www-form-urlencoded; charset=UTF-8";
            body = params;
          }

          const method = (form.method || "POST").toUpperCase();
          const url = form.action || window.location.href;

          const buttons = Array.from(form.querySelectorAll('button[type="submit"], input[type="submit"]'));
          const prev = buttons.map(b => ({ b, disabled: b.disabled }));
          prev.forEach(({ b }) => { b.disabled = true; });

          try {
            const resp = await fetch(url, {
              method,
              headers,
              body,
              credentials: "same-origin",
            });
            const ct = (resp.headers.get("Content-Type") || "").toLowerCase();
            if (ct.indexOf("application/json") === -1) {
              const txt = (await resp.text()) || "";
              showAjaxAlert("danger", txt.trim() || ("请求失败（HTTP " + resp.status + "）"));
              return;
            }
            const payload = await resp.json();
            if (payload && payload.ok) {
              const okMsg = (payload.notice || "").trim() || "操作成功";
              if ((form.getAttribute("data-ajax-reload") || "").trim() === "1") {
                persistAjaxAlert("success", okMsg);
                window.location.reload();
                return;
              }
              showAjaxAlert("success", okMsg);
              return;
            }
            showAjaxAlert("danger", (payload && payload.error ? payload.error : "").trim() || "请求失败");
          } catch (e) {
            showAjaxAlert("danger", "请求失败，请稍后重试。");
          } finally {
            prev.forEach(({ b, disabled }) => { b.disabled = disabled; });
          }
        }

        document.addEventListener("submit", function (event) {
          try {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) return;
            if ((form.getAttribute("data-ajax") || "").trim() !== "1") return;
            if (event.defaultPrevented) return;
            event.preventDefault();
            submitAjaxForm(form, event.submitter);
          } catch (e) {}
        }, false);

        const path = window.location.pathname;
        const links = document.querySelectorAll('.sidebar-link');
        links.forEach(link => {
          const href = link.getAttribute('href');
          if (path === href || (href !== '/' && path.startsWith(href))) {
            link.classList.add('active');
          }
        });

        (function installProjectFooterGuard() {
          try {
            const footerID = "rlmProjectFooter";
            const buildInfoWrapID = "rlmBuildInfoWrap";
            const buildInfoID = "rlmBuildInfo";
            const githubSlug = "FlowerRealm/realms";
            const githubURL = "https://github.com/FlowerRealm/realms";
            const restoredFlagKey = "realms_project_footer_restored";

            let buildInfo = null;
            let buildInfoReq = null;

	            function formatBuildInfo(data) {
	              try {
	                const version = (data && data.version ? data.version : "").toString().trim();
	                if (!version) return null;
	                const date = (data && data.date ? data.date : "").toString().trim();
	                const env = (data && data.env ? data.env : "").toString().trim();

	                let label = version;

	                const titleParts = [];
	                if (env) titleParts.push("env: " + env);
	                if (date && date !== "unknown") titleParts.push("build: " + date);

	                return { label: label, title: titleParts.join(" · ") };
	              } catch (e) {
	                return null;
	              }
	            }

            function fetchBuildInfoOnce() {
              if (buildInfo) return Promise.resolve(buildInfo);
              if (buildInfoReq) return buildInfoReq;
              buildInfoReq = fetch("/api/version", {
                method: "GET",
                headers: { "Accept": "application/json" },
                cache: "no-store"
              })
                .then(function (resp) {
                  try {
                    if (!resp || !resp.ok) return null;
                    return resp.json();
                  } catch (e) {
                    return null;
                  }
                })
                .then(function (data) {
                  buildInfo = formatBuildInfo(data);
                  return buildInfo;
                })
                .catch(function () { return null; })
                .finally(function () { buildInfoReq = null; });
              return buildInfoReq;
            }

            function applyBuildInfo(info) {
              try {
                const wrap = document.getElementById(buildInfoWrapID);
                const el = document.getElementById(buildInfoID);
                if (!wrap || !el || !info || !info.label) return;
                el.textContent = info.label;
                if (info.title) el.setAttribute("title", info.title);
                wrap.classList.remove("d-none");
              } catch (e) {}
            }

            function ensureBuildInfo() {
              try {
                const wrap = document.getElementById(buildInfoWrapID);
                const el = document.getElementById(buildInfoID);
                if (!wrap || !el) return;
                if (buildInfo) {
                  applyBuildInfo(buildInfo);
                  return;
                }
                fetchBuildInfoOnce().then(applyBuildInfo);
              } catch (e) {}
            }

            function footerHTML() {
              const isApp = document.documentElement.classList.contains("app-html") || document.body.classList.contains("app-body");
              if (isApp) {
                return '<footer id="' + footerID + '" data-rlm-github="' + githubSlug + '" class="mt-5 text-center text-muted small pb-4 opacity-50">Realms 中转服务 &copy; 2026<span id="rlmBuildInfoWrap" class="d-none"> · <span id="rlmBuildInfo"></span></span> · <a href="' + githubURL + '" target="_blank" rel="noopener noreferrer" class="link-secondary text-decoration-none">GitHub: ' + githubSlug + "</a></footer>";
              }
              return '<footer id="' + footerID + '" data-rlm-github="' + githubSlug + '" class="py-3 my-4 text-center text-muted small opacity-50">&copy; 2026 Realms 服务<span id="rlmBuildInfoWrap" class="d-none"> · <span id="rlmBuildInfo"></span></span> · <a href="' + githubURL + '" target="_blank" rel="noopener noreferrer" class="link-secondary text-decoration-none">GitHub: ' + githubSlug + "</a></footer>";
            }

            function findMount() {
              const appContainer = document.querySelector('main.content-scrollable > .container-fluid');
              if (appContainer) return appContainer;
              const publicContainer = document.querySelector('body > .container-fluid');
              if (publicContainer) return publicContainer;
              return document.body;
            }

            function ensureFooter() {
              if (!document.getElementById(footerID)) {
                const mount = findMount();
                if (!mount) return;
                mount.insertAdjacentHTML("beforeend", footerHTML());
                if (!sessionStorage.getItem(restoredFlagKey)) {
                  sessionStorage.setItem(restoredFlagKey, "1");
                  try { console.warn("[Realms] 检测到项目声明底栏被移除，已自动恢复。"); } catch (e) {}
                }
              }
              ensureBuildInfo();
            }

            ensureFooter();

            let scheduled = false;
            function scheduleEnsure() {
              if (scheduled) return;
              scheduled = true;
              requestAnimationFrame(function () {
                scheduled = false;
                ensureFooter();
              });
            }

            if (typeof MutationObserver !== "undefined") {
              const obs = new MutationObserver(function () {
                try {
                  if (!document.getElementById(footerID)) scheduleEnsure();
                } catch (e) {}
              });
              obs.observe(document.body, { childList: true, subtree: true });
            }

            window.addEventListener("pageshow", function () {
              try { scheduleEnsure(); } catch (e) {}
            });
          } catch (e) {}
        })();
      });
    </script>
  </body>
</html>
{{end}}
