{{define "page_account"}}
<div class="row g-4">
  <div class="col-12">
    <div class="card">
      <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center">
        <div class="d-flex align-items-center mb-3 mb-md-0">
          <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
            <span class="fs-4 material-symbols-rounded">manage_accounts</span>
          </div>
          <div>
            <h5 class="mb-1 fw-semibold">账号设置</h5>
            <p class="mb-0 text-muted small">修改账号名/邮箱/密码成功后将强制登出，需要重新登录。</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{if .Error}}
  <div class="col-12">
    <div class="alert alert-danger py-2 mb-0" role="alert">
      <span class="me-1 material-symbols-rounded">warning</span> {{.Error}}
    </div>
  </div>
  {{end}}

  <!-- 账号名 -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="fw-semibold mb-3"><span class="me-2 text-primary material-symbols-rounded">alternate_email</span>账号名</h5>
        <form method="POST" action="/account/username">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
	          <div class="mb-3">
	            <label class="form-label">账号名</label>
	            <input name="username" type="text" class="form-control" autocomplete="username" required value="{{.User.Username}}" placeholder="例如：alice" />
	            <div class="form-text">支持字母/数字及 . _ -，最多 32 位；用于登录。</div>
	          </div>
	          <button type="submit" class="btn btn-primary">保存并重新登录</button>
	        </form>
      </div>
    </div>
  </div>

  <!-- 邮箱 -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="fw-semibold mb-3"><span class="me-2 text-primary material-symbols-rounded">mail</span>邮箱</h5>
        <div class="mb-2 small text-muted">当前邮箱：<strong class="text-dark">{{.User.Email}}</strong></div>

        {{if not .EmailVerificationEnabled}}
        <div class="alert alert-warning small">
          <span class="me-1 material-symbols-rounded">gpp_maybe</span> 当前环境未启用邮箱验证码，无法修改邮箱。
        </div>
        {{end}}

        <form method="POST" action="/account/email">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
          <div class="mb-3">
            <label class="form-label">新邮箱</label>
            <input id="account-email-input" name="email" type="email" class="form-control" autocomplete="email" placeholder="name@example.com" {{if not .EmailVerificationEnabled}}disabled{{end}} />
          </div>
          <div class="mb-3">
            <label class="form-label">验证码</label>
            <div class="input-group">
              <input name="verification_code" type="text" class="form-control" autocomplete="one-time-code" inputmode="numeric" maxlength="6" placeholder="6 位验证码" {{if not .EmailVerificationEnabled}}disabled{{end}} />
              <button type="button" class="btn btn-outline-secondary" id="account-send-verification-code" {{if not .EmailVerificationEnabled}}disabled{{end}}>发送验证码</button>
            </div>
            <div class="form-text" id="account-email-hint">验证码 10 分钟内有效。</div>
          </div>
          <button type="submit" class="btn btn-primary" {{if not .EmailVerificationEnabled}}disabled{{end}}>保存并重新登录</button>
        </form>
      </div>
    </div>
  </div>

  <!-- 密码 -->
  <div class="col-lg-6">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="fw-semibold mb-3"><span class="me-2 text-primary material-symbols-rounded">key</span>修改密码</h5>
        <form method="POST" action="/account/password">
          <input type="hidden" name="_csrf" value="{{.CSRFToken}}" />
          <div class="mb-3">
            <label class="form-label">旧密码</label>
            <input name="old_password" type="password" class="form-control" autocomplete="current-password" placeholder="******" required />
          </div>
          <div class="mb-3">
            <label class="form-label">新密码</label>
            <input name="new_password" type="password" class="form-control" autocomplete="new-password" placeholder="至少 8 位字符" required />
            <div class="form-text">修改成功后会强制登出所有已登录会话。</div>
          </div>
          <button type="submit" class="btn btn-primary">保存并重新登录</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const emailInput = document.getElementById("account-email-input");
    const btn = document.getElementById("account-send-verification-code");
    const hint = document.getElementById("account-email-hint");
    if (!emailInput || !btn || !hint) return;

    btn.addEventListener("click", async function() {
      const email = (emailInput.value || "").trim().toLowerCase();
      if (!email) {
        hint.textContent = "请先填写新邮箱。";
        return;
      }
      btn.disabled = true;
      hint.textContent = "正在发送…";
      try {
        const resp = await fetch("/api/email/verification/send", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
          body: new URLSearchParams({ email })
        });
        if (!resp.ok) {
          const txt = await resp.text();
          hint.textContent = txt || "发送失败，请稍后重试。";
          return;
        }
        hint.textContent = "验证码已发送，请查收邮箱（10 分钟内有效）。";
      } catch (e) {
        hint.textContent = "发送失败，请稍后重试。";
      } finally {
        btn.disabled = false;
      }
    });
  });
</script>
{{end}}
